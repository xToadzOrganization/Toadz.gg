<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toadz.gg - Play to Earn</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Arial Black', Arial, sans-serif; color: white; padding: 20px; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.8); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { width: 100%; max-width: 1400px; background: rgba(15, 23, 42, 0.98); border-radius: 16px; border: 2px solid #334155; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; padding: 30px 20px 20px 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-bottom: 2px solid #334155; }
        .header h1 { font-size: clamp(32px, 5vw, 48px); background: linear-gradient(135deg, #38bdf8, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; }
        .header .tagline { color: #fbbf24; font-size: clamp(14px, 2vw, 16px); }
        .fomo-banner { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)); border-bottom: 2px solid #10b981; padding: 15px 20px; }
        .fomo-content { display: flex; justify-content: flex-start; align-items: center; flex-wrap: wrap; gap: 40px; }
        .fomo-stat { text-align: center; }
        .fomo-value { font-size: clamp(20px, 3vw, 28px); font-weight: bold; color: #10b981; }
        .fomo-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .price-ticker { font-size: clamp(18px, 2.5vw, 24px); color: #fbbf24; font-weight: bold; }
        .tabs { display: flex; background: rgba(30, 41, 59, 0.8); border-bottom: 2px solid #334155; overflow-x: auto; }
        .tab { flex: 1; min-width: 120px; padding: 15px 10px; text-align: center; cursor: pointer; border: none; background: transparent; color: #94a3b8; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: rgba(59, 130, 246, 0.1); color: #fff; }
        .tab.active { color: #38bdf8; border-bottom: 3px solid #38bdf8; background: rgba(59, 130, 246, 0.2); }
        .tab.marketplace-tab { background: linear-gradient(90deg, rgba(236, 72, 153, 0.6), rgba(168, 85, 247, 0.6), rgba(59, 130, 246, 0.6), rgba(236, 72, 153, 0.6)); background-size: 200% 200%; animation: rainbow 4s linear infinite; position: relative; overflow: hidden; }
        .tab.marketplace-tab::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        .tab-content { display: none; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .wallet-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .wallet-btn:hover { transform: translateY(-2px); }
        .wallet-connected { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .leaderboard { background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .leaderboard-entry { display: flex; justify-content: space-between; padding: 10px; margin: 5px 0; background: rgba(15, 23, 42, 0.5); border-radius: 8px; }
        .leaderboard-entry.top { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 1px solid #fbbf24; }
    </style>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ğŸ® TOADZ ARENA</h1><div class="tagline">ğŸ’° Play â€¢ Earn â€¢ Dominate</div></div>
        <div id="walletBanner" class="fomo-banner" style="display: none;">
            <div class="fomo-content">
                <div class="fomo-stat"><div style="color: #3b82f6; font-size: 16px; font-weight: bold;"><span id="walletAddrBanner"></span></div><div class="fomo-label">Wallet</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #fbbf24;"><span id="walletBalBanner">0</span></div><div class="fomo-label">Your POND</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #22c55e;"><span id="walletSGBBanner">0</span></div><div class="fomo-label">Your SGB</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #8b5cf6;"><span id="marketcapBanner">$0</span></div><div class="fomo-label">POND MCAP</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #10b981;"><span id="gameCredits">0</span></div><div class="fomo-label">Game Credits</div></div>
            </div>
        </div>
        <div id="lpBanner" class="fomo-banner">
            <div class="fomo-content">
                <div style="font-size: 18px; font-weight: bold; color: #10b981;">POND LP STATS</div>
                <div class="fomo-stat"><div class="price-ticker">$<span id="pondPriceUSD">0.000084</span></div><div class="fomo-label">POND Price</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #8b5cf6;">$<span id="marketcapLP">0</span></div><div class="fomo-label">Market Cap</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #22c55e;"><span id="priceChangePercent">+0.00</span>%</div><div class="fomo-label">24h Change</div></div>
                <div class="fomo-stat"><div class="fomo-value">$<span id="liquidityValue">0</span></div><div class="fomo-label">Market Cap</div></div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('play')">ğŸ® PLAY</button>
            <button class="tab" onclick="switchTab('buy')">ğŸ’° BUY POND</button>
            <button class="tab" onclick="switchTab('pool')">ğŸ’§ POOL</button>
            <button class="tab" onclick="switchTab('leaderboard')">ğŸ† LEADERBOARD</button>
            <button class="tab marketplace-tab" onclick="switchTab('marketplace')">âœ¨ MARKETPLACE</button>
        </div>
        <div id="playTab" class="tab-content active">
            <div style="text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="walletBtn" class="wallet-btn" onclick="connectWallet()">ğŸ”— Connect Wallet</button>
                <button id="networkBtn" class="wallet-btn" onclick="addSongbirdNetwork()" style="background: linear-gradient(135deg, #f97316, #ea580c); display: none;">ğŸŒ Add Songbird</button>
                <button id="importTokenBtn" class="wallet-btn" onclick="importBAKEToken()" style="background: linear-gradient(135deg, #10b981, #059669); display: none;">â• Add $POND</button>
            </div>
            <div id="gameSetup" style="display: none;">
                <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #10b981; margin-bottom: 15px;">ğŸŸï¸ GAME CREDITS: <span id="creditsDisplay">0</span></h3>
                    <input type="text" id="username" placeholder="ENTER USERNAME" maxlength="8" style="width: 300px; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">
                    <div style="margin-bottom: 15px;"><label style="color: #94a3b8; font-size: 14px;">Buy Credits (1 SGB each):</label>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap;">
                            <button class="wallet-btn" onclick="buyCredits(1)" style="background: linear-gradient(135deg, #10b981, #059669); padding: 10px 20px;">Buy 1</button>
                            <button class="wallet-btn" onclick="buyCredits(5)" style="background: linear-gradient(135deg, #10b981, #059669); padding: 10px 20px;">Buy 5</button>
                            <button class="wallet-btn" onclick="buyCredits(10)" style="background: linear-gradient(135deg, #10b981, #059669); padding: 10px 20px;">Buy 10</button>
                            <button class="wallet-btn" onclick="buyCredits(25)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 10px 20px;">Buy 25</button>
                            <button class="wallet-btn" onclick="buyCredits(100)" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 10px 20px; color: black;">Buy 100</button>
                        </div>
                    </div>
                    <button id="payEntryBtn" class="wallet-btn" onclick="selectVehicle()" style="background: linear-gradient(135deg, #10b981, #059669); display: block; margin: 0 auto;">ğŸ® USE CREDIT & CHOOSE VEHICLE</button>
                </div>
            </div>
            <div id="vehicleSelect" style="display: none;">
                <h3 style="text-align: center; color: #38bdf8; margin-bottom: 15px;">CHOOSE YOUR VEHICLE</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div onclick="selectVehicleType('ğŸšœ', 230, 40)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;"><div style="font-size: 48px;">ğŸšœ</div><div style="font-weight: bold; margin: 10px 0;">Tank</div><div style="font-size: 11px; color: #94a3b8;">HP: 230 â€¢ DMG: 40</div></div>
                    <div onclick="selectVehicleType('ğŸï¸', 92, 20)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;"><div style="font-size: 48px;">ğŸï¸</div><div style="font-weight: bold; margin: 10px 0;">Sports Car</div><div style="font-size: 11px; color: #94a3b8;">HP: 92 â€¢ DMG: 20</div></div>
                    <div onclick="selectVehicleType('ğŸšš', 161, 30)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;"><div style="font-size: 48px;">ğŸšš</div><div style="font-weight: bold; margin: 10px 0;">Truck</div><div style="font-size: 11px; color: #94a3b8;">HP: 161 â€¢ DMG: 30</div></div>
                </div>
            </div>
            <div id="marketplaceUpsell" style="display: none;">
                <h3 style="text-align: center; color: #ec4899; margin-bottom: 20px;">âš¡ NEED ANYTHING FROM THE MARKETPLACE?</h3>
                <div id="upsellItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="wallet-btn" onclick="switchTab('marketplace')" style="background: linear-gradient(135deg, #ec4899, #d946ef);">ğŸ›’ Browse Marketplace</button>
                    <button class="wallet-btn" onclick="proceedToGame()" style="background: linear-gradient(135deg, #10b981, #059669);">â–¶ï¸ Continue to Game</button>
                </div>
            </div>
            <div id="gameArea" style="display: none;">
                <div id="gameContainer" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0a0e1a; z-index: 9999;">
                    <canvas id="gameCanvas" style="width: 100%; height: 100%;"></canvas>
                    <div id="explosionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; background: radial-gradient(circle, rgba(255,100,0,0.6) 0%, rgba(255,0,0,0.3) 50%, transparent 100%);"></div>
                    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); padding: 20px 40px; border-radius: 16px; border: 3px solid #fbbf24;"><div style="font-size: 14px; color: #78350f; text-align: center; margin-bottom: 5px;">ğŸ’° PRIZE POT</div><div style="font-size: 36px; font-weight: bold; color: #ffffff; text-align: center;"><span id="currentPot">10000</span> POND</div></div>
                    <div id="killNotif" style="position: absolute; top: 120px; left: 50%; transform: translateX(-50%); display: none; background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95)); padding: 15px 30px; border-radius: 12px; border: 2px solid #22c55e; font-size: 24px; font-weight: bold;"></div>
                    <div style="position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155;">
                        <div style="font-size: 18px; margin: 5px 0; color: #ef4444;">â¤ï¸ <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #10b981;">ğŸ’š Lives: <span id="livesCount">5</span>/5</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">ğŸ° <span id="playerBAKE">0</span> POND</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #22c55e;">ğŸ† <span id="killCount">0</span> kills</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #ec4899;">ğŸ”¥ <span id="streakCount">0</span>x streak</div>
                        <div id="tacticalsDisplay" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155;"></div>
                    </div>
                    <div style="position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155; text-align: right;">
                        <div style="font-size: 18px; margin: 5px 0; color: #38bdf8;">ğŸ® <span id="playerName">Player</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #a855f7;">ğŸ‘¥ <span id="aliveCount">8</span> alive</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">â±ï¸ <span id="gameTime">0:00</span></div>
                        <div style="font-size: 16px; margin: 5px 0; color: #10b981;">ğŸŸï¸ Credits: <span id="inGameCredits">0</span></div>
                    </div>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.98), rgba(219, 39, 119, 0.98)); padding: 30px 40px; border-top: 4px solid #ec4899;">
                        <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 25px;">
                            <div style="font-size: 64px;">ğŸ’â€â™€ï¸</div>
                            <div style="flex: 1;"><div style="font-size: 18px; font-weight: bold; color: #fce7f3; margin-bottom: 8px;">SARAH</div><div id="sarahText" style="font-size: 32px; color: #ffffff; line-height: 1.4; font-weight: 600;">Good luck out there! ğŸ’•</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="buyTab" class="tab-content">
            <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">ğŸ’° Bulk POND Packages</h2>
            <div id="buyWalletWarning" style="background: rgba(239,68,68,0.2); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;"><div style="color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px;">âš ï¸ CONNECT WALLET TO PURCHASE</div><button class="wallet-btn" onclick="connectWallet(); switchTab('play');">ğŸ”— Connect Wallet</button></div>
            <div id="bulkPurchaseSection" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #334155; padding: 25px; border-radius: 12px; text-align: center;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">STARTER</div><div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$500</div><div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">2% Discount</div><div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You pay</div><div style="font-size: 20px; font-weight: bold; color: white;" id="pkg500Sgb">~250,000 SGB</div></div><div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You receive (+2%)</div><div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg500Bake">Loading...</div></div><button onclick="buyPackage(500, 2)" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $500 PACKAGE</button></div>
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #fbbf24; padding: 25px; border-radius: 12px; text-align: center; position: relative;"><div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: black; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">POPULAR</div><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">BUILDER</div><div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$1,000</div><div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">5% Discount</div><div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You pay</div><div style="font-size: 20px; font-weight: bold; color: white;" id="pkg1000Sgb">~500,000 SGB</div></div><div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You receive (+5%)</div><div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg1000Bake">Loading...</div></div><button onclick="buyPackage(1000, 5)" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; padding: 12px 30px; border-radius: 8px; color: black; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $1,000 PACKAGE</button></div>
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #8b5cf6; padding: 25px; border-radius: 12px; text-align: center; position: relative;"><div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">WHALE</div><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">BELIEVER</div><div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$5,000</div><div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">10% Discount</div><div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You pay</div><div style="font-size: 20px; font-weight: bold; color: white;" id="pkg5000Sgb">~2,500,000 SGB</div></div><div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">You receive (+10%)</div><div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg5000Bake">Loading...</div></div><button onclick="buyPackage(5000, 10)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $5,000 PACKAGE</button></div>
                </div>
                <div id="vestStatus" style="background: rgba(139, 92, 246, 0.1); border: 2px solid #8b5cf6; padding: 20px; border-radius: 12px; display: none;"><h3 style="color: #8b5cf6; margin-bottom: 15px; text-align: center;">ğŸ”’ Your Vesting POND</h3><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">Total Purchased</div><div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="vestTotal">0</div></div><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">Already Claimed</div><div style="font-size: 20px; font-weight: bold; color: #64748b;" id="vestClaimed">0</div></div></div><div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">Claimable Now</div><div style="font-size: 28px; font-weight: bold; color: #10b981;" id="vestClaimable">0 POND</div><div style="font-size: 11px; color: #f59e0b;" id="vestTimeRemaining">60 days remaining</div></div><button onclick="claimBulkBAKE()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">ğŸ CLAIM VESTED POND</button></div>
            </div>
        </div>
        <div id="poolTab" class="tab-content">
            <h2 style="color: #10b981; margin-bottom: 20px; text-align: center;">ğŸ’§ POND/SGB Liquidity Pool</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"><div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">SGB Reserves</div><div style="font-size: 36px; font-weight: bold; color: #10b981;" id="poolWsgb">0</div></div><div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">POND Reserves</div><div style="font-size: 36px; font-weight: bold; color: #fbbf24;" id="poolBake">0</div></div></div>
            <div style="background: rgba(251, 191, 36, 0.1); padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">POND Price</div><div style="font-size: 32px; font-weight: bold; color: #fbbf24; margin-bottom: 8px;"><span id="pondPrice">0.000000</span> SGB</div><div style="font-size: 20px; font-weight: bold; color: #22c55e; margin-bottom: 12px;">Market Cap: $<span id="marketCap">0</span></div><div style="font-size: 16px; font-weight: bold;" id="allTimeChange">All-Time: +0.00%</div></div>
            <div id="lpDashboard" style="background: rgba(139, 92, 246, 0.1); border: 2px solid #8b5cf6; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;"><h3 style="color: #8b5cf6; margin-bottom: 15px; text-align: center;">ğŸ“Š Your LP Position</h3><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">Your Pool Share</div><div style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="lpPoolPercent">0%</div></div><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">Your Multiplier</div><div style="font-size: 24px; font-weight: bold; color: #fbbf24;" id="lpMultiplier">1x</div></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">SGB Deposited</div><div style="font-size: 18px; font-weight: bold; color: #10b981;" id="lpSgbDeposited">0</div></div><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #94a3b8;">POND Deposited</div><div style="font-size: 18px; font-weight: bold; color: #fbbf24;" id="lpBakeDeposited">0</div></div></div><div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">Lock Status</div><div style="font-size: 16px; font-weight: bold; color: #f59e0b;" id="lpLockStatus">-</div></div><div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;"><div style="font-size: 14px; color: #10b981; font-weight: bold; margin-bottom: 10px; text-align: center;">ğŸ Your Rewards</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;"><div style="text-align: center;"><div style="font-size: 11px; color: #94a3b8;">POND (Claim Now)</div><div style="font-size: 18px; font-weight: bold; color: #fbbf24;" id="lpPendingBake">0</div><button onclick="claimPondRewards()" style="background: #fbbf24; color: black; border: none; padding: 5px 15px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 5px;">Claim POND</button></div><div style="text-align: center;"><div style="font-size: 11px; color: #94a3b8;">SGB (Claimable)</div><div style="font-size: 18px; font-weight: bold; color: #10b981;" id="lpClaimableSgb">0</div><button onclick="claimSgbRewards()" style="background: #10b981; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 5px;">Claim SGB</button></div></div><div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;"><div style="font-size: 11px; color: #94a3b8;">SGB Pending (Next Claim)</div><div style="font-size: 16px; font-weight: bold; color: #64748b;" id="lpPendingSgb">0</div><div style="font-size: 11px; color: #f59e0b;" id="lpSgbCountdown">-</div></div></div><div style="background: rgba(59, 130, 246, 0.2); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;"><div style="font-size: 12px; color: #3b82f6;">Add <span id="lpSgbNeeded" style="font-weight: bold;">0</span> SGB to reach <span id="lpNextPercent" style="font-weight: bold;">1%</span> pool share</div></div><div id="lpUnlockSection" style="display: none; text-align: center;"><div style="font-size: 14px; color: #10b981; margin-bottom: 10px;">ğŸ”“ Lock expired!</div><button onclick="relockPosition(0)" style="background: #334155; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 30d</button><button onclick="relockPosition(1)" style="background: #334155; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 90d</button><button onclick="relockPosition(2)" style="background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 180d</button><button onclick="removeLiquidity()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Withdraw</button></div></div>
            <div id="addLiquiditySection" style="background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px;"><h3 style="color: #10b981; margin-bottom: 15px; text-align: center;">ğŸ’§ Add Liquidity</h3><div style="background: rgba(139, 92, 246, 0.2); padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;"><div style="font-size: 12px; color: #94a3b8;">Your NFT Bonus</div><div style="font-size: 20px; font-weight: bold; color: #8b5cf6;" id="userNftBonus">+0.000x</div></div><div style="margin-bottom: 15px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">Lock Period</div><select id="lockTierSelect" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold;"><option value="0">30 Days (1x)</option><option value="1">90 Days (1.5x)</option><option value="2" selected>180 Days (2.5x)</option></select></div><div style="margin-bottom: 15px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">SGB Amount</div><input type="number" id="wsgbInput" placeholder="0.0" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;"></div><div style="margin-bottom: 15px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">POND Amount (auto-calculated at 0.5x ratio)</div><input type="number" id="bakeRequired" placeholder="0.0" readonly style="width: 100%; background: #0f172a; border: 2px solid #334155; color: #fbbf24; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center; cursor: not-allowed;"></div><div id="firstDepositorToggle" style="display: none; margin-bottom: 15px; text-align: center;"><label style="color: #f59e0b; font-size: 14px; cursor: pointer;"><input type="checkbox" id="isFirstDepositor" onchange="toggleFirstDepositor()" style="margin-right: 8px;">I am first depositor (set custom ratio)</label></div><button onclick="addLiquidity()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">ğŸ’§ ADD LIQUIDITY</button></div>
            <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid #3b82f6; padding: 20px; border-radius: 12px;"><h3 style="color: #3b82f6; margin-bottom: 15px; text-align: center;">ğŸ”„ Swap Tokens</h3><div style="margin-bottom: 15px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">From</div><input type="number" id="swapFromAmount" placeholder="0.0" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;"><select id="swapFromToken" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center; margin-top: 5px;"><option value="SGB">SGB</option><option value="POND">POND</option></select></div><div style="text-align: center; margin: 10px 0; font-size: 24px;">â¬‡ï¸</div><div style="margin-bottom: 15px;"><div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">To (estimated)</div><input type="number" id="swapToAmount" placeholder="0.0" readonly style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;"></div><button onclick="executeSwap()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">ğŸ”„ SWAP</button></div>
        </div>
        <div id="leaderboardTab" class="tab-content"><h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">ğŸ† TOP PLAYERS</h2><div class="leaderboard" id="leaderboardList"></div><h2 style="color: #3b82f6; margin: 40px 0 20px 0; text-align: center;">ğŸ“Š YOUR HISTORY</h2><div style="background: rgba(15, 23, 42, 0.8); border: 2px solid #334155; border-radius: 12px; padding: 20px; overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; color: white;"><thead><tr style="border-bottom: 2px solid #334155;"><th style="padding: 12px; text-align: left; color: #94a3b8;">Date</th><th style="padding: 12px; text-align: left; color: #94a3b8;">Action</th><th style="padding: 12px; text-align: right; color: #94a3b8;">Amount</th><th style="padding: 12px; text-align: center; color: #94a3b8;">Type</th></tr></thead><tbody id="historyTableBody"><tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">No history yet.</td></tr></tbody></table></div></div>
        <div id="marketplaceTab" class="tab-content"><h2 style="color: #ec4899; margin-bottom: 20px; text-align: center;">âœ¨ POND Marketplace</h2><div id="marketplaceWalletWarning" style="background: rgba(239,68,68,0.2); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;"><div style="color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px;">âš ï¸ CONNECT WALLET TO SHOP</div><button class="wallet-btn" onclick="connectWallet();">ğŸ”— Connect Wallet</button></div><div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;"><div onclick="showCategory('tacticals')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">âš”ï¸ Tacticals</div><div onclick="showCategory('skins')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">ğŸ¨ Skins</div><div onclick="showCategory('trails')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">âœ¨ Trails</div><div onclick="showCategory('effects')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">ğŸ’¥ Death FX</div></div><div id="marketplaceItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div></div>
    </div>
    <script>
        const SONGBIRD_RPC = 'https://songbird-api.flare.network/ext/C/rpc';
        const CONTRACTS = { 
            POND_TOKEN: '0x39fec3F97668e393862Dbb3C442f3Dd3d5016D69', 
            GAME_CONTRACT: '0xaB27737d60ce0FaC521f82e3d2703d0D1c279E49', 
            POOL_CONTRACT: '0x4A1975d708F713DBD3fFF3C7B6afB289a23A49Ca', 
            WSGB: '0x02f0826ef6aD107Cfc861152B32B52fD11BaB9ED', 
            STOADZ_NFT: '0x35afb6Ba51839dEDD33140A3b704b39933D1e642', 
            SONGBIRD_CITY_NFT: '0x360f8b7d9530f55ab8e52394e6527935635f51e7', 
            LUXURY_LOFTS_NFT: '0x91aa85a172dd3e7eea4ad1a4b33e90cbf3b99ed8' 
        };
        const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function approve(address spender, uint256 amount) returns (bool)"];
        const ERC721_ABI = ["function balanceOf(address owner) view returns (uint256)"];
        const POOL_ABI = ["function addLiquidity(uint256 pondAmount, uint256 lockTier) payable returns (uint256)","function addMore(uint256 pondAmount) payable","function removeLiquidity() external","function claimPondRewards() external","function claimSgbRewards() external","function reserveSGB() external view returns (uint256)","function reservePOND() external view returns (uint256)","function getUserInfo(address user) external view returns (uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256)","function getPondOut(uint256 sgbIn) view returns (uint256)","function getSgbOut(uint256 pondIn) view returns (uint256)","function swapSgbForPond() payable returns (uint256)","function swapPondForSgb(uint256 amt) returns (uint256)","function getStakedNFTBonus(address user) view returns (uint256)","function getWalletNFTBonus(address user) view returns (uint256)","function lpClaimableSgb(address user) view returns (uint256)"];
        
        let wallet = null, balance = 100000, sgbBalance = 1000, gameCredits = parseInt(localStorage.getItem('gameCredits') || '0');
        let userHistory = JSON.parse(localStorage.getItem('bakeHistory') || '[]'), leaderboard = JSON.parse(localStorage.getItem('bakeLeaderboard') || '[]');
        let username = '', canvas, ctx, gameLoop, player, enemies = [], bullets = [], walls = [], pickups = [], activeTurrets = [], explosionEffects = [];
        let keys = {}, mouse = { x: 0, y: 0, clicked: false }, pot = 10000, kills = 0, streak = 0, aliveCount = 8;
        let gameTime = 0, gameStartTime = 0, lives = 5, totalKills = 0, provider, signer, pondContract, poolContract, selectedVehicle = null, currentModal = null, screenShakeIntensity = 0, userNftCount = 0;
        let userIsLP = false;
        let sgbPriceUSD = 0.0027;
        
        const ENEMY_NAMES = ['SHADOW', 'VIPER', 'GHOST', 'BLAZE', 'PHOENIX', 'STRIKER', 'REAPER', 'TITAN', 'HAVOC', 'FURY', 'STORM', 'RAZOR', 'BOLT', 'HUNTER', 'ROGUE'];
        const ENEMY_COLORS = ['#ef4444', '#f97316', '#fbbf24', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
        const ENEMY_SHAPES = ['rectangle', 'square', 'diamond', 'hexagon', 'triangle', 'oval', 'pentagon', 'trapezoid'];
        
        const MARKETPLACE = {
            skins: [{id:'gold',name:'Golden Warrior',rarity:'legendary',price:50000,icon:'ğŸ†',color:'#fbbf24',desc:'Shine like a champion'},{id:'chrome',name:'Chrome Crusader',rarity:'epic',price:35000,icon:'ğŸ’',color:'#e5e7eb',desc:'Reflective perfection'},{id:'neon',name:'Neon Racer',rarity:'epic',price:40000,icon:'ğŸŒŸ',color:'#a855f7',desc:'Glow in the dark'},{id:'camo',name:'Digital Camo',rarity:'rare',price:25000,icon:'ğŸ¯',color:'#65a30d',desc:'Tactical stealth'},{id:'fire',name:'Flame Decal',rarity:'rare',price:30000,icon:'ğŸ”¥',color:'#f97316',desc:'Trail of fire'},{id:'ice',name:'Ice King',rarity:'rare',price:30000,icon:'â„ï¸',color:'#06b6d4',desc:'Cool under pressure'}],
            trails: [{id:'rainbow',name:'Rainbow Trail',rarity:'epic',price:40000,icon:'ğŸŒˆ',desc:'Taste the rainbow'},{id:'lightning',name:'Lightning Bolt',rarity:'epic',price:35000,icon:'âš¡',desc:'Electric shock'},{id:'fire',name:'Flame Trail',rarity:'rare',price:25000,icon:'ğŸ”¥',desc:'Hot shots'},{id:'toxic',name:'Toxic Waste',rarity:'rare',price:25000,icon:'â˜¢ï¸',desc:'Radioactive'},{id:'hearts',name:'Love Hearts',rarity:'rare',price:30000,icon:'ğŸ’•',desc:'Spread the love'},{id:'stars',name:'Star Shower',rarity:'rare',price:30000,icon:'â­',desc:'Wish upon a bullet'}],
            effects: [{id:'confetti',name:'Confetti Burst',rarity:'rare',price:30000,icon:'ğŸ‰',desc:'Party on death'},{id:'nuclear',name:'Nuclear Meltdown',rarity:'epic',price:50000,icon:'â˜¢ï¸',desc:'Atomic explosion'},{id:'fireworks',name:'Fireworks Show',rarity:'epic',price:40000,icon:'ğŸ†',desc:'Grand finale'},{id:'blackhole',name:'Black Hole',rarity:'legendary',price:60000,icon:'ğŸŒ€',desc:'Suck everything in'},{id:'angel',name:'Ascension',rarity:'rare',price:35000,icon:'ğŸ‘¼',desc:'Rise to heaven'},{id:'cartoon',name:'Cartoon Poof',rarity:'rare',price:25000,icon:'ğŸ’­',desc:'Looney Tunes style'}],
            tacticals: [{id:'orbital',name:'Orbital Laser',rarity:'legendary',price:150000,icon:'ğŸ›¸',desc:'Space laser (180s cd)'},{id:'timeslow',name:'Time Distortion',rarity:'legendary',price:120000,icon:'â±ï¸',desc:'Bullet time 8s (150s cd)'},{id:'turret',name:'Auto Turret',rarity:'legendary',price:80000,icon:'ğŸ”«',desc:'Deploy turret (60s cd)'},{id:'airstrike',name:'Airstrike',rarity:'legendary',price:100000,icon:'âœˆï¸',desc:'Call explosions (120s cd)'},{id:'shield',name:'Shield Dome',rarity:'epic',price:70000,icon:'ğŸ›¡ï¸',desc:'Block bullets 10s (90s cd)'},{id:'emp',name:'EMP Mine',rarity:'epic',price:60000,icon:'ğŸ’£',desc:'Slow enemies (45s cd)'},{id:'heal',name:'Heal Station',rarity:'rare',price:50000,icon:'â¤ï¸',desc:'Restore HP (60s cd)'},{id:'decoy',name:'Decoy Vehicle',rarity:'rare',price:40000,icon:'ğŸ‘»',desc:'Fake target (30s cd)'}]
        };
        let inventory = JSON.parse(localStorage.getItem('bakeInventory') || '{"skins":[],"trails":[],"effects":[],"tacticals":[]}');
        
        const sarahMessages = { start:"Good luck out there! ğŸ’•", kill1:"Nice shot... really nice ğŸ¯", kill3:"You're making me feel things ğŸ”¥", kill5:"God, watching you dominate... ğŸ˜³ğŸ’¦", kill8:"My husband never handles his weapon like that ğŸ†", kill10:"I need to see you after this match. Alone. ğŸ’‹", kill15:"Fuck it, I'm leaving him ğŸ’âŒ", kill20:"Take me right here ğŸ¥µğŸ”", lowHP:"Baby no! Stay alive! â¤ï¸â€ğŸ”¥", lastStanding:"Finish them so you can finish me ğŸ’¦", victory:"That was SO hot. My place? ğŸ ğŸ”¥", pickup_health:"Mmm, getting harder? ğŸ’š", pickup_damage:"Bigger is better ğŸ’¥ğŸ˜", pickup_speed:"Faster baby! âš¡ğŸ’¨", pickup_shield:"Protect yourself ğŸ›¡ï¸ğŸ’•" };
        
        async function fetchSGBPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=songbird&vs_currencies=usd');
                const data = await response.json();
                if (data.songbird && data.songbird.usd) {
                    sgbPriceUSD = data.songbird.usd;
                }
            } catch (err) {
                console.error('Failed to fetch SGB price:', err);
            }
        }
        
        function showSarahMessage(type) { const el = document.getElementById('sarahText'); if (sarahMessages[type]) el.textContent = sarahMessages[type]; }
        function addHistoryEntry(action, amount, type) { userHistory.unshift({ date: new Date().toISOString(), action, amount, type }); if (userHistory.length > 100) userHistory = userHistory.slice(0, 100); localStorage.setItem('bakeHistory', JSON.stringify(userHistory)); updateHistoryTable(); }
        function updateHistoryTable() { const tbody = document.getElementById('historyTableBody'); if (!userHistory.length) { tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">No history yet.</td></tr>'; return; } tbody.innerHTML = userHistory.slice(0,20).map(e => { const d = new Date(e.date); const colors = { earn: '#10b981', spend: '#fbbf24', burn: '#ef4444', lp: '#3b82f6' }; return '<tr style="border-bottom: 1px solid #334155;"><td style="padding: 12px; color: #94a3b8; font-size: 13px;">'+d.toLocaleDateString()+'</td><td style="padding: 12px; color: white;">'+e.action+'</td><td style="padding: 12px; text-align: right; color: white; font-weight: bold;">'+e.amount.toLocaleString()+' POND</td><td style="padding: 12px; text-align: center; color: '+(colors[e.type] || '#94a3b8')+';">'+e.type.toUpperCase()+'</td></tr>'; }).join(''); }
        function updateLeaderboardDisplay() { const list = document.getElementById('leaderboardList'); if (!leaderboard.length) { list.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No games played yet.</div>'; return; } list.innerHTML = leaderboard.slice(0, 10).map((e, i) => { const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '#'+(i + 1); return '<div class="leaderboard-entry '+(i < 3 ? 'top' : '')+'"><span style="font-size: 24px; min-width: 50px;">'+medal+'</span><span style="flex: 1; font-weight: bold;">'+e.name+'</span><span style="color: #fbbf24; font-weight: bold;">'+e.bake.toLocaleString()+' POND</span><span style="color: #94a3b8; font-size: 13px; margin-left: 15px;">'+e.kills+' kills</span></div>'; }).join(''); }
        function closeCurrentModal() { if (currentModal && currentModal.parentNode) { document.body.removeChild(currentModal); currentModal = null; } }
        function showCustomModal(title, message, buttons) { if (!buttons) buttons = [{text: 'OK'}]; return new Promise(function(resolve) { closeCurrentModal(); const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10001;'; let btnHtml = ''; buttons.forEach(function(b, i) { btnHtml += '<button id="modalBtn'+i+'" style="background:'+(i===0?'linear-gradient(135deg,#3b82f6,#2563eb)':'rgba(71,85,105,0.5)')+';border:none;padding:15px 40px;border-radius:12px;color:white;font-size:18px;font-weight:bold;cursor:pointer;margin:5px;">'+b.text+'</button>'; }); modal.innerHTML = '<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border:3px solid #3b82f6;border-radius:20px;padding:40px;text-align:center;max-width:500px;"><div style="font-size:36px;font-weight:bold;color:#3b82f6;margin-bottom:20px;">'+title+'</div><div style="color:#e2e8f0;font-size:18px;margin-bottom:30px;line-height:1.6;white-space:pre-line;">'+message+'</div><div>'+btnHtml+'</div></div>'; document.body.appendChild(modal); currentModal = modal; buttons.forEach(function(b, i) { document.getElementById('modalBtn'+i).onclick = function() { closeCurrentModal(); if (b.onClick) b.onClick(); resolve(i === 0); }; }); }); }
        function updateCreditsDisplay() { ['creditsDisplay', 'gameCredits', 'inGameCredits'].forEach(function(id) { const el = document.getElementById(id); if (el) el.textContent = gameCredits; }); localStorage.setItem('gameCredits', gameCredits.toString()); }
        
        async function buyCredits(amount) { if (!wallet) { await showCustomModal('âš ï¸ Wallet Required', 'Connect wallet first'); return; } if (sgbBalance < amount) { await showCustomModal('âš ï¸ Insufficient SGB', 'You need '+amount+' SGB'); return; } try { const confirmed = await showCustomModal('ğŸŸï¸ Buy '+amount+' Credits', 'Pay '+amount+' SGB?', [{text: 'Buy'}, {text: 'Cancel'}]); if (!confirmed) return; const sgbWei = ethers.utils.parseEther(amount.toString()); showCustomModal('â³ Opening MetaMask', 'Check MetaMask...'); const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: sgbWei }); showCustomModal('â³ Processing', 'Waiting...'); await tx.wait(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); gameCredits += amount; updateCreditsDisplay(); await showCustomModal('âœ… Credits Purchased', 'You have '+gameCredits+' credits!'); } catch (error) { await showCustomModal('âŒ Failed', error.message); } }
        
        async function buyCreditsInGame(amount) { if (!wallet || sgbBalance < amount) return false; try { const sgbWei = ethers.utils.parseEther(amount.toString()); showCustomModal('â³ Buying credits...', 'Check MetaMask'); const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: sgbWei }); await tx.wait(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); gameCredits += amount; updateCreditsDisplay(); return true; } catch (e) { return false; } }
        
        async function addSongbirdNetwork() { try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x13', chainName: 'Songbird', nativeCurrency: { name: 'Songbird', symbol: 'SGB', decimals: 18 }, rpcUrls: [SONGBIRD_RPC], blockExplorerUrls: ['https://songbird-explorer.flare.network/'] }] }); showCustomModal('âœ… Success', 'Songbird added!'); } catch (e) { showCustomModal('âŒ Error', e.message); } }
        
        async function connectWallet() { const walletBtn = document.getElementById('walletBtn'); try { walletBtn.disabled = true; walletBtn.innerHTML = 'â³ Connecting...'; provider = new ethers.providers.Web3Provider(window.ethereum); await provider.send("eth_requestAccounts", []); signer = provider.getSigner(); pondContract = new ethers.Contract(CONTRACTS.POND_TOKEN, ERC20_ABI, signer); poolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, POOL_ABI, signer); wallet = await signer.getAddress(); try { userIsLP = await poolContract.isLP(wallet); } catch(e) { userIsLP = false; } const pondBalance = await pondContract.balanceOf(wallet); const sgbBalanceWei = await provider.getBalance(wallet); balance = parseFloat(ethers.utils.formatEther(pondBalance)); sgbBalance = parseFloat(ethers.utils.formatEther(sgbBalanceWei)); walletBtn.textContent = 'âœ“ Connected'; walletBtn.className = 'wallet-btn wallet-connected'; walletBtn.onclick = null; document.getElementById('importTokenBtn').style.display = 'inline-block'; document.getElementById('networkBtn').style.display = 'inline-block'; document.getElementById('lpBanner').style.display = 'none'; document.getElementById('walletBanner').style.display = 'block'; document.getElementById('walletAddrBanner').textContent = wallet.substr(0, 6) + '...' + wallet.substr(-4); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); document.getElementById('gameSetup').style.display = 'block'; document.getElementById('buyWalletWarning').style.display = 'none'; document.getElementById('bulkPurchaseSection').style.display = 'block'; document.getElementById('marketplaceWalletWarning').style.display = 'none'; updateCreditsDisplay(); await updatePoolData(); await updateLPDashboard(); await updateBulkVestStatus(); await updatePackagePrices(); await updateNFTBonus(); } catch (e) { showCustomModal('âŒ Failed', e.message); walletBtn.disabled = false; walletBtn.innerHTML = 'ğŸ”— Connect Wallet'; } }
        
        async function updateNFTBonus() { if (!wallet) return; try { const stakedBonus = await poolContract.getStakedNFTBonus(wallet); const bonusMultiplier = stakedBonus.toNumber() / 10000; document.getElementById('userNftBonus').textContent = '+' + bonusMultiplier.toFixed(3) + 'x (Staked NFTs)'; } catch (e) { document.getElementById('userNftBonus').textContent = '+0.000x'; } }
        
        async function importBAKEToken() { try { await window.ethereum.request({ method: 'wallet_watchAsset', params: { type: 'ERC20', options: { address: CONTRACTS.POND_TOKEN, symbol: 'POND', decimals: 18 } } }); showCustomModal('âœ… Success', 'POND added!'); } catch (e) { showCustomModal('âŒ Error', e.message); } }
        
        async function updatePoolData() { try { const wsgbReserve = await poolContract.reserveSGB(); const pondReserve = await poolContract.reservePOND(); const wsgbAmount = parseFloat(ethers.utils.formatEther(wsgbReserve)); const pondAmount = parseFloat(ethers.utils.formatEther(pondReserve)); document.getElementById('poolWsgb').textContent = wsgbAmount.toFixed(2); document.getElementById('poolBake').textContent = Math.floor(pondAmount).toLocaleString(); const firstDepToggle = document.getElementById('firstDepositorToggle'); if (firstDepToggle && (wsgbAmount === 0 || pondAmount === 0)) { firstDepToggle.style.display = 'block'; } else if (firstDepToggle) { firstDepToggle.style.display = 'none'; } if (wsgbAmount > 0 && pondAmount > 0) { const price = wsgbAmount / pondAmount; document.getElementById('pondPrice').textContent = price.toFixed(6); const priceUSD = price * sgbPriceUSD; document.getElementById('pondPriceUSD').textContent = priceUSD.toFixed(6); const marketCap = priceUSD * 11900000000; document.getElementById('marketCap').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); document.getElementById('marketcapBanner').textContent = '$' + marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); document.getElementById('marketcapLP').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); const priceChange = ((price - 0.000003112356) / 0.000003112356) * 100; const changeEl = document.getElementById('allTimeChange'); changeEl.textContent = 'All-Time: ' + (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%'; changeEl.style.color = priceChange >= 0 ? '#10b981' : '#ef4444'; } } catch (e) { console.error('Pool data error:', e); } }
        
        async function updateBulkVestStatus() { if (!wallet || !poolContract) return; try { const bulkInfo = await poolContract.getBulkInfo(wallet); const totalBake = parseFloat(ethers.utils.formatEther(bulkInfo[0])); const claimed = parseFloat(ethers.utils.formatEther(bulkInfo[1])); const claimable = parseFloat(ethers.utils.formatEther(bulkInfo[2])); const timeRemaining = bulkInfo[3].toNumber(); if (totalBake > 0) { document.getElementById('vestStatus').style.display = 'block'; document.getElementById('vestTotal').textContent = Math.floor(totalBake).toLocaleString(); document.getElementById('vestClaimed').textContent = Math.floor(claimed).toLocaleString(); document.getElementById('vestClaimable').textContent = Math.floor(claimable).toLocaleString() + ' POND'; document.getElementById('vestTimeRemaining').textContent = timeRemaining > 0 ? Math.ceil(timeRemaining / 86400) + ' days remaining' : 'Fully vested!'; } else { document.getElementById('vestStatus').style.display = 'none'; } } catch (e) {} }
        
        async function buyPackage(usdAmount, discountPercent) { if (!wallet) { await showCustomModal('âš ï¸', 'Connect wallet first'); return; } const sgbAmount = Math.floor(usdAmount / 0.002); if (sgbBalance < sgbAmount) { await showCustomModal('âš ï¸ Insufficient SGB', 'Need ~'+sgbAmount.toLocaleString()+' SGB'); return; } try { const confirmed = await showCustomModal('ğŸ’° Buy $'+usdAmount, 'Pay ~'+sgbAmount.toLocaleString()+' SGB\n'+discountPercent+'% bonus, 60 day vest', [{text: 'Buy'}, {text: 'Cancel'}]); if (!confirmed) return; const sgbWei = ethers.utils.parseEther(sgbAmount.toString()); showCustomModal('â³', 'Check MetaMask...'); const tx = await poolContract.buyBulkPond({value: sgbWei}); await tx.wait(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); await updatePoolData(); await updateBulkVestStatus(); await updatePackagePrices(); await showCustomModal('âœ… Complete', 'Package purchased!'); } catch (e) { await showCustomModal('âŒ Failed', e.message); } }
        
        async function updatePackagePrices() { if (!poolContract) return; try { const packages = [{usd:500,d:2,s:'pkg500Sgb',b:'pkg500Bake'},{usd:1000,d:5,s:'pkg1000Sgb',b:'pkg1000Bake'},{usd:5000,d:10,s:'pkg5000Sgb',b:'pkg5000Bake'}]; for (const pkg of packages) { const sgbAmount = Math.floor(pkg.usd / 0.002); const sgbWei = ethers.utils.parseEther(sgbAmount.toString()); const normalBakeOut = await poolContract.getPondOut(sgbWei); const normalBake = parseFloat(ethers.utils.formatEther(normalBakeOut)); const bonusBake = normalBake * (1 + pkg.d / 100); document.getElementById(pkg.s).textContent = sgbAmount.toLocaleString() + ' SGB'; document.getElementById(pkg.b).textContent = Math.floor(bonusBake).toLocaleString() + ' POND'; } } catch (e) {} }
        
        async function claimBulkBAKE() { if (!wallet) return; try { showCustomModal('â³', 'Claiming...'); const tx = await poolContract.claimBulkBAKE(); await tx.wait(); const newBalance = await pondContract.balanceOf(wallet); balance = parseFloat(ethers.utils.formatEther(newBalance)); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); await updateBulkVestStatus(); await showCustomModal('âœ…', 'Claimed!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function updateLPDashboard() { if (!wallet || !poolContract) return; try { const lpInfo = await poolContract.getLPInfo(wallet); const sgbDeposited = parseFloat(ethers.utils.formatEther(lpInfo[0])); const bakeDeposited = parseFloat(ethers.utils.formatEther(lpInfo[1])); const poolPercent = lpInfo[3].toNumber() / 100; const multiplier = lpInfo[6].toNumber() / 1000; const pendingBAKE = parseFloat(ethers.utils.formatEther(lpInfo[7])); const pendingSGB = parseFloat(ethers.utils.formatEther(lpInfo[8])); const claimableSGB = parseFloat(ethers.utils.formatEther(lpInfo[9])); const timeUntilClaim = lpInfo[10].toNumber(); const lockExpires = lpInfo[5].toNumber(); if (sgbDeposited > 0) { userIsLP = true; document.getElementById('lpDashboard').style.display = 'block'; document.getElementById('lpPoolPercent').textContent = poolPercent.toFixed(2) + '%'; document.getElementById('lpMultiplier').textContent = multiplier.toFixed(1) + 'x'; document.getElementById('lpSgbDeposited').textContent = sgbDeposited.toFixed(2); document.getElementById('lpBakeDeposited').textContent = Math.floor(bakeDeposited).toLocaleString(); document.getElementById('lpPendingBake').textContent = Math.floor(pendingBAKE).toLocaleString(); document.getElementById('lpPendingSgb').textContent = pendingSGB.toFixed(4); document.getElementById('lpClaimableSgb').textContent = claimableSGB.toFixed(4); const now = Math.floor(Date.now() / 1000); if (lockExpires > now) { document.getElementById('lpLockStatus').textContent = 'Locked (' + Math.ceil((lockExpires - now) / 86400) + ' days)'; document.getElementById('lpUnlockSection').style.display = 'none'; } else { document.getElementById('lpLockStatus').textContent = 'Unlocked'; document.getElementById('lpUnlockSection').style.display = 'block'; } document.getElementById('lpSgbCountdown').textContent = timeUntilClaim > 0 ? Math.floor(timeUntilClaim / 86400) + 'd ' + Math.floor((timeUntilClaim % 86400) / 3600) + 'h' : 'Ready!'; const thresholdInfo = await poolContract.getNextPercentThreshold(wallet); document.getElementById('lpSgbNeeded').textContent = parseFloat(ethers.utils.formatEther(thresholdInfo[2])).toFixed(2); document.getElementById('lpNextPercent').textContent = (thresholdInfo[1].toNumber() / 100).toFixed(0) + '%'; } else { userIsLP = false; document.getElementById('lpDashboard').style.display = 'none'; } } catch (e) {} }
        
        async function claimPondRewards() { if (!wallet) return; try { showCustomModal('â³', 'Claiming POND...'); const tx = await poolContract.claimPondRewards(); await tx.wait(); await updateLPDashboard(); const newBalance = await pondContract.balanceOf(wallet); balance = parseFloat(ethers.utils.formatEther(newBalance)); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); await showCustomModal('âœ…', 'POND claimed!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function claimSgbRewards() { if (!wallet) return; try { showCustomModal('â³', 'Claiming SGB...'); const tx = await poolContract.claimSgbRewards(); await tx.wait(); await updateLPDashboard(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); await showCustomModal('âœ…', 'SGB claimed!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function relockPosition(tier) { if (!wallet) return; try { const days = tier===0?30:tier===1?90:180; const confirmed = await showCustomModal('ğŸ”’ Relock', 'Relock for '+days+' days?', [{text: 'Confirm'}, {text: 'Cancel'}]); if (!confirmed) return; showCustomModal('â³', 'Relocking...'); const tx = await poolContract.relock(tier); await tx.wait(); await updateLPDashboard(); await showCustomModal('âœ…', 'Relocked!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function removeLiquidity() { if (!wallet) return; try { const confirmed = await showCustomModal('âš ï¸ Withdraw', 'Withdraw all liquidity?', [{text: 'Withdraw'}, {text: 'Cancel'}]); if (!confirmed) return; showCustomModal('â³', 'Withdrawing...'); const tx = await poolContract.removeLiquidity(); await tx.wait(); await updateLPDashboard(); await updatePoolData(); const newBalance = await pondContract.balanceOf(wallet); balance = parseFloat(ethers.utils.formatEther(newBalance)); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); await showCustomModal('âœ…', 'Withdrawn!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function addLiquidity() { if (!wallet) { await showCustomModal('âš ï¸', 'Connect wallet first'); switchTab('play'); return; } try { const sgbAmount = parseFloat(document.getElementById('wsgbInput').value) || 0; const pondAmount = parseFloat(document.getElementById('bakeRequired').value) || 0; const lockTier = parseInt(document.getElementById('lockTierSelect').value); if (sgbAmount <= 0 || pondAmount <= 0) { await showCustomModal('âš ï¸', 'Enter valid amounts'); return; } if (balance < pondAmount) { await showCustomModal('âš ï¸', 'Need '+pondAmount.toLocaleString()+' POND'); return; } const lockDays = lockTier === 0 ? 30 : lockTier === 1 ? 90 : 180; const confirmed = await showCustomModal('ğŸ’§ Add Liquidity', 'Add '+sgbAmount+' SGB + '+pondAmount.toFixed(0)+' POND?\nLock: '+lockDays+' days', [{text: 'Confirm'}, {text: 'Cancel'}]); if (!confirmed) return; const pondWei = ethers.utils.parseEther(pondAmount.toString()); const sgbWei = ethers.utils.parseEther(sgbAmount.toString()); showCustomModal('â³ Step 1/2', 'Approve POND...'); const approveTx = await pondContract.approve(CONTRACTS.POOL_CONTRACT, pondWei); await approveTx.wait(); showCustomModal('â³ Step 2/2', 'Adding liquidity...'); let tx; if (userIsLP) { tx = await poolContract.addMore(pondWei, {value: sgbWei}); } else { tx = await poolContract.addLiquidity(pondWei, lockTier, {value: sgbWei}); } await tx.wait(); const newBalance = await pondContract.balanceOf(wallet); balance = parseFloat(ethers.utils.formatEther(newBalance)); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); addHistoryEntry('Added '+sgbAmount+' SGB + '+pondAmount.toFixed(0)+' POND to LP', pondAmount, 'lp'); document.getElementById('wsgbInput').value = ''; document.getElementById('bakeRequired').value = ''; await updatePoolData(); await updateLPDashboard(); await showCustomModal('âœ…', 'Liquidity added!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        async function executeSwap() { if (!wallet) { await showCustomModal('âš ï¸', 'Connect wallet first'); return; } try { const fromAmount = parseFloat(document.getElementById('swapFromAmount').value) || 0; const fromToken = document.getElementById('swapFromToken').value; if (fromAmount <= 0) { await showCustomModal('âš ï¸', 'Enter valid amount'); return; } if (fromToken === 'POND' && balance < fromAmount) { await showCustomModal('âš ï¸', 'Need '+fromAmount.toLocaleString()+' POND'); return; } const confirmed = await showCustomModal('ğŸ”„ Swap', 'Swap '+fromAmount.toFixed(2)+' '+fromToken+'?', [{text: 'Confirm'}, {text: 'Cancel'}]); if (!confirmed) return; let tx; if (fromToken === 'SGB') { showCustomModal('â³', 'Swapping...'); const sgbWei = ethers.utils.parseEther(fromAmount.toString()); tx = await poolContract.swapSgbForPond({value: sgbWei}); } else { const pondWei = ethers.utils.parseEther(fromAmount.toString()); showCustomModal('â³ Step 1/2', 'Approve POND...'); const approveTx = await pondContract.approve(CONTRACTS.POOL_CONTRACT, pondWei); await approveTx.wait(); showCustomModal('â³ Step 2/2', 'Swapping...'); tx = await poolContract.swapPondForSgb(pondWei); } await tx.wait(); const newBalance = await pondContract.balanceOf(wallet); balance = parseFloat(ethers.utils.formatEther(newBalance)); document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); const newSgbBalance = await provider.getBalance(wallet); sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); document.getElementById('swapFromAmount').value = ''; document.getElementById('swapToAmount').value = ''; await updatePoolData(); await showCustomModal('âœ…', 'Swap complete!'); } catch (e) { await showCustomModal('âŒ', e.message); } }
        
        function selectVehicle() { username = document.getElementById('username').value.trim().toUpperCase(); if (!username) { showCustomModal('âš ï¸', 'Enter a username'); return; } if (!wallet) { showCustomModal('âš ï¸', 'Connect wallet first'); return; } if (gameCredits < 1) { showCustomModal('âš ï¸ No Credits', 'Buy credits to play!'); return; } gameCredits--; updateCreditsDisplay(); document.getElementById('gameSetup').style.display = 'none'; document.getElementById('vehicleSelect').style.display = 'block'; }
        function selectVehicleType(icon, hp, dmg) { selectedVehicle = { icon: icon, hp: hp, dmg: dmg }; document.getElementById('vehicleSelect').style.display = 'none'; document.getElementById('marketplaceUpsell').style.display = 'block'; showUpsellItems(); }
        function showUpsellItems() { const container = document.getElementById('upsellItems'); const featured = [MARKETPLACE.tacticals[0], MARKETPLACE.tacticals[3], MARKETPLACE.tacticals[4], MARKETPLACE.tacticals[6]]; container.innerHTML = featured.map(function(item) { const owned = inventory.tacticals.includes(item.id); return '<div style="background: rgba(30, 41, 59, 0.8); border: 2px solid '+(owned ? '#10b981' : '#334155')+'; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 36px; margin-bottom: 8px;">'+item.icon+'</div><div style="font-weight: bold; font-size: 14px; margin-bottom: 5px; color: white;">'+item.name+'</div><div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">'+item.desc+'</div><div style="font-weight: bold; color: #fbbf24; margin-bottom: 8px;">'+item.price.toLocaleString()+' POND</div>'+(owned ? '<div style="color: #10b981; font-size: 12px;">âœ“ OWNED</div>' : '<button class="wallet-btn" onclick="quickBuyItem(\'tacticals\', \''+item.id+'\')" style="width: 100%; padding: 8px; font-size: 12px;">Buy</button>')+'</div>'; }).join(''); }
        async function quickBuyItem(category, itemId) { const item = MARKETPLACE[category].find(function(i) { return i.id === itemId; }); if (!item || !wallet) return; if (balance < item.price) { showCustomModal('âš ï¸', 'Need '+item.price.toLocaleString()+' POND'); return; } const confirmed = await showCustomModal('ğŸ’° Purchase', 'Buy '+item.name+' for '+item.price.toLocaleString()+' POND?', [{text: 'Buy'}, {text: 'Cancel'}]); if (confirmed) { balance -= item.price; document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); inventory[category].push(itemId); localStorage.setItem('bakeInventory', JSON.stringify(inventory)); addHistoryEntry('Bought '+item.name, item.price, 'burn'); showCustomModal('âœ…', item.name+' is yours!'); showUpsellItems(); } }
        function proceedToGame() { if (selectedVehicle) { document.getElementById('marketplaceUpsell').style.display = 'none'; startGame(selectedVehicle.icon, selectedVehicle.hp, selectedVehicle.dmg); } }
        
        function startGame(icon, hp, dmg) { document.getElementById('vehicleSelect').style.display = 'none'; document.getElementById('gameArea').style.display = 'block'; canvas = document.getElementById('gameCanvas'); const dpr = window.devicePixelRatio || 1; canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr; canvas.style.width = window.innerWidth + 'px'; canvas.style.height = window.innerHeight + 'px'; ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr); canvas.logicalWidth = window.innerWidth; canvas.logicalHeight = window.innerHeight; document.getElementById('playerName').textContent = username; document.getElementById('playerHP').textContent = hp; document.getElementById('playerMaxHP').textContent = hp; updateTacticalsDisplay(); initializeGame(icon, hp, dmg); showSarahMessage('start'); }
        
        function updateTacticalsDisplay() { const display = document.getElementById('tacticalsDisplay'); if (!inventory.tacticals || !inventory.tacticals.length) { display.innerHTML = '<div style="font-size: 14px; color: #64748b;">No tacticals</div>'; return; } const names = { 'orbital': 'ğŸ›¸ Orbital', 'timeslow': 'â±ï¸ Time Slow', 'turret': 'ğŸ”« Turret', 'airstrike': 'âœˆï¸ Airstrike', 'shield': 'ğŸ›¡ï¸ Shield', 'emp': 'ğŸ’£ EMP', 'heal': 'â¤ï¸ Heal', 'decoy': 'ğŸ‘» Decoy' }; let html = '<div style="font-size: 14px; color: #a855f7; margin-bottom: 5px;">TACTICALS:</div>'; inventory.tacticals.forEach(function(t, i) { const cd = player && player.tacticalCooldowns ? player.tacticalCooldowns[t] || 0 : 0; const cdSeconds = Math.ceil(cd / 60); const ready = cd === 0; const color = ready ? '#10b981' : '#ef4444'; const status = ready ? 'READY' : cdSeconds+'s'; html += '<div style="font-size: 13px; color: '+color+'; margin: 2px 0;">['+(i+1)+'] '+(names[t] || t)+' - '+status+'</div>'; }); display.innerHTML = html; }
        
        function drawShape(ctx, shape, x, y, size, color) { ctx.fillStyle = color; ctx.beginPath(); switch(shape) { case 'rectangle': ctx.fillRect(x - size * 1.5, y - size * 0.7, size * 3, size * 1.4); return; case 'square': ctx.fillRect(x - size, y - size, size * 2, size * 2); return; case 'diamond': ctx.moveTo(x, y - size); ctx.lineTo(x + size, y); ctx.lineTo(x, y + size); ctx.lineTo(x - size, y); ctx.closePath(); break; case 'hexagon': for (let i = 0; i < 6; i++) { const angle = i * Math.PI / 3; ctx.lineTo(x + size * Math.cos(angle), y + size * Math.sin(angle)); } ctx.closePath(); break; case 'triangle': ctx.moveTo(x, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); break; case 'oval': ctx.ellipse(x, y, size * 1.5, size, 0, 0, Math.PI * 2); break; case 'pentagon': for (let i = 0; i < 5; i++) { const angle = i * Math.PI * 2 / 5 - Math.PI / 2; ctx.lineTo(x + size * Math.cos(angle), y + size * Math.sin(angle)); } ctx.closePath(); break; case 'trapezoid': ctx.moveTo(x - size * 0.6, y - size); ctx.lineTo(x + size * 0.6, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); break; default: ctx.arc(x, y, size, 0, Math.PI * 2); } ctx.fill(); }
        
        function resolveEnemyCollisions() { for (let i = 0; i < enemies.length; i++) { for (let j = i + 1; j < enemies.length; j++) { const dx = enemies[j].x - enemies[i].x; const dy = enemies[j].y - enemies[i].y; const dist = Math.sqrt(dx * dx + dy * dy); const minDist = enemies[i].size + enemies[j].size + 5; if (dist < minDist && dist > 0) { const overlap = (minDist - dist) / 2; const pushX = (dx / dist) * overlap; const pushY = (dy / dist) * overlap; enemies[i].x -= pushX; enemies[i].y -= pushY; enemies[j].x += pushX; enemies[j].y += pushY; } } } }
        
        function triggerScreenShake(intensity, duration) { screenShakeIntensity = intensity; setTimeout(function() { screenShakeIntensity = 0; }, duration); }
        
        function triggerExplosionOverlay() { const overlay = document.getElementById('explosionOverlay'); overlay.style.opacity = '1'; setTimeout(function() { overlay.style.opacity = '0.7'; }, 100); setTimeout(function() { overlay.style.opacity = '0.4'; }, 200); setTimeout(function() { overlay.style.opacity = '0'; }, 400); }
        
        function createExplosionEffect(x, y, color, size) { for (let i = 0; i < 20; i++) { const angle = Math.random() * Math.PI * 2; const speed = 2 + Math.random() * 5; explosionEffects.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, size: size * (0.3 + Math.random() * 0.7), color: color, life: 60 + Math.random() * 30 }); } }
        
        function initializeGame(icon, hp, dmg) { const w = canvas.logicalWidth, h = canvas.logicalHeight; walls = [{ x: 150, y: 100, width: 120, height: 25 }, { x: w - 280, y: 180, width: 90, height: 30 }, { x: 100, y: h - 300, width: 140, height: 20 }, { x: w - 250, y: h - 280, width: 100, height: 35 }, { x: 300, y: h / 2 - 80, width: 80, height: 80 }, { x: w - 400, y: h / 2 + 30, width: 90, height: 60 }, { x: w / 2 - 150, y: 200, width: 70, height: 100 }, { x: w / 2 + 80, y: h - 350, width: 85, height: 70 }]; pickups = [{ x: 200, y: 200, type: 'health', icon: 'ğŸ’š', active: true }, { x: w - 200, y: 200, type: 'damage', icon: 'ğŸ’¥', active: true }, { x: 200, y: h - 300, type: 'speed', icon: 'âš¡', active: true }, { x: w - 200, y: h - 300, type: 'shield', icon: 'ğŸ›¡ï¸', active: true }, { x: w / 2, y: 150, type: 'health', icon: 'ğŸ’š', active: true }, { x: w / 2, y: h - 250, type: 'damage', icon: 'ğŸ’¥', active: true }]; player = { x: w / 2, y: h / 2, vx: 0, vy: 0, angle: 0, hp: hp, maxHp: hp, damage: dmg, baseDamage: dmg, size: 25, icon: icon, speed: 4, baseSpeed: 4, shield: false, shieldTime: 0, tacticalCooldowns: {} }; inventory.tacticals.forEach(function(t) { player.tacticalCooldowns[t] = 0; }); enemies = []; for (let i = 0; i < 7; i++) spawnEnemy(); bullets = []; keys = {}; kills = 0; streak = 0; pot = 10000; aliveCount = 8; gameStartTime = Date.now(); explosionEffects = []; activeTurrets = []; document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString(); canvas.addEventListener('mousemove', handleMouseMove); canvas.addEventListener('mousedown', handleMouseDown); canvas.addEventListener('mouseup', handleMouseUp); window.addEventListener('keydown', function(e) { keys[e.key.toLowerCase()] = true; }); window.addEventListener('keyup', function(e) { keys[e.key.toLowerCase()] = false; }); gameLoop = setInterval(update, 1000/60); }
        
        function spawnEnemy() { const w = canvas.logicalWidth, h = canvas.logicalHeight; const edge = Math.floor(Math.random() * 4); let x, y; if (edge === 0) { x = Math.random() * w; y = -40; } else if (edge === 1) { x = w + 40; y = Math.random() * h; } else if (edge === 2) { x = Math.random() * w; y = h + 40; } else { x = -40; y = Math.random() * h; } const hpVal = 200 + Math.random() * 200; const shapeIndex = Math.floor(Math.random() * ENEMY_SHAPES.length); enemies.push({ x: x, y: y, vx: 0, vy: 0, hp: hpVal, maxHp: hpVal, damage: 20 + Math.random() * 20, size: 25, name: ENEMY_NAMES[Math.floor(Math.random() * ENEMY_NAMES.length)], color: ENEMY_COLORS[shapeIndex % ENEMY_COLORS.length], shape: ENEMY_SHAPES[shapeIndex], speed: 1.5 + Math.random(), shootCooldown: Math.random() * 60, lives: 5 }); }
        
        function handleMouseMove(e) { const rect = canvas.getBoundingClientRect(); mouse.x = (e.clientX - rect.left) * (canvas.logicalWidth / rect.width); mouse.y = (e.clientY - rect.top) * (canvas.logicalHeight / rect.height); }
        function handleMouseDown() { mouse.clicked = true; }
        function handleMouseUp() { mouse.clicked = false; }
        
        function shoot() { const dx = mouse.x - player.x, dy = mouse.y - player.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist > 0) bullets.push({ x: player.x, y: player.y, vx: (dx/dist) * 12, vy: (dy/dist) * 12, damage: player.damage, isPlayer: true, size: 5 }); }
        
        function checkWallCollision(obj, newX, newY) { for (let i = 0; i < walls.length; i++) { const wall = walls[i]; if (newX - obj.size < wall.x + wall.width && newX + obj.size > wall.x && newY - obj.size < wall.y + wall.height && newY + obj.size > wall.y) return true; } return false; }
        
        function update() { gameTime = Math.floor((Date.now() - gameStartTime) / 1000); document.getElementById('gameTime').textContent = Math.floor(gameTime / 60) + ':' + (gameTime % 60).toString().padStart(2, '0'); 
            for (let key in player.tacticalCooldowns) { if (player.tacticalCooldowns[key] > 0) player.tacticalCooldowns[key]--; }
            inventory.tacticals.forEach(function(tactical, slot) { const key = (slot + 1).toString(); if (keys[key] && player.tacticalCooldowns[tactical] === 0) { keys[key] = false; const notif = document.getElementById('killNotif'); if (tactical === 'orbital') { enemies.forEach(function(e) { e.hp -= 300; }); player.tacticalCooldowns[tactical] = 10800; notif.innerHTML = 'ğŸ›¸ ORBITAL LASER!'; notif.style.display = 'block'; triggerScreenShake(20, 1000); triggerExplosionOverlay(); enemies.forEach(function(e) { createExplosionEffect(e.x, e.y, '#ff4400', 40); }); setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'airstrike') { enemies.forEach(function(e) { e.hp -= 200; }); player.tacticalCooldowns[tactical] = 7200; notif.innerHTML = 'âœˆï¸ AIRSTRIKE INCOMING!'; notif.style.display = 'block'; triggerScreenShake(15, 800); triggerExplosionOverlay(); for (let i = 0; i < 5; i++) { setTimeout(function() { const x = Math.random() * canvas.logicalWidth; const y = Math.random() * canvas.logicalHeight; createExplosionEffect(x, y, '#ff6600', 50); triggerScreenShake(10, 200); }, i * 150); } setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'shield') { player.shield = true; player.shieldTime = 600; player.tacticalCooldowns[tactical] = 5400; notif.innerHTML = 'ğŸ›¡ï¸ SHIELD ACTIVE!'; notif.style.display = 'block'; setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'heal') { const oldHp = player.hp; player.hp = Math.min(player.maxHp, player.hp + 100); document.getElementById('playerHP').textContent = Math.floor(player.hp); player.tacticalCooldowns[tactical] = 3600; notif.innerHTML = 'â¤ï¸ HEALED +' + Math.floor(player.hp - oldHp) + ' HP'; notif.style.display = 'block'; setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'emp') { enemies.forEach(function(e) { const origSpeed = e.speed; e.speed *= 0.2; setTimeout(function() { e.speed = origSpeed; }, 5000); }); player.tacticalCooldowns[tactical] = 2700; notif.innerHTML = 'ğŸ’£ EMP BLAST!'; notif.style.display = 'block'; triggerScreenShake(8, 300); setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'turret') { const turret = { x: player.x + 80, y: player.y - 80, active: true, cooldown: 0 }; activeTurrets.push(turret); const turretInterval = setInterval(function() { if (!turret.active) { clearInterval(turretInterval); return; } turret.cooldown--; if (turret.cooldown <= 0) { enemies.forEach(function(e) { const dx = e.x - turret.x, dy = e.y - turret.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist < 400) { e.hp -= 20; bullets.push({ x: turret.x, y: turret.y, vx: (dx/dist) * 12, vy: (dy/dist) * 12, damage: 0, isPlayer: true, size: 5, color: '#fbbf24' }); } }); turret.cooldown = 30; } }, 1000/60); setTimeout(function() { turret.active = false; const idx = activeTurrets.indexOf(turret); if (idx > -1) activeTurrets.splice(idx, 1); }, 10000); player.tacticalCooldowns[tactical] = 3600; notif.innerHTML = 'ğŸ”« TURRET DEPLOYED!'; notif.style.display = 'block'; setTimeout(function() { notif.style.display = 'none'; }, 2000); } else if (tactical === 'timeslow') { const origSpeed = player.speed; player.speed *= 2.5; setTimeout(function() { player.speed = origSpeed; }, 8000); player.tacticalCooldowns[tactical] = 9000; notif.innerHTML = 'â±ï¸ TIME DISTORTION!'; notif.style.display = 'block'; setTimeout(function() { notif.style.display = 'none'; }, 1500); } else if (tactical === 'decoy') { const decoy = { x: player.x + 100, y: player.y, hp: 50, active: true }; enemies.forEach(function(e) { e.target = decoy; }); setTimeout(function() { decoy.active = false; enemies.forEach(function(e) { e.target = null; }); }, 5000); player.tacticalCooldowns[tactical] = 1800; notif.innerHTML = 'ğŸ‘» DECOY DEPLOYED!'; notif.style.display = 'block'; setTimeout(function() { notif.style.display = 'none'; }, 2000); } } });
            if (mouse.clicked && Math.random() < 0.3) shoot(); if (player.shield) { player.shieldTime--; if (player.shieldTime <= 0) player.shield = false; }
            pickups.forEach(function(pickup) { if (!pickup.active) return; const dx = player.x - pickup.x, dy = player.y - pickup.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist < player.size + 20) { pickup.active = false; if (pickup.type === 'health') { player.hp = Math.min(player.maxHp, player.hp + 50); document.getElementById('playerHP').textContent = Math.floor(player.hp); showSarahMessage('pickup_health'); } else if (pickup.type === 'damage') { player.damage = player.baseDamage * 2; showSarahMessage('pickup_damage'); setTimeout(function() { player.damage = player.baseDamage; }, 10000); } else if (pickup.type === 'speed') { player.speed = player.baseSpeed * 1.5; showSarahMessage('pickup_speed'); setTimeout(function() { player.speed = player.baseSpeed; }, 8000); } else if (pickup.type === 'shield') { player.shield = true; player.shieldTime = 300; showSarahMessage('pickup_shield'); } setTimeout(function() { pickup.active = true; }, 20000); } });
            let newX = player.x, newY = player.y; if (keys['w'] || keys['arrowup']) newY -= player.speed; if (keys['s'] || keys['arrowdown']) newY += player.speed; if (keys['a'] || keys['arrowleft']) newX -= player.speed; if (keys['d'] || keys['arrowright']) newX += player.speed; if (!checkWallCollision(player, newX, player.y)) player.x = Math.max(player.size, Math.min(canvas.logicalWidth - player.size, newX)); if (!checkWallCollision(player, player.x, newY)) player.y = Math.max(player.size, Math.min(canvas.logicalHeight - player.size, newY)); player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            enemies.forEach(function(enemy, index) { if (!enemy.target || Math.random() < 0.01) { enemy.target = Math.random() < 0.8 && enemies.length > 1 ? enemies.filter(function(_, i) { return i !== index; })[Math.floor(Math.random() * (enemies.length - 1))] : player; } const dx = enemy.target.x - enemy.x, dy = enemy.target.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist > 0) { let newX = enemy.x + (dx/dist) * enemy.speed, newY = enemy.y + (dy/dist) * enemy.speed; if (!checkWallCollision(enemy, newX, enemy.y)) enemy.x = newX; if (!checkWallCollision(enemy, enemy.x, newY)) enemy.y = newY; } enemy.shootCooldown--; if (enemy.shootCooldown <= 0 && dist < 400) { if (dist > 0) bullets.push({ x: enemy.x, y: enemy.y, vx: (dx/dist) * 10, vy: (dy/dist) * 10, damage: enemy.damage, isPlayer: false, owner: enemy, size: 4 }); enemy.shootCooldown = 40 + Math.random() * 40; } }); resolveEnemyCollisions();
            updateBullets();
            explosionEffects = explosionEffects.filter(function(e) { e.x += e.vx; e.y += e.vy; e.vx *= 0.95; e.vy *= 0.95; e.life--; e.size *= 0.98; return e.life > 0; }); updateTacticalsDisplay(); draw(); }
        
        function updateBullets() {
            bullets = bullets.filter(function(bullet) { 
                bullet.x += bullet.vx; 
                bullet.y += bullet.vy; 
                for (let i = 0; i < walls.length; i++) { 
                    const wall = walls[i]; 
                    if (bullet.x > wall.x && bullet.x < wall.x + wall.width && bullet.y > wall.y && bullet.y < wall.y + wall.height) return false; 
                } 
                if (bullet.isPlayer) { 
                    for (let i = enemies.length - 1; i >= 0; i--) { 
                        const enemy = enemies[i]; 
                        const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy); 
                        if (dist < enemy.size) { 
                            enemy.hp -= bullet.damage; 
                            if (enemy.hp <= 0) { 
                                enemy.lives--; 
                                createExplosionEffect(enemy.x, enemy.y, enemy.color, 30); 
                                if (enemy.lives > 0) { 
                                    enemy.hp = 200 + Math.random() * 200; 
                                    enemy.maxHp = enemy.hp; 
                                    const edge = Math.floor(Math.random() * 4); 
                                    if (edge === 0) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = -40; } 
                                    else if (edge === 1) { enemy.x = canvas.logicalWidth + 40; enemy.y = Math.random() * canvas.logicalHeight; } 
                                    else if (edge === 2) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = canvas.logicalHeight + 40; } 
                                    else { enemy.x = -40; enemy.y = Math.random() * canvas.logicalHeight; } 
                                } else { 
                                    enemies.splice(i, 1); 
                                    aliveCount--; 
                                    document.getElementById('aliveCount').textContent = aliveCount; 
                                } 
                                kills++; streak++; 
                                let playerBake = 100; 
                                balance += playerBake; 
                                document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString(); 
                                addHistoryEntry('Kill reward', playerBake, 'earn'); 
                                pot += 1000; 
                                document.getElementById('currentPot').textContent = pot.toLocaleString(); 
                                const notif = document.getElementById('killNotif'); 
                                notif.innerHTML = 'ğŸ¯ KILL! +' + playerBake + ' POND'; 
                                notif.style.display = 'block'; 
                                setTimeout(function() { notif.style.display = 'none'; }, 1500); 
                                document.getElementById('killCount').textContent = kills; 
                                document.getElementById('streakCount').textContent = streak; 
                                if (kills === 1) showSarahMessage('kill1'); 
                                else if (kills === 3) { balance += 500; pot += 5000; showSarahMessage('kill3'); } 
                                else if (kills === 5) { balance += 500; pot += 5000; showSarahMessage('kill5'); } 
                                else if (kills === 8) { balance += 500; pot += 5000; showSarahMessage('kill8'); } 
                                else if (kills === 10) { balance += 500; pot += 5000; showSarahMessage('kill10'); } 
                                else if (kills === 15) { balance += 500; pot += 5000; showSarahMessage('kill15'); } 
                                else if (kills === 20) { balance += 500; pot += 5000; showSarahMessage('kill20'); } 
                                if (aliveCount === 2) showSarahMessage('lastStanding'); 
                                if (aliveCount === 1) endGame(true); 
                            } 
                            return false; 
                        } 
                    } 
                } else { 
                    const dxP = bullet.x - player.x, dyP = bullet.y - player.y, distP = Math.sqrt(dxP*dxP + dyP*dyP); 
                    if (distP < player.size) { 
                        if (!player.shield) { 
                            player.hp -= bullet.damage * 0.5; 
                            streak = 0; 
                            document.getElementById('playerHP').textContent = Math.max(0, Math.floor(player.hp)); 
                            document.getElementById('streakCount').textContent = 0; 
                            if (player.hp < player.maxHp * 0.3) showSarahMessage('lowHP'); 
                            if (player.hp <= 0) endGame(false); 
                        } 
                        return false; 
                    } 
                    for (let i = enemies.length - 1; i >= 0; i--) { 
                        const enemy = enemies[i]; 
                        if (bullet.owner === enemy) continue; 
                        const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy); 
                        if (dist < enemy.size) { 
                            enemy.hp -= bullet.damage * 0.5; 
                            if (enemy.hp <= 0) { 
                                enemies.splice(i, 1); 
                                aliveCount--; 
                                document.getElementById('aliveCount').textContent = aliveCount; 
                                if (aliveCount === 2) showSarahMessage('lastStanding'); 
                                if (aliveCount === 1) endGame(true); 
                            } 
                            return false; 
                        } 
                    } 
                } 
                return bullet.x > 0 && bullet.x < canvas.logicalWidth && bullet.y > 0 && bullet.y < canvas.logicalHeight; 
            });
        }
        
        function draw() { const w = canvas.logicalWidth, h = canvas.logicalHeight; if (screenShakeIntensity > 0) { ctx.save(); ctx.translate((Math.random() - 0.5) * screenShakeIntensity, (Math.random() - 0.5) * screenShakeIntensity); } const gradient = ctx.createLinearGradient(0, 0, 0, h); gradient.addColorStop(0, '#0a0e1a'); gradient.addColorStop(1, '#0f1419'); ctx.fillStyle = gradient; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = '#1a1f2e'; ctx.lineWidth = 1; for (let i = 0; i < w; i += 40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); } for (let i = 0; i < h; i += 40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); } ctx.fillStyle = '#334155'; ctx.strokeStyle = '#475569'; ctx.lineWidth = 2; walls.forEach(function(wall) { ctx.fillRect(wall.x, wall.y, wall.width, wall.height); ctx.strokeRect(wall.x, wall.y, wall.width, wall.height); }); pickups.forEach(function(pickup) { if (!pickup.active) return; ctx.save(); ctx.translate(pickup.x, pickup.y); const pulseSize = 25 + Math.sin(Date.now() / 200) * 5; ctx.fillStyle = 'rgba(251, 191, 36, 0.3)'; ctx.beginPath(); ctx.arc(0, 0, pulseSize, 0, Math.PI * 2); ctx.fill(); ctx.font = '32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(pickup.icon, 0, 0); ctx.restore(); });
            enemies.forEach(function(enemy) { ctx.save(); ctx.translate(enemy.x, enemy.y); drawShape(ctx, enemy.shape, 0, 0, enemy.size, enemy.color); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(enemy.name, 0, 0); const barWidth = 50, barHeight = 5, hpPercent = enemy.hp / enemy.maxHp; ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -enemy.size - 12, barWidth, barHeight); ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444'; ctx.fillRect(-barWidth/2, -enemy.size - 12, barWidth * hpPercent, barHeight); ctx.restore(); });
            activeTurrets.forEach(function(turret) { if (!turret.active) return; ctx.fillStyle = '#ef4444'; ctx.fillRect(turret.x - 25, turret.y - 25, 50, 50); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 4; ctx.strokeRect(turret.x - 25, turret.y - 25, 50, 50); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ğŸ”«', turret.x, turret.y); });
            ctx.save(); ctx.translate(player.x, player.y); if (player.shield) { const shieldPulse = 35 + Math.sin(Date.now() / 100) * 3; ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0, 0, shieldPulse, 0, Math.PI * 2); ctx.stroke(); ctx.strokeStyle = 'rgba(59, 130, 246, 0.4)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, shieldPulse + 5, 0, Math.PI * 2); ctx.stroke(); } ctx.rotate(player.angle); let playerColor = '#10b981'; if (inventory.skins.includes('gold')) playerColor = '#fbbf24'; else if (inventory.skins.includes('chrome')) playerColor = '#e5e7eb'; else if (inventory.skins.includes('neon')) playerColor = '#a855f7'; ctx.fillStyle = playerColor; ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(username, 0, 0); const barWidth = 50, barHeight = 5, hpPercent = player.hp / player.maxHp; ctx.rotate(-player.angle); ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -player.size - 12, barWidth, barHeight); ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444'; ctx.fillRect(-barWidth/2, -player.size - 12, barWidth * hpPercent, barHeight); ctx.restore();
            bullets.forEach(function(bullet) { ctx.fillStyle = bullet.color || (bullet.isPlayer ? '#3b82f6' : '#ef4444'); ctx.beginPath(); ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2); ctx.fill(); });
            explosionEffects.forEach(function(e) { ctx.globalAlpha = e.life / 60; ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; }); if (screenShakeIntensity > 0) { ctx.restore(); } }
        
        async function endGame(won) { clearInterval(gameLoop); canvas.removeEventListener('mousemove', handleMouseMove); canvas.removeEventListener('mousedown', handleMouseDown); canvas.removeEventListener('mouseup', handleMouseUp); if (won) { showSarahMessage('victory'); balance += pot; totalKills += kills; document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); addHistoryEntry('Victory! Won pot', pot, 'earn'); leaderboard.push({ name: username, bake: pot, kills: kills, date: new Date().toISOString() }); leaderboard.sort(function(a, b) { return b.bake - a.bake; }); leaderboard = leaderboard.slice(0, 20); localStorage.setItem('bakeLeaderboard', JSON.stringify(leaderboard)); updateLeaderboardDisplay(); await updatePoolData(); setTimeout(async function() { const playAgain = await showCustomModal('ğŸ† VICTORY!', 'You won '+pot.toLocaleString()+' POND!\n\nKills: '+kills+'\nTime: '+Math.floor(gameTime/60)+':'+(gameTime%60).toString().padStart(2,'0'), [{text: 'Play Again'}, {text: 'Exit'}]); lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0; document.getElementById('gameArea').style.display = 'none'; if (playAgain) { document.getElementById('vehicleSelect').style.display = 'block'; } else { document.getElementById('gameSetup').style.display = 'block'; switchTab('play'); } }, 2000); } else { lives--; document.getElementById('livesCount').textContent = lives; totalKills += kills; if (lives > 0) { await showCustomModal('ğŸ’€ YOU DIED!', 'Lives remaining: '+lives+'/5\n\nRespawning...', [{text: 'Continue'}]); respawnPlayer(); } else { const result = await showCustomModal('ğŸ’€ GAME OVER!', 'Total Kills: '+totalKills+'\nTime: '+Math.floor(gameTime/60)+':'+(gameTime%60).toString().padStart(2,'0')+'\n\nCredits: '+gameCredits+'\nSGB Balance: '+sgbBalance.toFixed(2), [{text: 'Buy 1 Credit (1 SGB)'}, {text: 'Buy 5 Credits (5 SGB)'}, {text: 'Exit'}]); if (result) { const success = await buyCreditsInGame(1); if (success) { lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0; gameCredits--; updateCreditsDisplay(); respawnPlayer(); return; } } else { const buyFive = await showCustomModal('Buy 5 Credits?', 'Get 5 credits for 5 SGB?', [{text: 'Buy 5'}, {text: 'Exit'}]); if (buyFive) { const success = await buyCreditsInGame(5); if (success) { lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0; gameCredits--; updateCreditsDisplay(); respawnPlayer(); return; } } } lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0; document.getElementById('gameArea').style.display = 'none'; document.getElementById('gameSetup').style.display = 'block'; } } }
        
        function respawnPlayer() { player.x = canvas.logicalWidth / 2; player.y = canvas.logicalHeight / 2; player.hp = player.maxHp; player.vx = 0; player.vy = 0; player.shield = false; player.shieldTime = 0; document.getElementById('playerHP').textContent = player.maxHp; canvas.addEventListener('mousemove', handleMouseMove); canvas.addEventListener('mousedown', handleMouseDown); canvas.addEventListener('mouseup', handleMouseUp); showSarahMessage('start'); gameLoop = setInterval(update, 1000/60); }
        
        function toggleFirstDepositor() { const isFirst = document.getElementById('isFirstDepositor').checked; const bakeInput = document.getElementById('bakeRequired'); if (isFirst) { bakeInput.readOnly = false; bakeInput.style.background = '#1e293b'; bakeInput.style.cursor = 'text'; bakeInput.style.color = 'white'; bakeInput.value = ''; } else { bakeInput.readOnly = true; bakeInput.style.background = '#0f172a'; bakeInput.style.cursor = 'not-allowed'; bakeInput.style.color = '#fbbf24'; document.getElementById('wsgbInput').dispatchEvent(new Event('input')); } }
        
        function showCategory(category) { document.querySelectorAll('.category-tab-btn').forEach(function(btn) { btn.style.borderColor = '#334155'; btn.style.background = 'rgba(30, 41, 59, 0.8)'; }); if (event && event.target) { event.target.style.borderColor = '#ec4899'; event.target.style.background = 'rgba(236, 72, 153, 0.2)'; } const items = MARKETPLACE[category]; const container = document.getElementById('marketplaceItems'); const rarityColors = { legendary: '#fbbf24', epic: '#a855f7', rare: '#3b82f6', common: '#94a3b8' }; container.innerHTML = items.map(function(item) { const owned = inventory[category].includes(item.id); return '<div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid '+(owned ? '#22c55e' : '#334155')+'; padding: 20px; border-radius: 12px; cursor: '+(owned ? 'default' : 'pointer')+'; text-align: center; '+(owned ? 'opacity: 0.7;' : '')+'" onclick="'+(owned ? '' : "buyItem('"+category+"', '"+item.id+"', "+item.price+", '"+item.name+"')")+'"><div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 64px; margin-bottom: 15px; border-radius: 8px; background: linear-gradient(135deg, rgba(30,41,59,0.8), '+(item.color || '#334155')+');">'+item.icon+'</div><div style="font-size: 10px; font-weight: bold; margin-bottom: 5px; color: '+rarityColors[item.rarity]+';">'+item.rarity.toUpperCase()+'</div><div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">'+item.name+'</div><div style="font-size: 11px; color: #94a3b8; margin-bottom: 10px;">'+item.desc+'</div><div style="font-size: 20px; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">'+item.price.toLocaleString()+' POND</div><button style="background: '+(owned ? '#22c55e' : 'linear-gradient(135deg, #ec4899, #d946ef)')+'; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: bold; cursor: '+(owned ? 'default' : 'pointer')+'; width: 100%;">'+(owned ? 'âœ“ OWNED' : 'BUY NOW')+'</button></div>'; }).join(''); }
        
        async function buyItem(category, itemId, price, name) { if (!wallet) { showCustomModal('âš ï¸', 'Connect wallet first'); return; } if (inventory[category].includes(itemId)) return; if (balance < price) { showCustomModal('âš ï¸ Insufficient POND', 'Need '+price.toLocaleString()+' POND', [{text: 'Buy POND', onClick: function() { switchTab('buy'); }}, {text: 'Cancel'}]); return; } const confirmed = await showCustomModal('ğŸ’° Confirm Purchase', 'Buy '+name+' for '+price.toLocaleString()+' POND?', [{text: 'Purchase'}, {text: 'Cancel'}]); if (confirmed) { balance -= price; document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); inventory[category].push(itemId); localStorage.setItem('bakeInventory', JSON.stringify(inventory)); addHistoryEntry('Bought '+name, price, 'burn'); showCustomModal('âœ… Purchase Successful!', name+' is now yours!'); showCategory(category); } }
        
        function switchTab(tab) { document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); }); document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); }); document.querySelector('[onclick="switchTab(\''+tab+'\')"]').classList.add('active'); document.getElementById(tab + 'Tab').classList.add('active'); if (tab === 'leaderboard') updateLeaderboardDisplay(); if (tab === 'marketplace') showCategory('tacticals'); if (tab === 'pool' && !wallet) loadPoolDataWithoutWallet(); }
        
        async function loadPoolDataWithoutWallet() { try { const tempProvider = new ethers.providers.JsonRpcProvider(SONGBIRD_RPC); const tempPoolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, ["function reserveSGB() view returns (uint256)", "function reservePOND() view returns (uint256)"], tempProvider); const wsgbReserve = await tempPoolContract.reserveSGB(); const pondReserve = await tempPoolContract.reservePOND(); const wsgbAmount = parseFloat(ethers.utils.formatEther(wsgbReserve)); const pondAmount = parseFloat(ethers.utils.formatEther(pondReserve)); if (wsgbAmount > 0 && pondAmount > 0) { const price = wsgbAmount / pondAmount; const priceUSD = price * sgbPriceUSD; const marketCap = priceUSD * 11900000000; document.getElementById('marketcapLP').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); document.getElementById('liquidityValue').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); } } catch (e) { console.log('Could not load pool data:', e); } }
        
        window.addEventListener('load', async function() { await fetchSGBPrice(); updateHistoryTable(); updateLeaderboardDisplay(); updateCreditsDisplay(); loadPoolDataWithoutWallet(); const wsgbInput = document.getElementById('wsgbInput'); if (wsgbInput) { wsgbInput.addEventListener('input', function() { const wsgbAmount = parseFloat(this.value) || 0; const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 0; const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 0; const isFirst = document.getElementById('isFirstDepositor') && document.getElementById('isFirstDepositor').checked; if (wsgbAmount > 0 && poolWsgb > 0 && poolBake > 0 && !isFirst) { const currentRatio = poolBake / poolWsgb; const bakeAt05x = wsgbAmount * currentRatio * 0.5; document.getElementById('bakeRequired').value = bakeAt05x.toFixed(2); } else if (isFirst) { document.getElementById('bakeRequired').value = ''; } }); } const swapFromAmount = document.getElementById('swapFromAmount'); const swapFromToken = document.getElementById('swapFromToken'); function updateSwapEstimate() { const fromAmount = parseFloat(swapFromAmount.value) || 0; const fromToken = swapFromToken.value; if (fromAmount > 0) { const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 100000; const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 3846154; let toAmount = 0; if (fromToken === 'SGB') { toAmount = poolBake - (poolWsgb * poolBake) / (poolWsgb + fromAmount); } else { toAmount = poolWsgb - (poolWsgb * poolBake) / (poolBake + fromAmount); } document.getElementById('swapToAmount').value = toAmount.toFixed(6); } else { document.getElementById('swapToAmount').value = ''; } } if (swapFromAmount) { swapFromAmount.addEventListener('input', updateSwapEstimate); swapFromToken.addEventListener('change', updateSwapEstimate); } });
    </script>
</body>
</html>
