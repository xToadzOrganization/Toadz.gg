<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAKE Arena - Play to Earn</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial Black', Arial, sans-serif;
            color: white;
            padding: 20px;
        }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.8); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { width: 100%; max-width: 1400px; background: rgba(15, 23, 42, 0.98); border-radius: 16px; border: 2px solid #334155; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; padding: 30px 20px 20px 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-bottom: 2px solid #334155; }
        .header h1 { font-size: clamp(32px, 5vw, 48px); background: linear-gradient(135deg, #38bdf8, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; }
        .header .tagline { color: #fbbf24; font-size: clamp(14px, 2vw, 16px); }
        .fomo-banner { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)); border-bottom: 2px solid #10b981; padding: 15px 20px; }
        .fomo-content { display: flex; justify-content: flex-start; align-items: center; flex-wrap: wrap; gap: 40px; }
        .fomo-stat { text-align: center; }
        .fomo-value { font-size: clamp(20px, 3vw, 28px); font-weight: bold; color: #10b981; }
        .fomo-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .tabs { display: flex; background: rgba(30, 41, 59, 0.8); border-bottom: 2px solid #334155; overflow-x: auto; }
        .tab { flex: 1; min-width: 120px; padding: 15px 10px; text-align: center; cursor: pointer; border: none; background: transparent; color: #94a3b8; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: rgba(59, 130, 246, 0.1); color: #fff; }
        .tab.active { color: #38bdf8; border-bottom: 3px solid #38bdf8; background: rgba(59, 130, 246, 0.2); }
        .tab.marketplace-tab { background: linear-gradient(90deg, rgba(236, 72, 153, 0.6), rgba(168, 85, 247, 0.6), rgba(59, 130, 246, 0.6), rgba(236, 72, 153, 0.6)); background-size: 200% 200%; animation: rainbow 4s linear infinite; }
        .tab-content { display: none; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .wallet-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .wallet-btn:hover { transform: translateY(-2px); }
        .wallet-connected { background: linear-gradient(135deg, #22c55e, #16a34a); }
    </style>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ BAKE ARENA</h1>
            <div class="tagline">üí∞ Play ‚Ä¢ Earn ‚Ä¢ Dominate</div>
        </div>
        
        <div id="walletBanner" class="fomo-banner" style="display: none;">
            <div class="fomo-content">
                <div class="fomo-stat"><div style="color: #3b82f6; font-size: 16px; font-weight: bold;"><span id="walletAddrBanner"></span></div><div class="fomo-label">Wallet</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #fbbf24;"><span id="walletBalBanner">0</span></div><div class="fomo-label">Your BAKE</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #22c55e;"><span id="walletSGBBanner">0</span></div><div class="fomo-label">Your SGB</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #ec4899;"><span id="gameCredits">0</span></div><div class="fomo-label">Game Credits</div></div>
            </div>
        </div>
        
        <div id="lpBanner" class="fomo-banner">
            <div class="fomo-content">
                <div style="font-size: 18px; font-weight: bold; color: #10b981;">BAKE LP STATS</div>
                <div class="fomo-stat"><div style="color: #fbbf24; font-size: 24px; font-weight: bold;">$<span id="bakePriceUSD">0.000084</span></div><div class="fomo-label">BAKE Price</div></div>
                <div class="fomo-stat"><div class="fomo-value" style="color: #8b5cf6;">$<span id="marketcapLP">0</span></div><div class="fomo-label">Market Cap</div></div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('play')">üéÆ PLAY</button>
            <button class="tab" onclick="switchTab('leaderboard')">üèÜ LEADERBOARD</button>
            <button class="tab marketplace-tab" onclick="switchTab('marketplace')">‚ú® MARKETPLACE</button>
        </div>
        
        <div id="playTab" class="tab-content active">
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="walletBtn" class="wallet-btn" onclick="connectWallet()">üîó Connect Wallet</button>
            </div>
            
            <div id="gameSetup" style="display: none;">
                <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #10b981; margin-bottom: 15px;">üéüÔ∏è BUY GAME CREDITS</h3>
                    <p style="color: #94a3b8; margin-bottom: 15px; font-size: 14px;">1 SGB = 1 Game Credit. Buy multiple!</p>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                        <button onclick="adjustCredits(-1)" style="background: #ef4444; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 24px; font-weight: bold; cursor: pointer;">-</button>
                        <input type="number" id="creditsToBuy" value="1" min="1" max="100" style="width: 100px; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; font-weight: bold;">
                        <button onclick="adjustCredits(1)" style="background: #22c55e; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 24px; font-weight: bold; cursor: pointer;">+</button>
                    </div>
                    <div style="color: #fbbf24; font-size: 18px; margin-bottom: 15px;">Cost: <span id="creditCost">1</span> SGB</div>
                    <input type="text" id="username" placeholder="ENTER USERNAME" maxlength="8" style="width: 300px; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">
                    <button id="payEntryBtn" class="wallet-btn" onclick="buyCredits()" style="background: linear-gradient(135deg, #10b981, #059669); display: block; margin: 0 auto;">üí∏ BUY CREDITS & PLAY</button>
                    <div id="existingCredits" style="display: none; margin-top: 15px; padding: 15px; background: rgba(251, 191, 36, 0.2); border: 2px solid #fbbf24; border-radius: 8px;">
                        <div style="color: #fbbf24; font-size: 16px;">You have <span id="existingCreditsCount">0</span> credits!</div>
                        <button class="wallet-btn" onclick="startWithExistingCredits()" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: black; margin-top: 10px;">‚ñ∂Ô∏è START PLAYING</button>
                    </div>
                </div>
            </div>
            
            <div id="vehicleSelect" style="display: none;">
                <h3 style="text-align: center; color: #38bdf8; margin-bottom: 15px;">CHOOSE YOUR VEHICLE</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div onclick="selectVehicleType('tank', 230, 40)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 60px; height: 40px; background: linear-gradient(135deg, #22c55e, #16a34a); margin: 0 auto 10px auto; border-radius: 4px;"></div>
                        <div style="font-weight: bold;">Tank</div><div style="font-size: 11px; color: #94a3b8;">HP: 230 ‚Ä¢ DMG: 40</div>
                    </div>
                    <div onclick="selectVehicleType('sports', 92, 20)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 50px; height: 25px; background: linear-gradient(135deg, #3b82f6, #2563eb); margin: 0 auto 10px auto; border-radius: 12px;"></div>
                        <div style="font-weight: bold;">Sports Car</div><div style="font-size: 11px; color: #94a3b8;">HP: 92 ‚Ä¢ DMG: 20</div>
                    </div>
                    <div onclick="selectVehicleType('truck', 161, 30)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 55px; height: 35px; background: linear-gradient(135deg, #f97316, #ea580c); margin: 0 auto 10px auto; border-radius: 6px;"></div>
                        <div style="font-weight: bold;">Truck</div><div style="font-size: 11px; color: #94a3b8;">HP: 161 ‚Ä¢ DMG: 30</div>
                    </div>
                </div>
            </div>
            
            <div id="gameArea" style="display: none;">
                <div id="gameContainer" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0a0e1a; z-index: 9999;">
                    <canvas id="gameCanvas" style="width: 100%; height: 100%;"></canvas>
                    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); padding: 20px 40px; border-radius: 16px; border: 3px solid #fbbf24;">
                        <div style="font-size: 14px; color: #78350f; text-align: center;">üí∞ PRIZE POT</div>
                        <div style="font-size: 36px; font-weight: bold; color: #ffffff; text-align: center;"><span id="currentPot">10000</span> BAKE</div>
                    </div>
                    <div id="killNotif" style="position: absolute; top: 120px; left: 50%; transform: translateX(-50%); display: none; background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95)); padding: 15px 30px; border-radius: 12px; border: 2px solid #22c55e; font-size: 24px; font-weight: bold;"></div>
                    <div style="position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155;">
                        <div style="font-size: 18px; margin: 5px 0; color: #ef4444;">‚ù§Ô∏è <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #10b981;">üíö Lives: <span id="livesCount">5</span>/5</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">üç∞ <span id="playerBAKE">0</span> BAKE</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #22c55e;">üèÜ <span id="killCount">0</span> kills</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #ec4899;">üî• <span id="streakCount">0</span>x streak</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #8b5cf6;">üéüÔ∏è <span id="creditsDisplay">0</span> credits</div>
                        <div id="tacticalsDisplay" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155;"></div>
                    </div>
                    <div style="position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155; text-align: right;">
                        <div style="font-size: 18px; margin: 5px 0; color: #38bdf8;">üéÆ <span id="playerName">Player</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #a855f7;">üë• <span id="aliveCount">8</span> alive</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">‚è±Ô∏è <span id="gameTime">0:00</span></div>
                    </div>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.98), rgba(219, 39, 119, 0.98)); padding: 30px 40px; border-top: 4px solid #ec4899;">
                        <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 25px;">
                            <div style="font-size: 64px;">üíÅ‚Äç‚ôÄÔ∏è</div>
                            <div style="flex: 1;"><div style="font-size: 18px; font-weight: bold; color: #fce7f3; margin-bottom: 8px;">SARAH</div><div id="sarahText" style="font-size: 32px; color: #ffffff; line-height: 1.4; font-weight: 600;">Good luck out there! üíï</div></div>
                        </div>
                    </div>
                    <div id="strikeOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none;"></div>
                </div>
            </div>
        </div>
        
        <div id="leaderboardTab" class="tab-content">
            <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">üèÜ TOP PLAYERS</h2>
            <div id="leaderboardList" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 20px; border-radius: 12px;"></div>
        </div>
        
        <div id="marketplaceTab" class="tab-content">
            <h2 style="color: #ec4899; margin-bottom: 20px; text-align: center;">‚ú® BAKE Marketplace</h2>
            <div id="marketplaceWalletWarning" style="background: rgba(239,68,68,0.2); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <div style="color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è CONNECT WALLET TO SHOP</div>
                <button class="wallet-btn" onclick="connectWallet();">üîó Connect Wallet</button>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <div onclick="showCategory('tacticals')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer;">‚öîÔ∏è Tacticals</div>
                <div onclick="showCategory('skins')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer;">üé® Skins</div>
            </div>
            <div id="marketplaceItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
        </div>
    </div>

    <script>
        const SONGBIRD_CHAIN_ID = '0x13';
        const CONTRACTS = {
            BAKE_TOKEN: '0xBA3a30FFd8a8a18C90b275FC7fE2F8EFd77F30Ce',
            GAME_CONTRACT: '0xaB27737d60ce0FaC521f82e3d2703d0D1c279E49',
            POOL_CONTRACT: '0xa3F654f563055734Af48F2Ff5aF81BB59A9187a3'
        };
        const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function approve(address spender, uint256 amount) returns (bool)"];
        
        let wallet = null, balance = 100000, sgbBalance = 1000;
        let leaderboard = JSON.parse(localStorage.getItem('bakeLeaderboard') || '[]');
        let username = '', canvas, ctx, gameLoop;
        let player, enemies = [], bullets = [], walls = [], pickups = [], activeTurrets = [], explosions = [];
        let keys = {}, mouse = { x: 0, y: 0, clicked: false };
        let pot = 10000, kills = 0, streak = 0, aliveCount = 8;
        let gameTime = 0, gameStartTime = 0, lives = 5, totalKills = 0;
        let provider, signer, bakeContract;
        let selectedVehicle = null;
        let currentModal = null;
        let gameCredits = 0;
        
        const PLAYER_NAMES = ['SHADOW','VIPER','GHOST','BLAZE','STORM','FURY','RAZOR','TITAN','PHOENIX','HUNTER','RAVEN','WOLF','HAWK','COBRA','DRAGON','KNIGHT','NINJA','REAPER','SNIPER','HAVOC','CHAOS','DOOM','FLASH','ZEUS','THOR','LOKI','APEX','PRIME','ELITE','ALPHA','OMEGA','SIGMA'];
        
        const ENEMY_VEHICLES = [
            { type: 'rectangle', width: 35, height: 20, color: '#ef4444' },
            { type: 'square', width: 28, height: 28, color: '#f97316' },
            { type: 'diamond', width: 30, height: 30, color: '#eab308' },
            { type: 'hexagon', width: 32, height: 28, color: '#22c55e' },
            { type: 'triangle', width: 30, height: 35, color: '#06b6d4' },
            { type: 'oval', width: 38, height: 22, color: '#3b82f6' },
            { type: 'pentagon', width: 30, height: 30, color: '#8b5cf6' },
            { type: 'trapezoid', width: 34, height: 24, color: '#ec4899' }
        ];
        
        const MARKETPLACE = {
            skins: [
                { id: 'gold', name: 'Golden Warrior', rarity: 'legendary', price: 50000, icon: 'üèÜ', color: '#fbbf24', desc: 'Shine like a champion' },
                { id: 'chrome', name: 'Chrome Crusader', rarity: 'epic', price: 35000, icon: 'üíé', color: '#e5e7eb', desc: 'Reflective perfection' },
                { id: 'neon', name: 'Neon Racer', rarity: 'epic', price: 40000, icon: 'üåü', color: '#a855f7', desc: 'Glow in the dark' }
            ],
            tacticals: [
                { id: 'orbital', name: 'Orbital Laser', rarity: 'legendary', price: 150000, icon: 'üõ∏', desc: 'Space laser (180s cd)' },
                { id: 'airstrike', name: 'Airstrike', rarity: 'legendary', price: 100000, icon: '‚úàÔ∏è', desc: 'Call explosions (120s cd)' },
                { id: 'shield', name: 'Shield Dome', rarity: 'epic', price: 70000, icon: 'üõ°Ô∏è', desc: 'Block bullets 10s (90s cd)' },
                { id: 'emp', name: 'EMP Mine', rarity: 'epic', price: 60000, icon: 'üí£', desc: 'Slow enemies (45s cd)' },
                { id: 'heal', name: 'Heal Station', rarity: 'rare', price: 50000, icon: '‚ù§Ô∏è', desc: 'Restore HP (60s cd)' },
                { id: 'turret', name: 'Auto Turret', rarity: 'legendary', price: 80000, icon: 'üî´', desc: 'Deploy turret (60s cd)' },
                { id: 'timeslow', name: 'Time Distortion', rarity: 'legendary', price: 120000, icon: '‚è±Ô∏è', desc: 'Bullet time 8s (150s cd)' },
                { id: 'decoy', name: 'Decoy Vehicle', rarity: 'rare', price: 40000, icon: 'üëª', desc: 'Fake target (30s cd)' }
            ]
        };
        
        let inventory = { skins: [], tacticals: [] };
        
        const sarahMessages = {
            start: "Good luck out there! üíï", kill1: "Nice shot... really nice üéØ", kill3: "You're making me feel things üî•",
            kill5: "Watching you dominate... üò≥üí¶", kill10: "I need to see you after this. Alone. üíã",
            lowHP: "Baby no! Stay alive! ‚ù§Ô∏è‚Äçüî•", lastStanding: "Finish them! üí¶", victory: "That was SO hot. My place? üè†üî•",
            pickup_health: "Getting harder? üíö", pickup_damage: "Bigger is better üí•üòè", respawn: "Don't give up! üí™üíï"
        };
        
        function showSarahMessage(type) { const el = document.getElementById('sarahText'); if (sarahMessages[type]) el.textContent = sarahMessages[type]; }
        
        function closeCurrentModal() { if (currentModal && currentModal.parentNode) { document.body.removeChild(currentModal); currentModal = null; } }
        
        function showCustomModal(title, message, buttons = [{text: 'OK'}]) {
            return new Promise(resolve => {
                closeCurrentModal();
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10000;';
                const btnHtml = buttons.map((b, i) => `<button id="modalBtn${i}" style="background:${i===0?'linear-gradient(135deg,#3b82f6,#2563eb)':'rgba(71,85,105,0.5)'};border:none;padding:15px 40px;border-radius:12px;color:white;font-size:18px;font-weight:bold;cursor:pointer;margin:5px;">${b.text}</button>`).join('');
                modal.innerHTML = `<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border:3px solid #3b82f6;border-radius:20px;padding:40px;text-align:center;max-width:500px;"><div style="font-size:36px;font-weight:bold;color:#3b82f6;margin-bottom:20px;">${title}</div><div style="color:#e2e8f0;font-size:18px;margin-bottom:30px;line-height:1.6;white-space:pre-line;">${message}</div><div>${btnHtml}</div></div>`;
                document.body.appendChild(modal);
                currentModal = modal;
                buttons.forEach((b, i) => { document.getElementById(`modalBtn${i}`).onclick = () => { closeCurrentModal(); if (b.onClick) b.onClick(); resolve(i === 0); }; });
            });
        }
        
        function showInGameModal(title, message, buttons = [{text: 'OK'}]) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.id = 'inGameModal';
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:10001;';
                const btnHtml = buttons.map((b, i) => `<button id="igModalBtn${i}" style="background:${b.color || 'linear-gradient(135deg,#22c55e,#16a34a)'};border:none;padding:15px 30px;border-radius:12px;color:white;font-size:16px;font-weight:bold;cursor:pointer;margin:8px;">${b.text}</button>`).join('');
                modal.innerHTML = `<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border:3px solid #fbbf24;border-radius:20px;padding:40px;text-align:center;max-width:450px;"><div style="font-size:32px;font-weight:bold;color:#fbbf24;margin-bottom:15px;">${title}</div><div style="color:#e2e8f0;font-size:16px;margin-bottom:25px;line-height:1.6;white-space:pre-line;">${message}</div><div style="display:flex;flex-direction:column;align-items:center;">${btnHtml}</div></div>`;
                document.body.appendChild(modal);
                buttons.forEach((b, i) => { document.getElementById(`igModalBtn${i}`).onclick = () => { modal.remove(); if (b.onClick) b.onClick(); resolve(i); }; });
            });
        }
        
        async function connectWallet() {
            const walletBtn = document.getElementById('walletBtn');
            try {
                walletBtn.disabled = true; walletBtn.innerHTML = '‚è≥ Connecting...';
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                bakeContract = new ethers.Contract(CONTRACTS.BAKE_TOKEN, ERC20_ABI, signer);
                wallet = await signer.getAddress();
                const bakeBalance = await bakeContract.balanceOf(wallet);
                const sgbBalanceWei = await provider.getBalance(wallet);
                balance = parseFloat(ethers.utils.formatEther(bakeBalance));
                sgbBalance = parseFloat(ethers.utils.formatEther(sgbBalanceWei));
                walletBtn.textContent = '‚úì Connected'; walletBtn.className = 'wallet-btn wallet-connected';
                document.getElementById('lpBanner').style.display = 'none';
                document.getElementById('walletBanner').style.display = 'block';
                document.getElementById('walletAddrBanner').textContent = wallet.substr(0, 6) + '...' + wallet.substr(-4);
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                document.getElementById('gameCredits').textContent = gameCredits;
                document.getElementById('gameSetup').style.display = 'block';
                document.getElementById('marketplaceWalletWarning').style.display = 'none';
                if (gameCredits > 0) { document.getElementById('existingCredits').style.display = 'block'; document.getElementById('existingCreditsCount').textContent = gameCredits; }
            } catch (error) { showCustomModal('‚ùå Connection Failed', error.message); walletBtn.disabled = false; walletBtn.innerHTML = 'üîó Connect Wallet'; }
        }
        
        function adjustCredits(delta) {
            const input = document.getElementById('creditsToBuy');
            let val = Math.max(1, Math.min(100, (parseInt(input.value) || 1) + delta));
            input.value = val;
            document.getElementById('creditCost').textContent = val;
        }
        
        async function buyCredits() {
            username = document.getElementById('username').value.trim().toUpperCase();
            if (!username) { showCustomModal('‚ö†Ô∏è Username Required', 'Please enter a username'); return; }
            if (!wallet) { showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect your wallet first'); return; }
            const creditsToBuy = parseInt(document.getElementById('creditsToBuy').value) || 1;
            if (sgbBalance < creditsToBuy) { showCustomModal('‚ö†Ô∏è Insufficient SGB', `You need ${creditsToBuy} SGB`); return; }
            const payBtn = document.getElementById('payEntryBtn');
            try {
                const confirmed = await showCustomModal('üí∞ Buy Credits', `Buy ${creditsToBuy} credit${creditsToBuy > 1 ? 's' : ''} for ${creditsToBuy} SGB?`, [{text: 'Buy & Play'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                payBtn.disabled = true; payBtn.innerHTML = '‚è≥ Processing...';
                const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: ethers.utils.parseEther(creditsToBuy.toString()) });
                await tx.wait();
                gameCredits += creditsToBuy;
                document.getElementById('gameCredits').textContent = gameCredits;
                sgbBalance -= creditsToBuy;
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                document.getElementById('gameSetup').style.display = 'none';
                document.getElementById('vehicleSelect').style.display = 'block';
            } catch (error) { showCustomModal('‚ùå Failed', error.message); payBtn.disabled = false; payBtn.innerHTML = 'üí∏ BUY CREDITS & PLAY'; }
        }
        
        function startWithExistingCredits() {
            username = document.getElementById('username').value.trim().toUpperCase();
            if (!username) { showCustomModal('‚ö†Ô∏è Username Required', 'Please enter a username'); return; }
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('vehicleSelect').style.display = 'block';
        }
        
        function selectVehicleType(type, hp, dmg) {
            selectedVehicle = { type, hp, dmg };
            gameCredits--;
            document.getElementById('gameCredits').textContent = gameCredits;
            document.getElementById('creditsDisplay').textContent = gameCredits;
            document.getElementById('vehicleSelect').style.display = 'none';
            startGame(type, hp, dmg);
        }
        
        function startGame(type, hp, dmg) {
            document.getElementById('gameArea').style.display = 'block';
            canvas = document.getElementById('gameCanvas');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            canvas.logicalWidth = window.innerWidth;
            canvas.logicalHeight = window.innerHeight;
            document.getElementById('playerName').textContent = username;
            document.getElementById('playerHP').textContent = hp;
            document.getElementById('playerMaxHP').textContent = hp;
            document.getElementById('creditsDisplay').textContent = gameCredits;
            updateTacticalsDisplay();
            initializeGame(type, hp, dmg);
            showSarahMessage('start');
        }
        
        function updateTacticalsDisplay() {
            const display = document.getElementById('tacticalsDisplay');
            if (!inventory.tacticals.length) { display.innerHTML = '<div style="font-size: 14px; color: #64748b;">No tacticals</div>'; return; }
            const names = {'orbital':'üõ∏ Orbital','timeslow':'‚è±Ô∏è Time Slow','turret':'üî´ Turret','airstrike':'‚úàÔ∏è Airstrike','shield':'üõ°Ô∏è Shield','emp':'üí£ EMP','heal':'‚ù§Ô∏è Heal','decoy':'üëª Decoy'};
            let html = '<div style="font-size: 14px; color: #a855f7; margin-bottom: 5px;">TACTICALS:</div>';
            inventory.tacticals.forEach((t, i) => { html += `<div style="font-size: 13px; color: #94a3b8; margin: 3px 0;">[${i+1}] ${names[t] || t}</div>`; });
            display.innerHTML = html;
        }
        
        function initializeGame(type, hp, dmg) {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            walls = [{x:150,y:100,width:120,height:25},{x:w-280,y:180,width:90,height:30},{x:100,y:h-300,width:140,height:20},{x:w-250,y:h-280,width:100,height:35},{x:300,y:h/2-80,width:80,height:80},{x:w-400,y:h/2+30,width:90,height:60}];
            pickups = [{x:200,y:200,type:'health',icon:'üíö',active:true},{x:w-200,y:200,type:'damage',icon:'üí•',active:true},{x:200,y:h-300,type:'speed',icon:'‚ö°',active:true},{x:w-200,y:h-300,type:'shield',icon:'üõ°Ô∏è',active:true}];
            let playerColor = '#10b981';
            if (inventory.skins.includes('gold')) playerColor = '#fbbf24';
            else if (inventory.skins.includes('chrome')) playerColor = '#e5e7eb';
            player = {x:w/2,y:h/2,vx:0,vy:0,angle:0,hp:hp,maxHp:hp,damage:dmg,baseDamage:dmg,size:25,vehicleType:type,color:playerColor,speed:4,baseSpeed:4,shield:false,shieldTime:0,tacticalCooldowns:new Array(inventory.tacticals.length).fill(0)};
            enemies = []; explosions = [];
            const usedNames = [];
            for (let i = 0; i < 7; i++) {
                let name; do { name = PLAYER_NAMES[Math.floor(Math.random() * PLAYER_NAMES.length)]; } while (usedNames.includes(name));
                usedNames.push(name);
                spawnEnemy(name, i);
            }
            bullets = []; keys = {}; kills = 0; streak = 0; pot = 10000; aliveCount = 8; gameStartTime = Date.now(); lives = 5;
            document.getElementById('livesCount').textContent = lives;
            document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString();
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            gameLoop = setInterval(update, 1000/60);
        }
        
        function handleKeyDown(e) { keys[e.key.toLowerCase()] = true; }
        function handleKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        
        function spawnEnemy(name, index) {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            const edge = Math.floor(Math.random() * 4);
            let x, y;
            if (edge === 0) { x = Math.random() * w; y = -40; }
            else if (edge === 1) { x = w + 40; y = Math.random() * h; }
            else if (edge === 2) { x = Math.random() * w; y = h + 40; }
            else { x = -40; y = Math.random() * h; }
            const hpVal = 200 + Math.random() * 200; // MORE HP
            const vehicle = ENEMY_VEHICLES[index % ENEMY_VEHICLES.length];
            enemies.push({x,y,vx:0,vy:0,hp:hpVal,maxHp:hpVal,damage:20+Math.random()*20,size:Math.max(vehicle.width,vehicle.height)/2,width:vehicle.width,height:vehicle.height,vehicleType:vehicle.type,color:vehicle.color,name,speed:1.5+Math.random(),shootCooldown:Math.random()*60,lives:5,lastX:x,lastY:y});
        }
        
        function handleMouseMove(e) { const rect = canvas.getBoundingClientRect(); mouse.x = (e.clientX - rect.left) * (canvas.logicalWidth / rect.width); mouse.y = (e.clientY - rect.top) * (canvas.logicalHeight / rect.height); }
        function handleMouseDown() { mouse.clicked = true; }
        function handleMouseUp() { mouse.clicked = false; }
        
        function shoot() {
            const dx = mouse.x - player.x, dy = mouse.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 0) bullets.push({x:player.x,y:player.y,vx:(dx/dist)*12,vy:(dy/dist)*12,damage:player.damage,isPlayer:true,size:5});
        }
        
        function checkWallCollision(obj, newX, newY) {
            for (let wall of walls) { if (newX - obj.size < wall.x + wall.width && newX + obj.size > wall.x && newY - obj.size < wall.y + wall.height && newY + obj.size > wall.y) return true; }
            return false;
        }
        
        function resolveEnemyCollisions() {
            for (let i = 0; i < enemies.length; i++) {
                for (let j = i + 1; j < enemies.length; j++) {
                    const e1 = enemies[i], e2 = enemies[j];
                    const dx = e2.x - e1.x, dy = e2.y - e1.y, dist = Math.sqrt(dx*dx + dy*dy), minDist = e1.size + e2.size + 5;
                    if (dist < minDist && dist > 0) { const overlap = minDist - dist; e1.x -= (dx/dist)*overlap*0.5; e1.y -= (dy/dist)*overlap*0.5; e2.x += (dx/dist)*overlap*0.5; e2.y += (dy/dist)*overlap*0.5; }
                }
            }
        }
        
        function triggerOrbitalStrike() {
            const overlay = document.getElementById('strikeOverlay');
            overlay.style.display = 'block';
            overlay.style.background = 'radial-gradient(circle at center, rgba(255,100,100,0.8), transparent 70%)';
            const container = document.getElementById('gameContainer');
            let shakeCount = 0;
            const shakeInterval = setInterval(() => { container.style.transform = `translate(${(Math.random()-0.5)*20}px, ${(Math.random()-0.5)*20}px)`; if (++shakeCount > 20) { clearInterval(shakeInterval); container.style.transform = ''; } }, 50);
            enemies.forEach(e => { explosions.push({x:e.x,y:e.y,radius:10,maxRadius:80,color:'#ef4444',alpha:1}); });
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
        }
        
        function triggerAirstrike() {
            const overlay = document.getElementById('strikeOverlay');
            overlay.style.display = 'block';
            let bombCount = 0;
            const bombInterval = setInterval(() => {
                const x = Math.random() * canvas.logicalWidth, y = Math.random() * canvas.logicalHeight;
                explosions.push({x,y,radius:20,maxRadius:100,color:'#f97316',alpha:1});
                overlay.style.background = `radial-gradient(circle at ${x/canvas.logicalWidth*100}% ${y/canvas.logicalHeight*100}%, rgba(255,150,0,0.9), transparent 50%)`;
                if (++bombCount > 8) { clearInterval(bombInterval); setTimeout(() => { overlay.style.display = 'none'; }, 200); }
            }, 100);
            const container = document.getElementById('gameContainer');
            let shakeCount = 0;
            const shakeInterval = setInterval(() => { container.style.transform = `translate(${(Math.random()-0.5)*15}px, ${(Math.random()-0.5)*15}px)`; if (++shakeCount > 30) { clearInterval(shakeInterval); container.style.transform = ''; } }, 40);
        }
        
        function update() {
            gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            document.getElementById('gameTime').textContent = `${Math.floor(gameTime / 60)}:${(gameTime % 60).toString().padStart(2, '0')}`;
            for (let i = 0; i < player.tacticalCooldowns.length; i++) if (player.tacticalCooldowns[i] > 0) player.tacticalCooldowns[i]--;
            
            // Tactical activation - ALL owned tacticals
            for (let slot = 0; slot < inventory.tacticals.length; slot++) {
                const key = (slot + 1).toString();
                if (keys[key] && player.tacticalCooldowns[slot] === 0 && inventory.tacticals[slot]) {
                    const tactical = inventory.tacticals[slot];
                    keys[key] = false;
                    const notif = document.getElementById('killNotif');
                    if (tactical === 'orbital') { enemies.forEach(e => e.hp -= 300); player.tacticalCooldowns[slot] = 600; triggerOrbitalStrike(); notif.innerHTML = 'üõ∏ ORBITAL STRIKE!'; notif.style.display = 'block'; notif.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(185, 28, 28, 0.95))'; setTimeout(() => { notif.style.display = 'none'; notif.style.background = ''; }, 2000); }
                    else if (tactical === 'airstrike') { enemies.forEach(e => e.hp -= 250); player.tacticalCooldowns[slot] = 720; triggerAirstrike(); notif.innerHTML = '‚úàÔ∏è AIRSTRIKE INBOUND!'; notif.style.display = 'block'; notif.style.background = 'linear-gradient(135deg, rgba(249, 115, 22, 0.95), rgba(194, 65, 12, 0.95))'; setTimeout(() => { notif.style.display = 'none'; notif.style.background = ''; }, 2000); }
                    else if (tactical === 'shield') { player.shield = true; player.shieldTime = 600; player.tacticalCooldowns[slot] = 540; notif.innerHTML = 'üõ°Ô∏è SHIELD ACTIVE!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'heal') { const oldHp = player.hp; player.hp = Math.min(player.maxHp, player.hp + 100); document.getElementById('playerHP').textContent = Math.floor(player.hp); player.tacticalCooldowns[slot] = 360; notif.innerHTML = `‚ù§Ô∏è HEALED +${Math.floor(player.hp - oldHp)} HP`; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'emp') { enemies.forEach(e => { const orig = e.speed; e.speed *= 0.2; setTimeout(() => e.speed = orig, 5000); }); player.tacticalCooldowns[slot] = 270; notif.innerHTML = 'üí£ EMP BLAST!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'turret') { const turret = {x:player.x+80,y:player.y-80,active:true,cooldown:0}; activeTurrets.push(turret); const ti = setInterval(() => { if (!turret.active) { clearInterval(ti); return; } turret.cooldown--; if (turret.cooldown <= 0) { enemies.forEach(e => { const dx = e.x - turret.x, dy = e.y - turret.y, dist = Math.sqrt(dx*dx+dy*dy); if (dist < 400) { e.hp -= 20; bullets.push({x:turret.x,y:turret.y,vx:(dx/dist)*12,vy:(dy/dist)*12,damage:0,isPlayer:true,size:5,color:'#fbbf24'}); } }); turret.cooldown = 30; } }, 1000/60); setTimeout(() => { turret.active = false; activeTurrets.splice(activeTurrets.indexOf(turret), 1); }, 10000); player.tacticalCooldowns[slot] = 360; notif.innerHTML = 'üî´ TURRET DEPLOYED!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'timeslow') { const orig = player.speed; player.speed *= 2.5; setTimeout(() => player.speed = orig, 8000); player.tacticalCooldowns[slot] = 900; notif.innerHTML = '‚è±Ô∏è TIME DISTORTION!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 1500); }
                    else if (tactical === 'decoy') { enemies.forEach(e => { e.confusedUntil = Date.now() + 5000; }); player.tacticalCooldowns[slot] = 180; notif.innerHTML = 'üëª DECOY!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                }
            }
            
            if (mouse.clicked && Math.random() < 0.3) shoot();
            if (player.shield) { player.shieldTime--; if (player.shieldTime <= 0) player.shield = false; }
            explosions = explosions.filter(exp => { exp.radius += 5; exp.alpha -= 0.05; return exp.alpha > 0; });
            
            // Pickup collisions
            pickups.forEach(pickup => {
                if (!pickup.active) return;
                const dx = player.x - pickup.x, dy = player.y - pickup.y;
                if (Math.sqrt(dx*dx + dy*dy) < player.size + 20) {
                    pickup.active = false;
                    if (pickup.type === 'health') { player.hp = Math.min(player.maxHp, player.hp + 50); document.getElementById('playerHP').textContent = Math.floor(player.hp); showSarahMessage('pickup_health'); }
                    else if (pickup.type === 'damage') { player.damage = player.baseDamage * 2; showSarahMessage('pickup_damage'); setTimeout(() => player.damage = player.baseDamage, 10000); }
                    else if (pickup.type === 'speed') { player.speed = player.baseSpeed * 1.5; setTimeout(() => player.speed = player.baseSpeed, 8000); }
                    else if (pickup.type === 'shield') { player.shield = true; player.shieldTime = 300; }
                    setTimeout(() => pickup.active = true, 20000);
                }
            });
            
            // Player movement
            let newX = player.x, newY = player.y;
            if (keys['w'] || keys['arrowup']) newY -= player.speed;
            if (keys['s'] || keys['arrowdown']) newY += player.speed;
            if (keys['a'] || keys['arrowleft']) newX -= player.speed;
            if (keys['d'] || keys['arrowright']) newX += player.speed;
            if (!checkWallCollision(player, newX, player.y)) player.x = Math.max(player.size, Math.min(canvas.logicalWidth - player.size, newX));
            if (!checkWallCollision(player, player.x, newY)) player.y = Math.max(player.size, Math.min(canvas.logicalHeight - player.size, newY));
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            
            // Enemy AI with collision fix
            enemies.forEach((enemy, index) => {
                enemy.lastX = enemy.x; enemy.lastY = enemy.y;
                if (enemy.confusedUntil && Date.now() < enemy.confusedUntil) { enemy.x += (Math.random() - 0.5) * enemy.speed * 2; enemy.y += (Math.random() - 0.5) * enemy.speed * 2; }
                else {
                    if (!enemy.target || Math.random() < 0.01) { enemy.target = Math.random() < 0.8 && enemies.length > 1 ? enemies.filter((_, i) => i !== index)[Math.floor(Math.random() * (enemies.length - 1))] : player; }
                    const dx = enemy.target.x - enemy.x, dy = enemy.target.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist > 0) { let nx = enemy.x + (dx/dist) * enemy.speed, ny = enemy.y + (dy/dist) * enemy.speed; if (!checkWallCollision(enemy, nx, enemy.y)) enemy.x = nx; if (!checkWallCollision(enemy, enemy.x, ny)) enemy.y = ny; }
                }
                enemy.shootCooldown--;
                const targetDx = (enemy.target ? enemy.target.x : player.x) - enemy.x, targetDy = (enemy.target ? enemy.target.y : player.y) - enemy.y, targetDist = Math.sqrt(targetDx*targetDx + targetDy*targetDy);
                if (enemy.shootCooldown <= 0 && targetDist < 400) { if (targetDist > 0) bullets.push({x:enemy.x,y:enemy.y,vx:(targetDx/targetDist)*10,vy:(targetDy/targetDist)*10,damage:enemy.damage,isPlayer:false,owner:enemy,size:4}); enemy.shootCooldown = 40 + Math.random() * 40; }
            });
            resolveEnemyCollisions();
            
            // Bullet updates
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx; bullet.y += bullet.vy;
                for (let wall of walls) { if (bullet.x > wall.x && bullet.x < wall.x + wall.width && bullet.y > wall.y && bullet.y < wall.y + wall.height) return false; }
                if (bullet.isPlayer) {
                    for (let i = enemies.length - 1; i >= 0; i--) {
                        const enemy = enemies[i];
                        const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y;
                        if (Math.sqrt(dx*dx + dy*dy) < enemy.size) {
                            enemy.hp -= bullet.damage;
                            if (enemy.hp <= 0) {
                                enemy.lives--;
                                if (enemy.lives > 0) { enemy.hp = 200 + Math.random() * 200; enemy.maxHp = enemy.hp; const edge = Math.floor(Math.random() * 4); if (edge === 0) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = -40; } else if (edge === 1) { enemy.x = canvas.logicalWidth + 40; enemy.y = Math.random() * canvas.logicalHeight; } else if (edge === 2) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = canvas.logicalHeight + 40; } else { enemy.x = -40; enemy.y = Math.random() * canvas.logicalHeight; } }
                                else { explosions.push({x:enemy.x,y:enemy.y,radius:10,maxRadius:60,color:enemy.color,alpha:1}); enemies.splice(i, 1); aliveCount--; document.getElementById('aliveCount').textContent = aliveCount; }
                                kills++; streak++; balance += 100; pot += 1000;
                                document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString();
                                document.getElementById('currentPot').textContent = pot.toLocaleString();
                                const notif = document.getElementById('killNotif'); notif.innerHTML = 'üéØ KILL! +100 BAKE'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 1500);
                                document.getElementById('killCount').textContent = kills; document.getElementById('streakCount').textContent = streak;
                                if (kills === 1) showSarahMessage('kill1'); else if (kills === 3 || kills === 5 || kills === 10) { balance += 500; pot += 5000; showSarahMessage('kill' + kills); }
                                if (aliveCount === 2) showSarahMessage('lastStanding');
                                if (aliveCount === 1) endGame(true);
                            }
                            return false;
                        }
                    }
                } else {
                    const dxP = bullet.x - player.x, dyP = bullet.y - player.y;
                    if (Math.sqrt(dxP*dxP + dyP*dyP) < player.size) {
                        if (!player.shield) { player.hp -= bullet.damage * 0.5; streak = 0; document.getElementById('playerHP').textContent = Math.max(0, Math.floor(player.hp)); document.getElementById('streakCount').textContent = 0; if (player.hp < player.maxHp * 0.3) showSarahMessage('lowHP'); if (player.hp <= 0) { lives--; document.getElementById('livesCount').textContent = lives; handlePlayerDeath(); } }
                        return false;
                    }
                    for (let i = enemies.length - 1; i >= 0; i--) { const enemy = enemies[i]; if (bullet.owner === enemy) continue; const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y; if (Math.sqrt(dx*dx + dy*dy) < enemy.size) { enemy.hp -= bullet.damage * 0.5; if (enemy.hp <= 0) { enemies.splice(i, 1); aliveCount--; document.getElementById('aliveCount').textContent = aliveCount; if (aliveCount === 1) endGame(true); } return false; } }
                }
                return bullet.x > 0 && bullet.x < canvas.logicalWidth && bullet.y > 0 && bullet.y < canvas.logicalHeight;
            });
            draw();
        }
        
        async function handlePlayerDeath() {
            clearInterval(gameLoop);
            if (lives > 0) {
                showSarahMessage('respawn');
                await showInGameModal('üíÄ YOU DIED!', `Lives remaining: ${lives}/5\n\nRespawning...`, [{text: 'OK', color: 'linear-gradient(135deg,#fbbf24,#f59e0b)'}]);
                respawnPlayer();
            } else { handleOutOfLives(); }
        }
        
        async function handleOutOfLives() {
            totalKills += kills;
            if (gameCredits > 0) {
                const choice = await showInGameModal('üíÄ OUT OF LIVES!', `Total Kills: ${totalKills}\nYou have ${gameCredits} credits!\n\nUse 1 credit to continue?`, [{text: `‚ñ∂Ô∏è USE CREDIT (${gameCredits} left)`, color: 'linear-gradient(135deg,#22c55e,#16a34a)'}, {text: 'üö™ EXIT', color: 'linear-gradient(135deg,#ef4444,#dc2626)'}]);
                if (choice === 0) { gameCredits--; document.getElementById('gameCredits').textContent = gameCredits; document.getElementById('creditsDisplay').textContent = gameCredits; lives = 5; document.getElementById('livesCount').textContent = lives; respawnPlayer(); }
                else { exitGame(); }
            } else {
                const choice = await showInGameModal('üíÄ OUT OF LIVES!', `Total Kills: ${totalKills}\nNo credits remaining!\n\nBuy more to continue?`, [{text: 'üí∞ BUY 1 CREDIT (1 SGB)', color: 'linear-gradient(135deg,#22c55e,#16a34a)'}, {text: 'üí∞ BUY 5 CREDITS (5 SGB)', color: 'linear-gradient(135deg,#3b82f6,#2563eb)'}, {text: 'üö™ EXIT', color: 'linear-gradient(135deg,#ef4444,#dc2626)'}]);
                if (choice === 0) await buyCreditsInGame(1);
                else if (choice === 1) await buyCreditsInGame(5);
                else exitGame();
            }
        }
        
        async function buyCreditsInGame(amount) {
            if (!wallet) { await showInGameModal('‚ö†Ô∏è Error', 'Wallet not connected!', [{text: 'OK'}]); exitGame(); return; }
            try {
                const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: ethers.utils.parseEther(amount.toString()) });
                await tx.wait();
                gameCredits += amount;
                sgbBalance -= amount;
                document.getElementById('gameCredits').textContent = gameCredits;
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                gameCredits--; document.getElementById('gameCredits').textContent = gameCredits; document.getElementById('creditsDisplay').textContent = gameCredits;
                lives = 5; document.getElementById('livesCount').textContent = lives;
                await showInGameModal('‚úÖ Success!', `Bought ${amount} credits!\n\nContinuing...`, [{text: 'PLAY!', color: 'linear-gradient(135deg,#22c55e,#16a34a)'}]);
                respawnPlayer();
            } catch (error) { await showInGameModal('‚ùå Failed', error.message, [{text: 'OK'}]); handleOutOfLives(); }
        }
        
        function exitGame() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameSetup').style.display = 'block';
            if (gameCredits > 0) { document.getElementById('existingCredits').style.display = 'block'; document.getElementById('existingCreditsCount').textContent = gameCredits; }
            else { document.getElementById('existingCredits').style.display = 'none'; }
            const payBtn = document.getElementById('payEntryBtn'); payBtn.disabled = false; payBtn.innerHTML = 'üí∏ BUY CREDITS & PLAY';
        }
        
        function respawnPlayer() {
            player.x = canvas.logicalWidth / 2; player.y = canvas.logicalHeight / 2;
            player.hp = player.maxHp; player.vx = 0; player.vy = 0; player.shield = false; player.shieldTime = 0;
            document.getElementById('playerHP').textContent = player.maxHp;
            showSarahMessage('start');
            gameLoop = setInterval(update, 1000/60);
        }
        
        function draw() {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            ctx.fillStyle = '#0a0e1a'; ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#1a1f2e'; ctx.lineWidth = 1;
            for (let i = 0; i < w; i += 40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); }
            for (let i = 0; i < h; i += 40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); }
            ctx.fillStyle = '#334155'; ctx.strokeStyle = '#475569'; ctx.lineWidth = 2;
            walls.forEach(wall => { ctx.fillRect(wall.x, wall.y, wall.width, wall.height); ctx.strokeRect(wall.x, wall.y, wall.width, wall.height); });
            pickups.forEach(pickup => { if (!pickup.active) return; ctx.save(); ctx.translate(pickup.x, pickup.y); ctx.fillStyle = 'rgba(251, 191, 36, 0.3)'; ctx.beginPath(); ctx.arc(0, 0, 25 + Math.sin(Date.now() / 200) * 5, 0, Math.PI * 2); ctx.fill(); ctx.font = '32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(pickup.icon, 0, 0); ctx.restore(); });
            explosions.forEach(exp => { ctx.save(); ctx.globalAlpha = exp.alpha; ctx.fillStyle = exp.color; ctx.beginPath(); ctx.arc(exp.x, exp.y, exp.radius, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 3; ctx.stroke(); ctx.restore(); });
            
            // Draw enemies with shapes
            enemies.forEach(enemy => {
                ctx.save(); ctx.translate(enemy.x, enemy.y);
                ctx.fillStyle = enemy.color; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2;
                switch (enemy.vehicleType) {
                    case 'rectangle': ctx.fillRect(-enemy.width/2, -enemy.height/2, enemy.width, enemy.height); ctx.strokeRect(-enemy.width/2, -enemy.height/2, enemy.width, enemy.height); break;
                    case 'square': ctx.fillRect(-enemy.width/2, -enemy.height/2, enemy.width, enemy.height); ctx.strokeRect(-enemy.width/2, -enemy.height/2, enemy.width, enemy.height); break;
                    case 'diamond': ctx.beginPath(); ctx.moveTo(0, -enemy.height/2); ctx.lineTo(enemy.width/2, 0); ctx.lineTo(0, enemy.height/2); ctx.lineTo(-enemy.width/2, 0); ctx.closePath(); ctx.fill(); ctx.stroke(); break;
                    case 'hexagon': ctx.beginPath(); for (let i = 0; i < 6; i++) { const angle = (i * Math.PI / 3) - Math.PI / 6; const x = Math.cos(angle) * enemy.width/2, y = Math.sin(angle) * enemy.height/2; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.closePath(); ctx.fill(); ctx.stroke(); break;
                    case 'triangle': ctx.beginPath(); ctx.moveTo(0, -enemy.height/2); ctx.lineTo(enemy.width/2, enemy.height/2); ctx.lineTo(-enemy.width/2, enemy.height/2); ctx.closePath(); ctx.fill(); ctx.stroke(); break;
                    case 'oval': ctx.beginPath(); ctx.ellipse(0, 0, enemy.width/2, enemy.height/2, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); break;
                    case 'pentagon': ctx.beginPath(); for (let i = 0; i < 5; i++) { const angle = (i * 2 * Math.PI / 5) - Math.PI / 2; const x = Math.cos(angle) * enemy.width/2, y = Math.sin(angle) * enemy.height/2; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.closePath(); ctx.fill(); ctx.stroke(); break;
                    case 'trapezoid': ctx.beginPath(); ctx.moveTo(-enemy.width/3, -enemy.height/2); ctx.lineTo(enemy.width/3, -enemy.height/2); ctx.lineTo(enemy.width/2, enemy.height/2); ctx.lineTo(-enemy.width/2, enemy.height/2); ctx.closePath(); ctx.fill(); ctx.stroke(); break;
                }
                ctx.fillStyle = '#ffffff'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(enemy.name, 0, 0);
                const barWidth = 50, hpPercent = enemy.hp / enemy.maxHp;
                ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -Math.max(enemy.width, enemy.height)/2 - 15, barWidth, 5);
                ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444';
                ctx.fillRect(-barWidth/2, -Math.max(enemy.width, enemy.height)/2 - 15, barWidth * hpPercent, 5);
                ctx.restore();
            });
            
            // Turrets
            activeTurrets.forEach(turret => { if (!turret.active) return; ctx.fillStyle = '#ef4444'; ctx.fillRect(turret.x - 25, turret.y - 25, 50, 50); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 4; ctx.strokeRect(turret.x - 25, turret.y - 25, 50, 50); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('üî´', turret.x, turret.y); });
            
            // Player
            ctx.save(); ctx.translate(player.x, player.y);
            if (player.shield) { ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0, 0, 35 + Math.sin(Date.now() / 100) * 3, 0, Math.PI * 2); ctx.stroke(); }
            ctx.rotate(player.angle);
            ctx.fillStyle = player.color; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2;
            switch (player.vehicleType) {
                case 'tank': ctx.fillRect(-15, -10, 30, 20); ctx.strokeRect(-15, -10, 30, 20); ctx.fillRect(5, -3, 15, 6); break;
                case 'sports': ctx.beginPath(); ctx.ellipse(0, 0, 18, 10, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); break;
                case 'truck': ctx.fillRect(-14, -12, 28, 24); ctx.strokeRect(-14, -12, 28, 24); break;
            }
            ctx.rotate(-player.angle);
            ctx.fillStyle = '#ffffff'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(username, 0, 0);
            const barWidth = 50, hpPercent = player.hp / player.maxHp;
            ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -player.size - 12, barWidth, 5);
            ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444';
            ctx.fillRect(-barWidth/2, -player.size - 12, barWidth * hpPercent, 5);
            ctx.restore();
            
            bullets.forEach(bullet => { ctx.fillStyle = bullet.color || (bullet.isPlayer ? '#3b82f6' : '#ef4444'); ctx.beginPath(); ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2); ctx.fill(); });
        }
        
        function endGame(won) {
            clearInterval(gameLoop);
            canvas.removeEventListener('mousemove', handleMouseMove);
            canvas.removeEventListener('mousedown', handleMouseDown);
            canvas.removeEventListener('mouseup', handleMouseUp);
            window.removeEventListener('keydown', handleKeyDown);
            window.removeEventListener('keyup', handleKeyUp);
            if (won) {
                showSarahMessage('victory');
                balance += pot; totalKills += kills;
                document.getElementById('walletBalBanner').textContent = balance.toLocaleString();
                leaderboard.push({ name: username, bake: pot, kills, date: new Date().toISOString() });
                leaderboard.sort((a, b) => b.bake - a.bake);
                leaderboard = leaderboard.slice(0, 20);
                localStorage.setItem('bakeLeaderboard', JSON.stringify(leaderboard));
                setTimeout(async () => {
                    if (gameCredits > 0) {
                        const choice = await showInGameModal('üèÜ VICTORY!', `Won ${pot.toLocaleString()} BAKE!\nKills: ${kills}\nCredits: ${gameCredits}`, [{text: '‚ñ∂Ô∏è PLAY AGAIN', color: 'linear-gradient(135deg,#22c55e,#16a34a)'}, {text: 'üö™ EXIT', color: 'linear-gradient(135deg,#64748b,#475569)'}]);
                        if (choice === 0) { lives = 5; totalKills = 0; document.getElementById('gameArea').style.display = 'none'; document.getElementById('vehicleSelect').style.display = 'block'; }
                        else exitGame();
                    } else {
                        const choice = await showInGameModal('üèÜ VICTORY!', `Won ${pot.toLocaleString()} BAKE!\nKills: ${kills}\nNo credits. Buy more?`, [{text: 'üí∞ BUY 1 CREDIT', color: 'linear-gradient(135deg,#22c55e,#16a34a)'}, {text: 'üö™ EXIT', color: 'linear-gradient(135deg,#64748b,#475569)'}]);
                        if (choice === 0) { await buyCreditsInGame(1); document.getElementById('gameArea').style.display = 'none'; document.getElementById('vehicleSelect').style.display = 'block'; }
                        else exitGame();
                    }
                }, 2000);
            }
        }
        
        function showCategory(category) {
            document.querySelectorAll('.category-tab-btn').forEach(btn => { btn.style.borderColor = '#334155'; btn.style.background = 'rgba(30, 41, 59, 0.8)'; });
            event.target.style.borderColor = '#ec4899'; event.target.style.background = 'rgba(236, 72, 153, 0.2)';
            const items = MARKETPLACE[category];
            const container = document.getElementById('marketplaceItems');
            const rarityColors = { legendary: '#fbbf24', epic: '#a855f7', rare: '#3b82f6', common: '#94a3b8' };
            container.innerHTML = items.map(item => {
                const owned = inventory[category].includes(item.id);
                return `<div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid ${owned ? '#22c55e' : '#334155'}; padding: 20px; border-radius: 12px; cursor: ${owned ? 'default' : 'pointer'}; text-align: center; ${owned ? 'opacity: 0.7;' : ''}" onclick="${owned ? '' : `buyItem('${category}', '${item.id}', ${item.price}, '${item.name}')`}">
                    <div style="height: 80px; display: flex; align-items: center; justify-content: center; font-size: 48px; margin-bottom: 15px;">${item.icon}</div>
                    <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px; color: ${rarityColors[item.rarity]};">${item.rarity.toUpperCase()}</div>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${item.name}</div>
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 10px;">${item.desc}</div>
                    <div style="font-size: 20px; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">${item.price.toLocaleString()} BAKE</div>
                    <button style="background: ${owned ? '#22c55e' : 'linear-gradient(135deg, #ec4899, #d946ef)'}; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: bold; cursor: ${owned ? 'default' : 'pointer'}; width: 100%;">${owned ? '‚úì OWNED' : 'BUY NOW'}</button>
                </div>`;
            }).join('');
        }
        
        function buyItem(category, itemId, price, name) {
            if (!wallet) { showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect your wallet first'); return; }
            if (inventory[category].includes(itemId)) return;
            if (balance < price) { showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${price.toLocaleString()} BAKE\nYour balance: ${balance.toLocaleString()} BAKE`); return; }
            showCustomModal('üí∞ Confirm Purchase', `Purchase ${name} for ${price.toLocaleString()} BAKE?`, [{text: 'Purchase', onClick: () => {
                balance -= price;
                document.getElementById('walletBalBanner').textContent = balance.toLocaleString();
                inventory[category].push(itemId);
                showCustomModal('‚úÖ Purchase Successful!', `${name} is now yours!`);
                showCategory(category);
            }}, {text: 'Cancel'}]);
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'leaderboard') updateLeaderboard();
            if (tab === 'marketplace') showCategory('tacticals');
        }
        
        function updateLeaderboard() {
            const list = document.getElementById('leaderboardList');
            if (!leaderboard.length) { list.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No games played yet.</div>'; return; }
            list.innerHTML = leaderboard.map((entry, i) => `<div style="display: flex; justify-content: space-between; padding: 10px; margin: 5px 0; background: ${i < 3 ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2))' : 'rgba(15, 23, 42, 0.5)'}; border-radius: 8px; ${i < 3 ? 'border: 1px solid #fbbf24;' : ''}"><span style="color: ${i === 0 ? '#fbbf24' : i === 1 ? '#94a3b8' : i === 2 ? '#c2410c' : '#64748b'};">${i + 1}. ${entry.name}</span><span style="color: #fbbf24;">${entry.bake.toLocaleString()} BAKE (${entry.kills} kills)</span></div>`).join('');
        }
        
        window.addEventListener('load', function() {
            updateLeaderboard();
            const creditsInput = document.getElementById('creditsToBuy');
            if (creditsInput) { creditsInput.addEventListener('input', function() { document.getElementById('creditCost').textContent = parseInt(this.value) || 1; }); }
        });
    </script>
</body>
</html>
