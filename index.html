<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAKE Arena - Play to Earn</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial Black', Arial, sans-serif;
            color: white;
            padding: 20px;
        }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.8); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { width: 100%; max-width: 1400px; background: rgba(15, 23, 42, 0.98); border-radius: 16px; border: 2px solid #334155; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; padding: 30px 20px 20px 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-bottom: 2px solid #334155; }
        .header h1 { font-size: clamp(32px, 5vw, 48px); background: linear-gradient(135deg, #38bdf8, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; }
        .header .tagline { color: #fbbf24; font-size: clamp(14px, 2vw, 16px); }
        .fomo-banner { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)); border-bottom: 2px solid #10b981; padding: 15px 20px; }
        .fomo-content { display: flex; justify-content: flex-start; align-items: center; flex-wrap: wrap; gap: 40px; }
        .fomo-stat { text-align: center; }
        .fomo-value { font-size: clamp(20px, 3vw, 28px); font-weight: bold; color: #10b981; }
        .fomo-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .price-ticker { font-size: clamp(18px, 2.5vw, 24px); color: #fbbf24; font-weight: bold; }
        .tabs { display: flex; background: rgba(30, 41, 59, 0.8); border-bottom: 2px solid #334155; overflow-x: auto; }
        .tab { flex: 1; min-width: 120px; padding: 15px 10px; text-align: center; cursor: pointer; border: none; background: transparent; color: #94a3b8; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: rgba(59, 130, 246, 0.1); color: #fff; }
        .tab.active { color: #38bdf8; border-bottom: 3px solid #38bdf8; background: rgba(59, 130, 246, 0.2); }
        .tab.marketplace-tab { background: linear-gradient(90deg, rgba(236, 72, 153, 0.6), rgba(168, 85, 247, 0.6), rgba(59, 130, 246, 0.6), rgba(236, 72, 153, 0.6)); background-size: 200% 200%; animation: rainbow 4s linear infinite; position: relative; overflow: hidden; }
        .tab.marketplace-tab::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        .tab.marketplace-tab .sparkle { position: absolute; top: 5px; right: 5px; font-size: 20px; animation: pulse 1s infinite; }
        .tab-content { display: none; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .wallet-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .wallet-btn:hover { transform: translateY(-2px); }
        .wallet-connected { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .leaderboard { background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .leaderboard-entry { display: flex; justify-content: space-between; padding: 10px; margin: 5px 0; background: rgba(15, 23, 42, 0.5); border-radius: 8px; }
        .leaderboard-entry.top { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 1px solid #fbbf24; }
    </style>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ BAKE ARENA</h1>
            <div class="tagline">üí∞ Play ‚Ä¢ Earn ‚Ä¢ Dominate</div>
        </div>
        
        <div id="walletBanner" class="fomo-banner" style="display: none;">
            <div class="fomo-content">
                <div class="fomo-stat">
                    <div style="color: #3b82f6; font-size: 16px; font-weight: bold;"><span id="walletAddrBanner"></span></div>
                    <div class="fomo-label">Wallet</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value" style="color: #fbbf24;"><span id="walletBalBanner">0</span></div>
                    <div class="fomo-label">Your BAKE</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value" style="color: #22c55e;"><span id="walletSGBBanner">0</span></div>
                    <div class="fomo-label">Your SGB</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value" style="color: #8b5cf6;"><span id="marketcapBanner">$0</span></div>
                    <div class="fomo-label">BAKE MCAP</div>
                </div>
            </div>
        </div>
        
        <div id="lpBanner" class="fomo-banner">
            <div class="fomo-content">
                <div style="font-size: 18px; font-weight: bold; color: #10b981;">BAKE LP STATS</div>
                <div class="fomo-stat">
                    <div class="price-ticker">$<span id="bakePriceUSD">0.000084</span></div>
                    <div class="fomo-label">BAKE Price</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value" style="color: #8b5cf6;">$<span id="marketcapLP">0</span></div>
                    <div class="fomo-label">Market Cap</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value" style="color: #22c55e;"><span id="priceChangePercent">+0.00</span>%</div>
                    <div class="fomo-label">24h Change</div>
                </div>
                <div class="fomo-stat">
                    <div class="fomo-value">$<span id="liquidityValue">324</span></div>
                    <div class="fomo-label">Liquidity</div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('play')">üéÆ PLAY</button>
            <button class="tab" onclick="switchTab('buy')">üí∞ BUY BAKE</button>
            <button class="tab" onclick="switchTab('pool')">üíß POOL</button>
            <button class="tab" onclick="switchTab('leaderboard')">üèÜ LEADERBOARD</button>
            <button class="tab marketplace-tab" onclick="switchTab('marketplace')">‚ú® MARKETPLACE<span class="sparkle">‚ú®</span></button>
        </div>
        
        <!-- PLAY TAB -->
        <div id="playTab" class="tab-content active">
            <div style="text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="walletBtn" class="wallet-btn" onclick="connectWallet()">üîó Connect Wallet</button>
                <button id="networkBtn" class="wallet-btn" onclick="addSongbirdNetwork()" style="background: linear-gradient(135deg, #f97316, #ea580c); display: none;">üåê Add Songbird Network</button>
                <button id="importTokenBtn" class="wallet-btn" onclick="importBAKEToken()" style="background: linear-gradient(135deg, #10b981, #059669); display: none;">‚ûï Add $BAKE to Metamask</button>
            </div>
            
            <div id="gameSetup" style="display: none;">
                <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #10b981; margin-bottom: 15px;">üéüÔ∏è ENTRY FEE: 1 SGB</h3>
                    <input type="text" id="username" placeholder="ENTER USERNAME" maxlength="8" style="width: 300px; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">
                    <button id="payEntryBtn" class="wallet-btn" onclick="selectVehicle()" style="background: linear-gradient(135deg, #10b981, #059669); display: block; margin: 0 auto;">üí∏ PAY 1 SGB & CHOOSE VEHICLE</button>
                </div>
            </div>
            
            <div id="vehicleSelect" style="display: none;">
                <h3 style="text-align: center; color: #38bdf8; margin-bottom: 15px;">CHOOSE YOUR VEHICLE</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div onclick="selectVehicleType('üöú', 230, 40)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="font-size: 48px;">üöú</div>
                        <div style="font-weight: bold; margin: 10px 0;">Tank</div>
                        <div style="font-size: 11px; color: #94a3b8;">HP: 230 ‚Ä¢ DMG: 40</div>
                    </div>
                    <div onclick="selectVehicleType('üèéÔ∏è', 92, 20)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="font-size: 48px;">üèéÔ∏è</div>
                        <div style="font-weight: bold; margin: 10px 0;">Sports Car</div>
                        <div style="font-size: 11px; color: #94a3b8;">HP: 92 ‚Ä¢ DMG: 20</div>
                    </div>
                    <div onclick="selectVehicleType('üöö', 161, 30)" style="background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="font-size: 48px;">üöö</div>
                        <div style="font-weight: bold; margin: 10px 0;">Truck</div>
                        <div style="font-size: 11px; color: #94a3b8;">HP: 161 ‚Ä¢ DMG: 30</div>
                    </div>
                </div>
            </div>
            
            <div id="marketplaceUpsell" style="display: none;">
                <h3 style="text-align: center; color: #ec4899; margin-bottom: 20px;">‚ö° NEED ANYTHING FROM THE MARKETPLACE?</h3>
                <p style="text-align: center; color: #94a3b8; margin-bottom: 25px;">Gear up before battle!</p>
                <div id="upsellItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="wallet-btn" onclick="switchTab('marketplace')" style="background: linear-gradient(135deg, #ec4899, #d946ef);">üõí Browse Marketplace</button>
                    <button class="wallet-btn" onclick="proceedToGame()" style="background: linear-gradient(135deg, #10b981, #059669);">‚ñ∂Ô∏è Continue to Game</button>
                </div>
            </div>
            
            <div id="gameArea" style="display: none;">
                <div id="gameContainer" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0a0e1a; z-index: 9999;">
                    <canvas id="gameCanvas" style="width: 100%; height: 100%;"></canvas>
                    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); padding: 20px 40px; border-radius: 16px; border: 3px solid #fbbf24;">
                        <div style="font-size: 14px; color: #78350f; text-align: center; margin-bottom: 5px;">üí∞ PRIZE POT</div>
                        <div style="font-size: 36px; font-weight: bold; color: #ffffff; text-align: center;"><span id="currentPot">10000</span> BAKE</div>
                    </div>
                    <div id="killNotif" style="position: absolute; top: 120px; left: 50%; transform: translateX(-50%); display: none; background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95)); padding: 15px 30px; border-radius: 12px; border: 2px solid #22c55e; font-size: 24px; font-weight: bold;"></div>
                    <div style="position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155;">
                        <div style="font-size: 18px; margin: 5px 0; color: #ef4444;">‚ù§Ô∏è <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #10b981;">üíö Lives: <span id="livesCount">5</span>/5</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">üç∞ <span id="playerBAKE">0</span> BAKE</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #22c55e;">üèÜ <span id="killCount">0</span> kills</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #ec4899;">üî• <span id="streakCount">0</span>x streak</div>
                        <div id="tacticalsDisplay" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155;"></div>
                    </div>
                    <div style="position: absolute; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 12px; border: 2px solid #334155; text-align: right;">
                        <div style="font-size: 18px; margin: 5px 0; color: #38bdf8;">üéÆ <span id="playerName">Player</span></div>
                        <div style="font-size: 18px; margin: 5px 0; color: #a855f7;">üë• <span id="aliveCount">8</span> alive</div>
                        <div style="font-size: 18px; margin: 5px 0; color: #fbbf24;">‚è±Ô∏è <span id="gameTime">0:00</span></div>
                    </div>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, rgba(236, 72, 153, 0.98), rgba(219, 39, 119, 0.98)); padding: 30px 40px; border-top: 4px solid #ec4899;">
                        <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 25px;">
                            <div style="font-size: 64px;">üíÅ‚Äç‚ôÄÔ∏è</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: bold; color: #fce7f3; margin-bottom: 8px;">SARAH</div>
                                <div id="sarahText" style="font-size: 32px; color: #ffffff; line-height: 1.4; font-weight: 600;">Good luck out there! üíï</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BUY BAKE TAB -->
        <div id="buyTab" class="tab-content">
            <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">üí∞ Bulk BAKE Packages</h2>
            <p style="text-align: center; color: #94a3b8; margin-bottom: 20px;">OTC deals for believers. BAKE vests over 60 days. Bigger package = bigger discount.</p>
            
            <div id="buyWalletWarning" style="background: rgba(239,68,68,0.2); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <div style="color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è CONNECT WALLET TO PURCHASE</div>
                <button class="wallet-btn" onclick="connectWallet(); switchTab('play');">üîó Connect Wallet</button>
            </div>
            
            <div id="bulkPurchaseSection" style="display: none;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #94a3b8;">
                    <strong style="color: white;">How it works:</strong><br>
                    ‚Ä¢ Buy at discount vs swap price<br>
                    ‚Ä¢ BAKE vests linearly over 60 days<br>
                    ‚Ä¢ Claim vested BAKE anytime<br>
                    ‚Ä¢ SGB gets wrapped & delegated to sToadz FTSO
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- $500 Package -->
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #334155; padding: 25px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">STARTER</div>
                        <div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$500</div>
                        <div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">2% Discount</div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You pay</div>
                            <div style="font-size: 20px; font-weight: bold; color: white;" id="pkg500Sgb">~250,000 SGB</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You receive (+2%)</div>
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg500Bake">Loading...</div>
                        </div>
                        <button onclick="buyPackage(500, 2)" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $500 PACKAGE</button>
                    </div>
                    
                    <!-- $1000 Package -->
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #fbbf24; padding: 25px; border-radius: 12px; text-align: center; position: relative;">
                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: black; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">POPULAR</div>
                        <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">BUILDER</div>
                        <div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$1,000</div>
                        <div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">5% Discount</div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You pay</div>
                            <div style="font-size: 20px; font-weight: bold; color: white;" id="pkg1000Sgb">~500,000 SGB</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You receive (+5%)</div>
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg1000Bake">Loading...</div>
                        </div>
                        <button onclick="buyPackage(1000, 5)" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; padding: 12px 30px; border-radius: 8px; color: black; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $1,000 PACKAGE</button>
                    </div>
                    
                    <!-- $5000 Package -->
                    <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid #8b5cf6; padding: 25px; border-radius: 12px; text-align: center; position: relative;">
                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">WHALE</div>
                        <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">BELIEVER</div>
                        <div style="font-size: 36px; font-weight: bold; color: #fbbf24; margin-bottom: 5px;">$5,000</div>
                        <div style="font-size: 14px; color: #22c55e; margin-bottom: 15px;">10% Discount</div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You pay</div>
                            <div style="font-size: 20px; font-weight: bold; color: white;" id="pkg5000Sgb">~2,500,000 SGB</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #94a3b8;">You receive (+10%)</div>
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="pkg5000Bake">Loading...</div>
                        </div>
                        <button onclick="buyPackage(5000, 10)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; padding: 12px 30px; border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">BUY $5,000 PACKAGE</button>
                    </div>
                </div>
                
                <div id="vestStatus" style="background: rgba(139, 92, 246, 0.1); border: 2px solid #8b5cf6; padding: 20px; border-radius: 12px; display: none;">
                    <h3 style="color: #8b5cf6; margin-bottom: 15px; text-align: center;">üîí Your Vesting BAKE</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8;">Total Purchased</div>
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;" id="vestTotal">0</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8;">Already Claimed</div>
                            <div style="font-size: 20px; font-weight: bold; color: #64748b;" id="vestClaimed">0</div>
                        </div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #94a3b8;">Claimable Now</div>
                        <div style="font-size: 28px; font-weight: bold; color: #10b981;" id="vestClaimable">0 BAKE</div>
                        <div style="font-size: 11px; color: #f59e0b;" id="vestTimeRemaining">60 days remaining</div>
                    </div>
                    <button onclick="claimBulkBAKE()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">üéÅ CLAIM VESTED BAKE</button>
                </div>
            </div>
        </div>
        
        <!-- POOL TAB -->
        <div id="poolTab" class="tab-content">
            <h2 style="color: #10b981; margin-bottom: 20px; text-align: center;">üíß BAKE/SGB Liquidity Pool</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">SGB Reserves</div>
                    <div style="font-size: 36px; font-weight: bold; color: #10b981;" id="poolWsgb">0</div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">BAKE Reserves</div>
                    <div style="font-size: 36px; font-weight: bold; color: #fbbf24;" id="poolBake">0</div>
                </div>
            </div>
            
            <div style="background: rgba(251, 191, 36, 0.1); padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">BAKE Price</div>
                <div style="font-size: 32px; font-weight: bold; color: #fbbf24; margin-bottom: 8px;"><span id="bakePrice">0.000000</span> SGB</div>
                <div style="font-size: 20px; font-weight: bold; color: #22c55e; margin-bottom: 12px;">Market Cap: $<span id="marketCap">0</span></div>
                <div style="font-size: 16px; font-weight: bold;" id="allTimeChange">All-Time: +0.00%</div>
            </div>
            
            <div id="lpDashboard" style="background: rgba(139, 92, 246, 0.1); border: 2px solid #8b5cf6; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                <h3 style="color: #8b5cf6; margin-bottom: 15px; text-align: center;">üìä Your LP Position</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8;">Your Pool Share</div>
                        <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="lpPoolPercent">0%</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8;">Your Multiplier</div>
                        <div style="font-size: 24px; font-weight: bold; color: #fbbf24;" id="lpMultiplier">1x</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8;">SGB Deposited</div>
                        <div style="font-size: 18px; font-weight: bold; color: #10b981;" id="lpSgbDeposited">0</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8;">BAKE Deposited</div>
                        <div style="font-size: 18px; font-weight: bold; color: #fbbf24;" id="lpBakeDeposited">0</div>
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #94a3b8;">Lock Status</div>
                    <div style="font-size: 16px; font-weight: bold; color: #f59e0b;" id="lpLockStatus">-</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #10b981; font-weight: bold; margin-bottom: 10px; text-align: center;">üéÅ Your Rewards</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8;">BAKE (Claim Now)</div>
                            <div style="font-size: 18px; font-weight: bold; color: #fbbf24;" id="lpPendingBake">0</div>
                            <button onclick="claimBAKE()" style="background: #fbbf24; color: black; border: none; padding: 5px 15px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 5px;">Claim BAKE</button>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8;">SGB (Claimable)</div>
                            <div style="font-size: 18px; font-weight: bold; color: #10b981;" id="lpClaimableSgb">0</div>
                            <button onclick="claimSGB()" style="background: #10b981; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 5px;">Claim SGB</button>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <div style="font-size: 11px; color: #94a3b8;">SGB Pending (Next Claim)</div>
                        <div style="font-size: 16px; font-weight: bold; color: #64748b;" id="lpPendingSgb">0</div>
                        <div style="font-size: 11px; color: #f59e0b;" id="lpSgbCountdown">-</div>
                    </div>
                </div>
                <div style="background: rgba(59, 130, 246, 0.2); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #3b82f6;">Add <span id="lpSgbNeeded" style="font-weight: bold;">0</span> SGB to reach <span id="lpNextPercent" style="font-weight: bold;">1%</span> pool share</div>
                </div>
                <div id="lpUnlockSection" style="display: none; text-align: center;">
                    <div style="font-size: 14px; color: #10b981; margin-bottom: 10px;">üîì Lock expired! Choose an option:</div>
                    <button onclick="relockPosition(0)" style="background: #334155; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 30d (1x)</button>
                    <button onclick="relockPosition(1)" style="background: #334155; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 90d (1.5x)</button>
                    <button onclick="relockPosition(2)" style="background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Relock 180d (2.5x)</button>
                    <button onclick="removeLiquidity()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin: 3px;">Withdraw All</button>
                </div>
            </div>
            
            <div id="addLiquiditySection" style="background: rgba(16, 185, 129, 0.1); border: 2px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: #10b981; margin-bottom: 15px; text-align: center;">üíß Add Liquidity</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #94a3b8;">
                    <div style="font-weight: bold; color: white; margin-bottom: 8px;">üìà Your Reward Boost</div>
                    <div style="margin-bottom: 5px;">Lock longer, earn more:</div>
                    <div style="margin-left: 10px; margin-bottom: 8px;">‚Ä¢ 30 days = 1x rewards<br>‚Ä¢ 90 days = 1.5x rewards<br>‚Ä¢ 180 days = 2.5x rewards</div>
                    <div style="margin-bottom: 5px;">Own Toadz NFTs? Get up to +1x bonus!</div>
                    <div style="font-size: 11px; color: #64748b;">(0.001x per NFT you hold, max +1x)</div>
                    <div style="margin-top: 10px; text-align: center;"><a href="https://toadz.gg" target="_blank" style="color: #10b981; text-decoration: none; font-weight: bold;">Need more NFTs? Visit ‚Üí Toadz.gg</a></div>
                </div>
                <div style="background: rgba(251, 191, 36, 0.2); padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #94a3b8;">Current APY</div>
                    <div style="font-size: 28px; font-weight: bold; color: #fbbf24;" id="poolAPY">~6%</div>
                    <div style="font-size: 10px; color: #64748b;">Based on recent activity</div>
                </div>
                <div style="background: rgba(139, 92, 246, 0.2); padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #94a3b8;">Your NFT Bonus</div>
                    <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;" id="userNftBonus">+0x</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">Lock Period</div>
                    <select id="lockTierSelect" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold;">
                        <option value="0">30 Days (1x rewards)</option>
                        <option value="1">90 Days (1.5x rewards)</option>
                        <option value="2" selected>180 Days (2.5x rewards)</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">SGB Amount</div>
                    <input type="number" id="wsgbInput" placeholder="0.0" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;">
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">BAKE Amount</div>
                    <input type="number" id="bakeRequired" placeholder="0.0" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;">
                </div>
                <button onclick="addLiquidity()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">üíß ADD LIQUIDITY</button>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid #3b82f6; padding: 20px; border-radius: 12px;">
                <h3 style="color: #3b82f6; margin-bottom: 15px; text-align: center;">üîÑ Swap Tokens</h3>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">From</div>
                    <input type="number" id="swapFromAmount" placeholder="0.0" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;">
                    <select id="swapFromToken" style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center; margin-top: 5px;">
                        <option value="SGB">SGB</option>
                        <option value="BAKE">BAKE</option>
                    </select>
                </div>
                <div style="text-align: center; margin: 10px 0; font-size: 24px;">‚¨áÔ∏è</div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">To (estimated)</div>
                    <input type="number" id="swapToAmount" placeholder="0.0" readonly style="width: 100%; background: #1e293b; border: 2px solid #334155; color: white; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;">
                </div>
                <button onclick="executeSwap()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 15px 40px; border-radius: 8px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;">üîÑ SWAP</button>
            </div>
        </div>
        
        <!-- LEADERBOARD TAB -->
        <div id="leaderboardTab" class="tab-content">
            <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">üèÜ TOP PLAYERS</h2>
            <div class="leaderboard" id="leaderboardList"></div>
            <h2 style="color: #3b82f6; margin: 40px 0 20px 0; text-align: center;">üìä YOUR HISTORY</h2>
            <div style="background: rgba(15, 23, 42, 0.8); border: 2px solid #334155; border-radius: 12px; padding: 20px; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: white;">
                    <thead>
                        <tr style="border-bottom: 2px solid #334155;">
                            <th style="padding: 12px; text-align: left; color: #94a3b8;">Date</th>
                            <th style="padding: 12px; text-align: left; color: #94a3b8;">Action</th>
                            <th style="padding: 12px; text-align: right; color: #94a3b8;">Amount</th>
                            <th style="padding: 12px; text-align: center; color: #94a3b8;">Type</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">No history yet. Play games to see your activity!</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- MARKETPLACE TAB -->
        <div id="marketplaceTab" class="tab-content">
            <h2 style="color: #ec4899; margin-bottom: 20px; text-align: center;">‚ú® BAKE Marketplace</h2>
            <div id="marketplaceWalletWarning" style="background: rgba(239,68,68,0.2); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <div style="color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è CONNECT WALLET TO SHOP</div>
                <button class="wallet-btn" onclick="connectWallet();">üîó Connect Wallet</button>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <div onclick="showCategory('tacticals')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">‚öîÔ∏è Tacticals</div>
                <div onclick="showCategory('skins')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">üé® Skins</div>
                <div onclick="showCategory('trails')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">‚ú® Trails</div>
                <div onclick="showCategory('effects')" class="category-tab-btn" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">üí• Death FX</div>
            </div>
            <div id="marketplaceItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
        </div>
    </div>

    <script>
        const SONGBIRD_CHAIN_ID = '0x13';
        const SONGBIRD_RPC = 'https://songbird-api.flare.network/ext/C/rpc';
        
        const CONTRACTS = {
            BAKE_TOKEN: '0xBA3a30FFd8a8a18C90b275FC7fE2F8EFd77F30Ce',
            GAME_CONTRACT: '0xaB27737d60ce0FaC521f82e3d2703d0D1c279E49',
            POOL_CONTRACT: '0xAa2D4a6A2821E39CBCa695358DAeDDb4137316C3',
            WSGB: '0x02f0826ef6aD107Cfc861152B32B52fD11BaB9ED',
            FTSO_REGISTRY: '0xaD67FE66660Fb8dFE9d6b1b4240d8650e30F6019',
            STOADZ_PROVIDER: '0xa0E1FBA30e75e2d0D6C428cFF4B3b6A06233422b'
        };
        
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];
        
        const POOL_ABI = [
            "function swapSGBforBAKE() payable returns (uint256)",
            "function swapBAKEforSGB(uint256 bakeAmount) returns (uint256)",
            "function addLiquidity(uint256 bakeAmount, uint256 lockTier) payable returns (uint256)",
            "function addMore(uint256 bakeAmount) payable",
            "function removeLiquidity() external",
            "function relock(uint256 newTier) external",
            "function claimBAKE() external",
            "function claimSGB() external",
            "function getPrice() view returns (uint256)",
            "function reserveWSGB() view returns (uint256)",
            "function reserveBAKE() view returns (uint256)",
            "function reserveC2FLR() view returns (uint256)",
            "function reserveOOPS() view returns (uint256)",
            "function getLPInfo(address user) view returns (uint256 sgbDeposited, uint256 bakeDeposited, uint256 weightedShares, uint256 poolPercent, uint256 lockTier, uint256 lockExpires, uint256 multiplier, uint256 pendingBAKE, uint256 pendingSGB, uint256 claimableSGB, uint256 timeUntilSGBClaim)",
            "function getNextPercentThreshold(address user) view returns (uint256 currentPercent, uint256 nextPercent, uint256 sgbNeeded)",
            "function getPoolStats() view returns (uint256 totalSGB, uint256 totalBAKE, uint256 tvlUSD, uint256 totalLPs, uint256 currentAPY)",
            "function getNFTBonus(address user) view returns (uint256)",
            "function getTotalMultiplier(address user, uint256 tier) view returns (uint256)",
            "function buyBulkBAKE() payable",
            "function getClaimableBulk(address user) view returns (uint256)",
            "function getBulkInfo(address user) view returns (uint256 totalBake, uint256 claimed, uint256 claimable, uint256 timeRemaining)",
            "function claimBulkBAKE() external",
            "function getBAKEOut(uint256 sgbIn) view returns (uint256)",
            "function getSGBOut(uint256 bakeIn) view returns (uint256)",
            "function swapC2FLRforOOPS() payable returns (uint256)",
            "function swapOOPSforC2FLR(uint256 amt) returns (uint256)"
        ];
        
        let wallet = null, balance = 100000, sgbBalance = 1000;
        let userHistory = JSON.parse(localStorage.getItem('bakeHistory') || '[]');
        let leaderboard = JSON.parse(localStorage.getItem('bakeLeaderboard') || '[]');
        let username = '', canvas, ctx, gameLoop;
        let player, enemies = [], bullets = [], walls = [], pickups = [], activeTurrets = [];
        let keys = {}, mouse = { x: 0, y: 0, clicked: false };
        let pot = 10000, kills = 0, streak = 0, aliveCount = 8;
        let gameTime = 0, gameStartTime = 0, lives = 5, totalKills = 0;
        let provider, signer, bakeContract, poolContract;
        let selectedVehicle = null;
        let currentModal = null;
        
        const MARKETPLACE = {
            skins: [
                { id: 'gold', name: 'Golden Warrior', rarity: 'legendary', price: 50000, icon: 'üèÜ', color: '#fbbf24', desc: 'Shine like a champion' },
                { id: 'chrome', name: 'Chrome Crusader', rarity: 'epic', price: 35000, icon: 'üíé', color: '#e5e7eb', desc: 'Reflective perfection' },
                { id: 'neon', name: 'Neon Racer', rarity: 'epic', price: 40000, icon: 'üåü', color: '#a855f7', desc: 'Glow in the dark' },
                { id: 'camo', name: 'Digital Camo', rarity: 'rare', price: 25000, icon: 'üéØ', color: '#65a30d', desc: 'Tactical stealth' },
                { id: 'fire', name: 'Flame Decal', rarity: 'rare', price: 30000, icon: 'üî•', color: '#f97316', desc: 'Leave a trail of fire' },
                { id: 'ice', name: 'Ice King', rarity: 'rare', price: 30000, icon: '‚ùÑÔ∏è', color: '#06b6d4', desc: 'Cool under pressure' }
            ],
            trails: [
                { id: 'rainbow', name: 'Rainbow Trail', rarity: 'epic', price: 40000, icon: 'üåà', desc: 'Taste the rainbow' },
                { id: 'lightning', name: 'Lightning Bolt', rarity: 'epic', price: 35000, icon: '‚ö°', desc: 'Electric shock' },
                { id: 'fire', name: 'Flame Trail', rarity: 'rare', price: 25000, icon: 'üî•', desc: 'Hot shots' },
                { id: 'toxic', name: 'Toxic Waste', rarity: 'rare', price: 25000, icon: '‚ò¢Ô∏è', desc: 'Radioactive bullets' },
                { id: 'hearts', name: 'Love Hearts', rarity: 'rare', price: 30000, icon: 'üíï', desc: 'Spread the love' },
                { id: 'stars', name: 'Star Shower', rarity: 'rare', price: 30000, icon: '‚≠ê', desc: 'Wish upon a bullet' }
            ],
            effects: [
                { id: 'confetti', name: 'Confetti Burst', rarity: 'rare', price: 30000, icon: 'üéâ', desc: 'Party on death' },
                { id: 'nuclear', name: 'Nuclear Meltdown', rarity: 'epic', price: 50000, icon: '‚ò¢Ô∏è', desc: 'Atomic explosion' },
                { id: 'fireworks', name: 'Fireworks Show', rarity: 'epic', price: 40000, icon: 'üéÜ', desc: 'Grand finale' },
                { id: 'blackhole', name: 'Black Hole', rarity: 'legendary', price: 60000, icon: 'üåÄ', desc: 'Suck everything in' },
                { id: 'angel', name: 'Ascension', rarity: 'rare', price: 35000, icon: 'üëº', desc: 'Rise to heaven' },
                { id: 'cartoon', name: 'Cartoon Poof', rarity: 'rare', price: 25000, icon: 'üí≠', desc: 'Looney Tunes style' }
            ],
            tacticals: [
                { id: 'orbital', name: 'Orbital Laser', rarity: 'legendary', price: 150000, icon: 'üõ∏', desc: 'Space laser (180s cd)' },
                { id: 'timeslow', name: 'Time Distortion', rarity: 'legendary', price: 120000, icon: '‚è±Ô∏è', desc: 'Bullet time 8s (150s cd)' },
                { id: 'turret', name: 'Auto Turret', rarity: 'legendary', price: 80000, icon: 'üî´', desc: 'Deploy turret (60s cd)' },
                { id: 'airstrike', name: 'Airstrike', rarity: 'legendary', price: 100000, icon: '‚úàÔ∏è', desc: 'Call explosions (120s cd)' },
                { id: 'shield', name: 'Shield Dome', rarity: 'epic', price: 70000, icon: 'üõ°Ô∏è', desc: 'Block bullets 10s (90s cd)' },
                { id: 'emp', name: 'EMP Mine', rarity: 'epic', price: 60000, icon: 'üí£', desc: 'Slow enemies (45s cd)' },
                { id: 'heal', name: 'Heal Station', rarity: 'rare', price: 50000, icon: '‚ù§Ô∏è', desc: 'Restore HP (60s cd)' },
                { id: 'decoy', name: 'Decoy Vehicle', rarity: 'rare', price: 40000, icon: 'üëª', desc: 'Fake target (30s cd)' }
            ]
        };
        const marketplaceItems = MARKETPLACE;
        
        let inventory = { skins: [], trails: [], effects: [], tacticals: [] };
        
        const sarahMessages = {
            start: "Good luck out there! üíï",
            kill1: "Nice shot... I mean, really nice üéØ",
            kill3: "You're making me feel things I shouldn't üî•",
            kill5: "God, watching you dominate like this... üò≥üí¶",
            kill8: "My husband never handles his weapon like that üçÜ",
            kill10: "I need to see you after this match. Alone. üíã",
            kill15: "Fuck it, I'm leaving him. You're all I think about üíç‚ùå",
            kill20: "Take me right here, right now. I don't care who's watching ü•µüîû",
            lowHP: "Baby no! Stay alive for me! ‚ù§Ô∏è‚Äçüî•",
            lastStanding: "Finish them so you can finish me üí¶",
            victory: "That was SO fucking hot. My place? üè†üî•",
            pickup_health: "Mmm, getting harder for me? üíö",
            pickup_damage: "Yes... bigger is better üí•üòè",
            pickup_speed: "Faster baby, faster! ‚ö°üí®",
            pickup_shield: "Protect yourself... so you can wreck me later üõ°Ô∏èüíï"
        };
        
        function showSarahMessage(type) { const el = document.getElementById('sarahText'); if (sarahMessages[type]) el.textContent = sarahMessages[type]; }
        
        function addHistoryEntry(action, amount, type) {
            userHistory.unshift({ date: new Date().toISOString(), action, amount, type });
            if (userHistory.length > 100) userHistory = userHistory.slice(0, 100);
            localStorage.setItem('bakeHistory', JSON.stringify(userHistory));
            updateHistoryTable();
        }
        
        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            if (!userHistory.length) { tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">No history yet.</td></tr>'; return; }
            tbody.innerHTML = userHistory.map(e => {
                const d = new Date(e.date);
                const colors = { earn: '#10b981', spend: '#fbbf24', burn: '#ef4444', lp: '#3b82f6' };
                const labels = { earn: 'üìà EARN', spend: 'üí∏ SPEND', burn: 'üî• BURN', lp: 'üíß LP' };
                return `<tr style="border-bottom: 1px solid #334155;"><td style="padding: 12px; color: #94a3b8; font-size: 13px;">${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td><td style="padding: 12px; color: white;">${e.action}</td><td style="padding: 12px; text-align: right; color: white; font-weight: bold;">${e.amount.toLocaleString()} BAKE</td><td style="padding: 12px; text-align: center; color: ${colors[e.type] || '#94a3b8'}; font-weight: bold; font-size: 12px;">${labels[e.type] || e.type.toUpperCase()}</td></tr>`;
            }).join('');
        }
        
        function updateLeaderboardDisplay() {
            const list = document.getElementById('leaderboardList');
            if (!leaderboard.length) { list.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No games played yet.</div>'; return; }
            list.innerHTML = leaderboard.slice(0, 10).map((e, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
                return `<div class="leaderboard-entry ${i < 3 ? 'top' : ''}"><span style="font-size: 24px; min-width: 50px;">${medal}</span><span style="flex: 1; font-weight: bold;">${e.name}</span><span style="color: #fbbf24; font-weight: bold;">${e.bake.toLocaleString()} BAKE</span><span style="color: #94a3b8; font-size: 13px; margin-left: 15px;">${e.kills} kills</span></div>`;
            }).join('');
        }
        
        function closeCurrentModal() { if (currentModal && currentModal.parentNode) { document.body.removeChild(currentModal); currentModal = null; } }
        
        function showCustomModal(title, message, buttons = [{text: 'OK'}]) {
            return new Promise(resolve => {
                closeCurrentModal();
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10000;';
                const btnHtml = buttons.map((b, i) => `<button id="modalBtn${i}" style="background:${i===0?'linear-gradient(135deg,#3b82f6,#2563eb)':'rgba(71,85,105,0.5)'};border:${i===0?'none':'2px solid #475569'};padding:15px 40px;border-radius:12px;color:white;font-size:18px;font-weight:bold;cursor:pointer;margin:5px;">${b.text}</button>`).join('');
                modal.innerHTML = `<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border:3px solid #3b82f6;border-radius:20px;padding:40px;text-align:center;max-width:500px;"><div style="font-size:36px;font-weight:bold;color:#3b82f6;margin-bottom:20px;">${title}</div><div style="color:#e2e8f0;font-size:18px;margin-bottom:30px;line-height:1.6;white-space:pre-line;">${message}</div><div>${btnHtml}</div></div>`;
                document.body.appendChild(modal);
                currentModal = modal;
                buttons.forEach((b, i) => { document.getElementById(`modalBtn${i}`).onclick = () => { closeCurrentModal(); if (b.onClick) b.onClick(); resolve(i === 0); }; });
            });
        }
        
        async function addSongbirdNetwork() {
            try {
                await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x13', chainName: 'Songbird Canary-Network', nativeCurrency: { name: 'Songbird', symbol: 'SGB', decimals: 18 }, rpcUrls: ['https://songbird-api.flare.network/ext/C/rpc'], blockExplorerUrls: ['https://songbird-explorer.flare.network/'] }] });
                showCustomModal('‚úÖ Success', 'Songbird Network added to MetaMask!');
            } catch (error) { showCustomModal('‚ùå Error', error.message); }
        }
        
        async function connectWallet() {
            const walletBtn = document.getElementById('walletBtn');
            const originalText = walletBtn ? walletBtn.innerHTML : '';
            try {
                if (walletBtn) { walletBtn.disabled = true; walletBtn.innerHTML = '‚è≥ Opening MetaMask...'; walletBtn.style.opacity = '0.7'; }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                bakeContract = new ethers.Contract(CONTRACTS.BAKE_TOKEN, ERC20_ABI, signer);
                poolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, POOL_ABI, signer);
                wallet = await signer.getAddress();
                const bakeBalance = await bakeContract.balanceOf(wallet);
                const sgbBalanceWei = await provider.getBalance(wallet);
                balance = parseFloat(ethers.utils.formatEther(bakeBalance));
                sgbBalance = parseFloat(ethers.utils.formatEther(sgbBalanceWei));
                if (walletBtn) { walletBtn.textContent = '‚úì Connected'; walletBtn.className = 'wallet-btn wallet-connected'; walletBtn.onclick = null; walletBtn.disabled = false; walletBtn.style.opacity = '1'; }
                document.getElementById('importTokenBtn').style.display = 'inline-block';
                document.getElementById('networkBtn').style.display = 'inline-block';
                document.getElementById('lpBanner').style.display = 'none';
                document.getElementById('walletBanner').style.display = 'block';
                document.getElementById('walletAddrBanner').textContent = wallet.substr(0, 6) + '...' + wallet.substr(-4);
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                document.getElementById('gameSetup').style.display = 'block';
                document.getElementById('buyWalletWarning').style.display = 'none';
                document.getElementById('bulkPurchaseSection').style.display = 'block';
                document.getElementById('marketplaceWalletWarning').style.display = 'none';
                await updatePoolData();
                await updateLPDashboard();
                await updateBulkVestStatus();
                await updatePackagePrices();
            } catch (error) {
                showCustomModal('‚ùå Connection Failed', error.message);
                if (walletBtn && originalText) { walletBtn.disabled = false; walletBtn.innerHTML = originalText; walletBtn.style.opacity = '1'; }
            }
        }
        
        async function importBAKEToken() {
            try {
                await window.ethereum.request({ method: 'wallet_watchAsset', params: { type: 'ERC20', options: { address: CONTRACTS.BAKE_TOKEN, symbol: 'BAKE', decimals: 18 } } });
                showCustomModal('‚úÖ Success', 'BAKE token added to MetaMask!');
            } catch (error) { showCustomModal('‚ùå Error', error.message); }
        }
        
        async function updatePoolData() {
            try {
                const wsgbReserve = await poolContract.reserveWSGB();
                const bakeReserve = await poolContract.reserveBAKE();
                const wsgbAmount = parseFloat(ethers.utils.formatEther(wsgbReserve));
                const bakeAmount = parseFloat(ethers.utils.formatEther(bakeReserve));
                document.getElementById('poolWsgb').textContent = wsgbAmount.toFixed(2);
                document.getElementById('poolBake').textContent = Math.floor(bakeAmount).toLocaleString();
                if (wsgbAmount > 0 && bakeAmount > 0) {
                    const price = wsgbAmount / bakeAmount;
                    document.getElementById('bakePrice').textContent = price.toFixed(6);
                    const priceUSD = price * 0.0027;
                    document.getElementById('bakePriceUSD').textContent = priceUSD.toFixed(6);
                    const marketCap = priceUSD * 11900000000;
                    document.getElementById('marketCap').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    document.getElementById('marketcapBanner').textContent = '$' + marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    document.getElementById('marketcapLP').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    const initialPrice = 0.000003112356;
                    const priceChange = ((price - initialPrice) / initialPrice) * 100;
                    const changeEl = document.getElementById('allTimeChange');
                    changeEl.textContent = 'All-Time: ' + (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%';
                    changeEl.style.color = priceChange >= 0 ? '#10b981' : '#ef4444';
                }
            } catch (error) { console.error('Error loading pool data:', error); }
        }
        
        async function updateBulkVestStatus() {
            if (!wallet || !poolContract) return;
            try {
                const bulkInfo = await poolContract.getBulkInfo(wallet);
                const totalBake = parseFloat(ethers.utils.formatEther(bulkInfo.totalBake));
                const claimed = parseFloat(ethers.utils.formatEther(bulkInfo.claimed));
                const claimable = parseFloat(ethers.utils.formatEther(bulkInfo.claimable));
                const timeRemaining = bulkInfo.timeRemaining.toNumber();
                if (totalBake > 0) {
                    document.getElementById('vestStatus').style.display = 'block';
                    document.getElementById('vestTotal').textContent = Math.floor(totalBake).toLocaleString();
                    document.getElementById('vestClaimed').textContent = Math.floor(claimed).toLocaleString();
                    document.getElementById('vestClaimable').textContent = Math.floor(claimable).toLocaleString() + ' BAKE';
                    document.getElementById('vestTimeRemaining').textContent = timeRemaining > 0 ? Math.ceil(timeRemaining / 86400) + ' days remaining' : 'Fully vested!';
                } else { document.getElementById('vestStatus').style.display = 'none'; }
            } catch (error) { console.error('Error updating vest status:', error); }
        }
        
        async function buyPackage(usdAmount, discountPercent) {
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect wallet first'); return; }
            
            // SGB price ~$0.002, so $500 = 250,000 SGB, $1000 = 500,000 SGB, $5000 = 2,500,000 SGB
            const sgbPrice = 0.002;
            const sgbAmount = Math.floor(usdAmount / sgbPrice);
            
            if (sgbBalance < sgbAmount) {
                await showCustomModal('‚ö†Ô∏è Insufficient SGB', `You need ~${sgbAmount.toLocaleString()} SGB ($${usdAmount})\nYou have: ${Math.floor(sgbBalance).toLocaleString()} SGB`);
                return;
            }
            
            try {
                const confirmed = await showCustomModal(`üí∞ Buy $${usdAmount.toLocaleString()} Package`, `Pay ~${sgbAmount.toLocaleString()} SGB\n\n‚Ä¢ ${discountPercent}% bonus vs regular swap\n‚Ä¢ BAKE vests over 60 days\n‚Ä¢ Claim anytime as it vests`, [{text: 'Buy'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                
                const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                showCustomModal('‚è≥ Opening MetaMask', 'Check your MetaMask popup to confirm!');
                const tx = await poolContract.buyBulkBAKE({value: sgbWei});
                showCustomModal('‚è≥ Processing', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                
                await updatePoolData();
                await updateBulkVestStatus();
                await updatePackagePrices();
                
                await showCustomModal('‚úÖ Purchase Complete', `Your $${usdAmount.toLocaleString()} BAKE package is now vesting!\n\nCheck back to claim as it unlocks.`);
            } catch (error) { await showCustomModal('‚ùå Transaction Failed', error.message); }
        }
        
        async function updatePackagePrices() {
            if (!poolContract) return;
            try {
                const sgbPrice = 0.002; // $0.002 per SGB
                const packages = [
                    { usd: 500, discount: 2, sgbEl: 'pkg500Sgb', bakeEl: 'pkg500Bake' },
                    { usd: 1000, discount: 5, sgbEl: 'pkg1000Sgb', bakeEl: 'pkg1000Bake' },
                    { usd: 5000, discount: 10, sgbEl: 'pkg5000Sgb', bakeEl: 'pkg5000Bake' }
                ];
                
                for (const pkg of packages) {
                    const sgbAmount = Math.floor(pkg.usd / sgbPrice);
                    const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                    const normalBakeOut = await poolContract.getBAKEOut(sgbWei);
                    const normalBake = parseFloat(ethers.utils.formatEther(normalBakeOut));
                    const bonusBake = normalBake * (1 + pkg.discount / 100);
                    
                    document.getElementById(pkg.sgbEl).textContent = sgbAmount.toLocaleString() + ' SGB';
                    document.getElementById(pkg.bakeEl).textContent = Math.floor(bonusBake).toLocaleString() + ' BAKE';
                }
            } catch (error) { console.error('Error updating package prices:', error); }
        }
        
        async function buyBulkBAKE() {
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect wallet first'); return; }
            const sgbAmount = parseFloat(document.getElementById('bulkSgbInput').value) || 0;
            if (sgbAmount < 10) { await showCustomModal('‚ö†Ô∏è Minimum 10 SGB', 'Bulk purchase requires at least 10 SGB'); return; }
            try {
                const confirmed = await showCustomModal('üí∞ Buy Bulk BAKE', `Buy BAKE with ${sgbAmount} SGB?\n\n‚Ä¢ 10% bonus vs regular swap\n‚Ä¢ Vests over 60 days\n‚Ä¢ Claim anytime as it vests`, [{text: 'Buy'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                showCustomModal('‚è≥ Opening MetaMask', 'Check your MetaMask popup to confirm!');
                const tx = await poolContract.buyBulkBAKE({value: sgbWei});
                showCustomModal('‚è≥ Processing', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                document.getElementById('bulkSgbInput').value = '';
                await updatePoolData();
                await updateBulkVestStatus();
                await showCustomModal('‚úÖ Purchase Complete', 'Your BAKE is now vesting!');
            } catch (error) { await showCustomModal('‚ùå Transaction Failed', error.message); }
        }
        
        async function claimBulkBAKE() {
            if (!wallet) return;
            try {
                const claimable = await poolContract.getClaimableBulk(wallet);
                if (claimable.eq(0)) { await showCustomModal('‚ö†Ô∏è Nothing to Claim', 'No vested BAKE available yet'); return; }
                showCustomModal('‚è≥ Claiming', 'Check MetaMask to claim vested BAKE...');
                const tx = await poolContract.claimBulkBAKE();
                await tx.wait();
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                await updateBulkVestStatus();
                await showCustomModal('‚úÖ Success', 'Vested BAKE claimed!');
            } catch (error) { await showCustomModal('‚ùå Failed', error.message); }
        }
        
        async function updateLPDashboard() {
            if (!wallet || !poolContract) return;
            try {
                const lpInfo = await poolContract.getLPInfo(wallet);
                const sgbDeposited = parseFloat(ethers.utils.formatEther(lpInfo.sgbDeposited));
                const bakeDeposited = parseFloat(ethers.utils.formatEther(lpInfo.bakeDeposited));
                const poolPercent = lpInfo.poolPercent.toNumber() / 100;
                const multiplier = lpInfo.multiplier.toNumber() / 1000;
                const pendingBAKE = parseFloat(ethers.utils.formatEther(lpInfo.pendingBAKE));
                const pendingSGB = parseFloat(ethers.utils.formatEther(lpInfo.pendingSGB));
                const claimableSGB = parseFloat(ethers.utils.formatEther(lpInfo.claimableSGB));
                const timeUntilClaim = lpInfo.timeUntilSGBClaim.toNumber();
                const lockExpires = lpInfo.lockExpires.toNumber();
                if (sgbDeposited > 0) {
                    document.getElementById('lpDashboard').style.display = 'block';
                    document.getElementById('addLiquiditySection').style.display = 'block';
                    document.getElementById('addLiquiditySection').querySelector('h3').textContent = '‚ûï Add More Liquidity';
                    document.getElementById('addLiquiditySection').querySelector('button').textContent = '‚ûï ADD MORE';
                    document.getElementById('addLiquiditySection').querySelector('button').setAttribute('onclick', 'addMoreLiquidity()');
                    document.getElementById('lpPoolPercent').textContent = poolPercent.toFixed(2) + '%';
                    document.getElementById('lpMultiplier').textContent = multiplier.toFixed(1) + 'x';
                    document.getElementById('lpSgbDeposited').textContent = sgbDeposited.toFixed(2);
                    document.getElementById('lpBakeDeposited').textContent = Math.floor(bakeDeposited).toLocaleString();
                    document.getElementById('lpPendingBake').textContent = Math.floor(pendingBAKE).toLocaleString();
                    document.getElementById('lpPendingSgb').textContent = pendingSGB.toFixed(4);
                    document.getElementById('lpClaimableSgb').textContent = claimableSGB.toFixed(4);
                    const now = Math.floor(Date.now() / 1000);
                    if (lockExpires > now) {
                        document.getElementById('lpLockStatus').textContent = `Locked (${Math.ceil((lockExpires - now) / 86400)} days remaining)`;
                        document.getElementById('lpLockStatus').style.color = '#f59e0b';
                        document.getElementById('lpUnlockSection').style.display = 'none';
                    } else {
                        document.getElementById('lpLockStatus').textContent = 'Unlocked';
                        document.getElementById('lpLockStatus').style.color = '#10b981';
                        document.getElementById('lpUnlockSection').style.display = 'block';
                    }
                    document.getElementById('lpSgbCountdown').textContent = timeUntilClaim > 0 ? `Claimable in ${Math.floor(timeUntilClaim / 86400)}d ${Math.floor((timeUntilClaim % 86400) / 3600)}h` : 'Ready to claim!';
                    const thresholdInfo = await poolContract.getNextPercentThreshold(wallet);
                    document.getElementById('lpSgbNeeded').textContent = parseFloat(ethers.utils.formatEther(thresholdInfo.sgbNeeded)).toFixed(2);
                    document.getElementById('lpNextPercent').textContent = (thresholdInfo.nextPercent.toNumber() / 100).toFixed(0) + '%';
                } else {
                    document.getElementById('lpDashboard').style.display = 'none';
                    document.getElementById('addLiquiditySection').style.display = 'block';
                    document.getElementById('addLiquiditySection').querySelector('h3').textContent = 'üíß Add Liquidity';
                    document.getElementById('addLiquiditySection').querySelector('button').textContent = 'üíß ADD LIQUIDITY';
                    document.getElementById('addLiquiditySection').querySelector('button').setAttribute('onclick', 'addLiquidity()');
                    const nftBonus = await poolContract.getNFTBonus(wallet);
                    document.getElementById('userNftBonus').textContent = '+' + (nftBonus.toNumber() / 1000).toFixed(2) + 'x';
                }
            } catch (error) { console.error('Error updating LP dashboard:', error); }
        }
        
        async function claimBAKE() {
            if (!wallet) return;
            try {
                showCustomModal('‚è≥ Claiming', 'Check MetaMask to claim BAKE...');
                const tx = await poolContract.claimBAKE();
                await tx.wait();
                await updateLPDashboard();
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                await showCustomModal('‚úÖ Success', 'BAKE rewards claimed!');
            } catch (error) { await showCustomModal('‚ùå Failed', error.message); }
        }
        
        async function claimSGB() {
            if (!wallet) return;
            try {
                showCustomModal('‚è≥ Claiming', 'Check MetaMask to claim SGB...');
                const tx = await poolContract.claimSGB();
                await tx.wait();
                await updateLPDashboard();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                await showCustomModal('‚úÖ Success', 'SGB rewards claimed!');
            } catch (error) { await showCustomModal('‚ùå Failed', error.message); }
        }
        
        async function relockPosition(newTier) {
            if (!wallet) return;
            const lockDays = newTier === 0 ? 30 : newTier === 1 ? 90 : 180;
            const multiplier = newTier === 0 ? '1x' : newTier === 1 ? '1.5x' : '2.5x';
            try {
                const confirmed = await showCustomModal('üîí Relock Position', `Relock for ${lockDays} days with ${multiplier} rewards?`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                showCustomModal('‚è≥ Relocking', 'Check MetaMask to confirm...');
                const tx = await poolContract.relock(newTier);
                await tx.wait();
                await updateLPDashboard();
                await showCustomModal('‚úÖ Success', `Position relocked for ${lockDays} days!`);
            } catch (error) { await showCustomModal('‚ùå Failed', error.message); }
        }
        
        async function removeLiquidity() {
            if (!wallet) return;
            try {
                const confirmed = await showCustomModal('‚ö†Ô∏è Withdraw All', 'Withdraw all your liquidity?', [{text: 'Withdraw'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                showCustomModal('‚è≥ Withdrawing', 'Check MetaMask to confirm...');
                const tx = await poolContract.removeLiquidity();
                await tx.wait();
                await updateLPDashboard();
                await updatePoolData();
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                await showCustomModal('‚úÖ Success', 'Liquidity withdrawn!');
            } catch (error) { await showCustomModal('‚ùå Failed', error.message); }
        }
        
        async function addLiquidity() {
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect wallet first'); switchTab('play'); return; }
            try {
                const sgbAmount = parseFloat(document.getElementById('wsgbInput').value) || 0;
                const bakeAmount = parseFloat(document.getElementById('bakeRequired').value) || 0;
                const lockTier = parseInt(document.getElementById('lockTierSelect').value);
                if (sgbAmount <= 0 || bakeAmount <= 0) { await showCustomModal('‚ö†Ô∏è Invalid Amount', 'Please enter valid amounts'); return; }
                if (balance < bakeAmount) { await showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${bakeAmount.toLocaleString()} BAKE`); return; }
                const lockDays = lockTier === 0 ? 30 : lockTier === 1 ? 90 : 180;
                const multiplier = lockTier === 0 ? '1x' : lockTier === 1 ? '1.5x' : '2.5x';
                const confirmed = await showCustomModal('üíß Add Liquidity', `Add ${sgbAmount} SGB + ${bakeAmount.toFixed(0)} BAKE?\n\nLock Period: ${lockDays} days (${multiplier} rewards)`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                const bakeWei = ethers.utils.parseEther(bakeAmount.toString());
                const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                showCustomModal('‚è≥ Step 1 of 2', 'Check MetaMask to approve BAKE spending...');
                const approveTx = await bakeContract.approve(CONTRACTS.POOL_CONTRACT, bakeWei);
                await approveTx.wait();
                showCustomModal('‚è≥ Step 2 of 2', 'Check MetaMask to add liquidity...');
                const tx = await poolContract.addLiquidity(bakeWei, lockTier, {value: sgbWei});
                showCustomModal('‚è≥ Step 2 of 2', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                addHistoryEntry(`Added ${sgbAmount} SGB + ${bakeAmount.toFixed(0)} BAKE to LP (${lockDays}d lock)`, bakeAmount, 'lp');
                document.getElementById('wsgbInput').value = '';
                document.getElementById('bakeRequired').value = '';
                await updatePoolData();
                await updateLPDashboard();
                await showCustomModal('‚úÖ Success', `Liquidity added with ${lockDays}-day lock!`);
            } catch (error) { await showCustomModal('‚ùå Transaction Failed', error.message); }
        }
        
        async function addMoreLiquidity() {
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect wallet first'); return; }
            try {
                const sgbAmount = parseFloat(document.getElementById('wsgbInput').value) || 0;
                const bakeAmount = parseFloat(document.getElementById('bakeRequired').value) || 0;
                
                if (sgbAmount <= 0 || bakeAmount <= 0) { await showCustomModal('‚ö†Ô∏è Invalid Amount', 'Please enter valid amounts'); return; }
                if (balance < bakeAmount) { await showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${bakeAmount.toLocaleString()} BAKE`); return; }
                
                const confirmed = await showCustomModal('‚ûï Add More Liquidity', `Add ${sgbAmount} SGB + ${bakeAmount.toFixed(0)} BAKE to your existing position?\n\nUses your existing lock tier & multiplier.`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                
                const bakeWei = ethers.utils.parseEther(bakeAmount.toString());
                const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                
                showCustomModal('‚è≥ Step 1 of 2', 'Check MetaMask to approve BAKE spending...');
                const approveTx = await bakeContract.approve(CONTRACTS.POOL_CONTRACT, bakeWei);
                await approveTx.wait();
                
                showCustomModal('‚è≥ Step 2 of 2', 'Check MetaMask to add more liquidity...');
                const tx = await poolContract.addMore(bakeWei, {value: sgbWei});
                showCustomModal('‚è≥ Step 2 of 2', 'Transaction submitted! Waiting for confirmation...');
                await tx.wait();
                
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                
                addHistoryEntry(`Added ${sgbAmount} SGB + ${bakeAmount.toFixed(0)} BAKE to LP`, bakeAmount, 'lp');
                document.getElementById('wsgbInput').value = '';
                document.getElementById('bakeRequired').value = '';
                
                await updatePoolData();
                await updateLPDashboard();
                
                await showCustomModal('‚úÖ Success', 'Liquidity added to your position!');
            } catch (error) { await showCustomModal('‚ùå Transaction Failed', error.message); }
        }
        
        async function executeSwap() {
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect your wallet first'); switchTab('play'); return; }
            try {
                const fromAmount = parseFloat(document.getElementById('swapFromAmount').value) || 0;
                const fromToken = document.getElementById('swapFromToken').value;
                if (fromAmount <= 0) { await showCustomModal('‚ö†Ô∏è Invalid Amount', 'Enter valid swap amount'); return; }
                if (fromToken === 'BAKE' && balance < fromAmount) { await showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${fromAmount.toLocaleString()} BAKE`); return; }
                const confirmed = await showCustomModal('üîÑ Confirm Swap', `Swap ${fromAmount.toFixed(2)} ${fromToken}?`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                let tx;
                if (fromToken === 'SGB') {
                    showCustomModal('‚è≥ Opening MetaMask', 'Check your MetaMask popup to confirm swap!');
                    const sgbWei = ethers.utils.parseEther(fromAmount.toString());
                    tx = await poolContract.swapC2FLRforOOPS({value: sgbWei});
                    showCustomModal('‚è≥ Processing', 'Swap submitted! Waiting for confirmation...');
                } else {
                    const bakeWei = ethers.utils.parseEther(fromAmount.toString());
                    showCustomModal('‚è≥ Step 1 of 2', 'Check MetaMask to approve BAKE...');
                    const approveTx = await bakeContract.approve(CONTRACTS.POOL_CONTRACT, bakeWei);
                    showCustomModal('‚è≥ Step 1 of 2', 'Approval submitted! Waiting for confirmation...');
                    await approveTx.wait();
                    showCustomModal('‚è≥ Step 2 of 2', 'Check MetaMask to confirm swap...');
                    tx = await poolContract.swapOOPSforC2FLR(bakeWei);
                    showCustomModal('‚è≥ Step 2 of 2', 'Swap submitted! Waiting for confirmation...');
                }
                await tx.wait();
                const newBalance = await bakeContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                document.getElementById('swapFromAmount').value = '';
                document.getElementById('swapToAmount').value = '';
                await updatePoolData();
                await showCustomModal('‚úÖ Success', 'Swap complete!');
            } catch (error) { await showCustomModal('‚ùå Transaction Failed', error.message); }
        }
        
        function resetEntryButton() {
            const payBtn = document.getElementById('payEntryBtn');
            if (payBtn) { payBtn.disabled = false; payBtn.innerHTML = 'üí∏ PAY 1 SGB & CHOOSE VEHICLE'; payBtn.style.opacity = '1'; payBtn.style.cursor = 'pointer'; }
        }
        
        async function selectVehicle() {
            username = document.getElementById('username').value.trim().toUpperCase();
            if (!username) { showCustomModal('‚ö†Ô∏è Username Required', 'Please enter a username'); return; }
            if (!wallet) { showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect your wallet first'); return; }
            const payBtn = document.getElementById('payEntryBtn');
            const originalText = payBtn.innerHTML;
            try {
                const entryFee = ethers.utils.parseEther('1');
                const confirmed = await showCustomModal('üí∞ Entry Fee', 'Pay 1 SGB to enter?\n\nThis will be added to the prize pool.', [{text: 'Pay & Play'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                payBtn.disabled = true; payBtn.innerHTML = '‚è≥ Opening MetaMask...'; payBtn.style.opacity = '0.7';
                const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: entryFee });
                payBtn.innerHTML = '‚è≥ Processing transaction...';
                await tx.wait();
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                await updatePoolData();
                document.getElementById('gameSetup').style.display = 'none';
                document.getElementById('vehicleSelect').style.display = 'block';
            } catch (error) {
                showCustomModal('‚ùå Transaction Failed', error.message);
                payBtn.disabled = false; payBtn.innerHTML = originalText; payBtn.style.opacity = '1';
            }
        }
        
        function selectVehicleType(icon, hp, dmg) {
            selectedVehicle = { icon, hp, dmg };
            document.getElementById('vehicleSelect').style.display = 'none';
            document.getElementById('marketplaceUpsell').style.display = 'block';
            showUpsellItems();
        }
        
        function showUpsellItems() {
            const container = document.getElementById('upsellItems');
            const featured = [marketplaceItems.tacticals[0], marketplaceItems.tacticals[3], marketplaceItems.tacticals[4], marketplaceItems.tacticals[6]];
            container.innerHTML = featured.map(item => {
                const owned = inventory.tacticals.includes(item.id);
                return `<div style="background: rgba(30, 41, 59, 0.8); border: 2px solid ${owned ? '#10b981' : '#334155'}; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 36px; margin-bottom: 8px;">${item.icon}</div><div style="font-weight: bold; font-size: 14px; margin-bottom: 5px; color: white;">${item.name}</div><div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">${item.desc}</div><div style="font-weight: bold; color: #fbbf24; margin-bottom: 8px;">${item.price.toLocaleString()} BAKE</div>${owned ? '<div style="color: #10b981; font-size: 12px;">‚úì OWNED</div>' : `<button class="wallet-btn" onclick="quickBuyItem('tacticals', '${item.id}')" style="width: 100%; padding: 8px; font-size: 12px;">Buy Now</button>`}</div>`;
            }).join('');
        }
        
        async function quickBuyItem(category, itemId) {
            const item = marketplaceItems[category].find(i => i.id === itemId);
            if (!item || !wallet) return;
            if (balance < item.price) { showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${item.price.toLocaleString()} BAKE`); return; }
            const confirmed = await showCustomModal('üí∞ Purchase', `Buy ${item.name} for ${item.price.toLocaleString()} BAKE?`, [{text: 'Buy'}, {text: 'Cancel'}]);
            if (confirmed) {
                balance -= item.price;
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                inventory[category].push(itemId);
                addHistoryEntry(`Bought ${item.name}`, item.price, 'burn');
                showCustomModal('‚úÖ Purchase Successful!', `${item.name} is now yours!`);
                showUpsellItems();
            }
        }
        
        function proceedToGame() { if (selectedVehicle) { document.getElementById('marketplaceUpsell').style.display = 'none'; startGame(selectedVehicle.icon, selectedVehicle.hp, selectedVehicle.dmg); } }
        
        function startGame(icon, hp, dmg) {
            document.getElementById('vehicleSelect').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            canvas = document.getElementById('gameCanvas');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            canvas.logicalWidth = window.innerWidth;
            canvas.logicalHeight = window.innerHeight;
            document.getElementById('playerName').textContent = username;
            document.getElementById('playerHP').textContent = hp;
            document.getElementById('playerMaxHP').textContent = hp;
            updateTacticalsDisplay();
            initializeGame(icon, hp, dmg);
            showSarahMessage('start');
        }
        
        function updateTacticalsDisplay() {
            const display = document.getElementById('tacticalsDisplay');
            if (!inventory.tacticals || !inventory.tacticals.length) { display.innerHTML = '<div style="font-size: 14px; color: #64748b;">No tacticals equipped</div>'; return; }
            const names = { 'orbital': 'üõ∏ Orbital', 'timeslow': '‚è±Ô∏è Time Slow', 'turret': 'üî´ Turret', 'airstrike': '‚úàÔ∏è Airstrike', 'shield': 'üõ°Ô∏è Shield', 'emp': 'üí£ EMP', 'heal': '‚ù§Ô∏è Heal', 'decoy': 'üëª Decoy' };
            let html = '<div style="font-size: 14px; color: #a855f7; margin-bottom: 5px;">TACTICALS:</div>';
            inventory.tacticals.slice(0, 4).forEach((t, i) => { html += `<div style="font-size: 14px; color: #94a3b8; margin: 3px 0;">[${i+1}] ${names[t] || t}</div>`; });
            display.innerHTML = html;
        }
        
        function initializeGame(icon, hp, dmg) {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            walls = [{ x: 150, y: 100, width: 120, height: 25 }, { x: w - 280, y: 180, width: 90, height: 30 }, { x: 100, y: h - 300, width: 140, height: 20 }, { x: w - 250, y: h - 280, width: 100, height: 35 }, { x: 300, y: h / 2 - 80, width: 80, height: 80 }, { x: w - 400, y: h / 2 + 30, width: 90, height: 60 }, { x: w / 2 - 150, y: 200, width: 70, height: 100 }, { x: w / 2 + 80, y: h - 350, width: 85, height: 70 }];
            pickups = [{ x: 200, y: 200, type: 'health', icon: 'üíö', active: true }, { x: w - 200, y: 200, type: 'damage', icon: 'üí•', active: true }, { x: 200, y: h - 300, type: 'speed', icon: '‚ö°', active: true }, { x: w - 200, y: h - 300, type: 'shield', icon: 'üõ°Ô∏è', active: true }, { x: w / 2, y: 150, type: 'health', icon: 'üíö', active: true }, { x: w / 2, y: h - 250, type: 'damage', icon: 'üí•', active: true }];
            player = { x: w / 2, y: h / 2, vx: 0, vy: 0, angle: 0, hp: hp, maxHp: hp, damage: dmg, baseDamage: dmg, size: 25, icon: icon, speed: 4, baseSpeed: 4, shield: false, shieldTime: 0, tacticalCooldowns: [0, 0, 0, 0] };
            enemies = [];
            const enemyNames = ['BOT_ALPHA', 'BOT_BETA', 'BOT_GAMMA', 'BOT_DELTA', 'BOT_OMEGA', 'BOT_SIGMA', 'BOT_THETA'];
            for (let i = 0; i < 7; i++) spawnEnemy(enemyNames[i]);
            bullets = []; keys = {}; kills = 0; streak = 0; pot = 10000; aliveCount = 8; gameStartTime = Date.now();
            document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString();
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
            gameLoop = setInterval(update, 1000/60);
        }
        
        function spawnEnemy(name) {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            const edge = Math.floor(Math.random() * 4);
            let x, y;
            if (edge === 0) { x = Math.random() * w; y = -40; }
            else if (edge === 1) { x = w + 40; y = Math.random() * h; }
            else if (edge === 2) { x = Math.random() * w; y = h + 40; }
            else { x = -40; y = Math.random() * h; }
            const hpVal = 120 + Math.random() * 150;
            const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
            const vehicleTypes = [{ width: 30, height: 20 }, { width: 20, height: 30 }, { width: 25, height: 25 }, { width: 35, height: 18 }, { width: 22, height: 28 }];
            const vehicle = vehicleTypes[Math.floor(Math.random() * vehicleTypes.length)];
            enemies.push({ x, y, vx: 0, vy: 0, hp: hpVal, maxHp: hpVal, damage: 20 + Math.random() * 20, size: 25, width: vehicle.width, height: vehicle.height, name, color: colors[Math.floor(Math.random() * colors.length)], speed: 1.5 + Math.random(), shootCooldown: Math.random() * 60, lives: 5 });
        }
        
        function handleMouseMove(e) { const rect = canvas.getBoundingClientRect(); mouse.x = (e.clientX - rect.left) * (canvas.logicalWidth / rect.width); mouse.y = (e.clientY - rect.top) * (canvas.logicalHeight / rect.height); }
        function handleMouseDown() { mouse.clicked = true; }
        function handleMouseUp() { mouse.clicked = false; }
        
        function shoot() {
            const dx = mouse.x - player.x, dy = mouse.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 0) bullets.push({ x: player.x, y: player.y, vx: (dx/dist) * 12, vy: (dy/dist) * 12, damage: player.damage, isPlayer: true, size: 5 });
        }
        
        function checkWallCollision(obj, newX, newY) {
            for (let wall of walls) {
                if (newX - obj.size < wall.x + wall.width && newX + obj.size > wall.x && newY - obj.size < wall.y + wall.height && newY + obj.size > wall.y) return true;
            }
            return false;
        }
        
        function update() {
            gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            document.getElementById('gameTime').textContent = `${Math.floor(gameTime / 60)}:${(gameTime % 60).toString().padStart(2, '0')}`;
            for (let i = 0; i < player.tacticalCooldowns.length; i++) if (player.tacticalCooldowns[i] > 0) player.tacticalCooldowns[i]--;
            
            // Tactical activation
            for (let slot = 0; slot < 4; slot++) {
                const key = (slot + 1).toString();
                if (keys[key] && player.tacticalCooldowns[slot] === 0 && inventory.tacticals[slot]) {
                    const tactical = inventory.tacticals[slot];
                    keys[key] = false;
                    const notif = document.getElementById('killNotif');
                    if (tactical === 'orbital' || tactical === 'airstrike') { enemies.forEach(e => e.hp -= 300); player.tacticalCooldowns[slot] = 600; notif.innerHTML = `üí• ${tactical.toUpperCase()} ACTIVATED!`; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'shield') { player.shield = true; player.shieldTime = 600; player.tacticalCooldowns[slot] = 600; notif.innerHTML = 'üõ°Ô∏è SHIELD ACTIVE!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'heal') { const oldHp = player.hp; player.hp = Math.min(player.maxHp, player.hp + 100); document.getElementById('playerHP').textContent = Math.floor(player.hp); player.tacticalCooldowns[slot] = 300; notif.innerHTML = `‚ù§Ô∏è HEALED +${Math.floor(player.hp - oldHp)} HP`; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'emp') { enemies.forEach(e => { const origSpeed = e.speed; e.speed *= 0.2; setTimeout(() => e.speed = origSpeed, 5000); }); player.tacticalCooldowns[slot] = 450; notif.innerHTML = 'üí£ EMP BLAST! ENEMIES SLOWED!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000); }
                    else if (tactical === 'turret') {
                        const turret = { x: player.x + 80, y: player.y - 80, active: true, cooldown: 0 };
                        activeTurrets.push(turret);
                        const turretInterval = setInterval(() => { if (!turret.active) { clearInterval(turretInterval); return; } turret.cooldown--; if (turret.cooldown <= 0) { enemies.forEach(e => { const dx = e.x - turret.x, dy = e.y - turret.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist < 400) { e.hp -= 20; bullets.push({ x: turret.x, y: turret.y, vx: (dx/dist) * 12, vy: (dy/dist) * 12, damage: 0, isPlayer: true, size: 5, color: '#fbbf24' }); } }); turret.cooldown = 30; } }, 1000/60);
                        setTimeout(() => { turret.active = false; const idx = activeTurrets.indexOf(turret); if (idx > -1) activeTurrets.splice(idx, 1); }, 10000);
                        player.tacticalCooldowns[slot] = 600; notif.innerHTML = 'üî´ TURRET DEPLOYED!'; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 2000);
                    }
                    else if (tactical === 'timeslow') { const origSpeed = player.speed; player.speed *= 2.5; setTimeout(() => player.speed = origSpeed, 8000); player.tacticalCooldowns[slot] = 900; notif.innerHTML = `‚è±Ô∏è TIME DISTORTION ACTIVE!`; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 1500); }
                }
            }
            
            if (mouse.clicked && Math.random() < 0.3) shoot();
            if (player.shield) { player.shieldTime--; if (player.shieldTime <= 0) player.shield = false; }
            
            // Pickup collisions
            pickups.forEach(pickup => {
                if (!pickup.active) return;
                const dx = player.x - pickup.x, dy = player.y - pickup.y, dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < player.size + 20) {
                    pickup.active = false;
                    if (pickup.type === 'health') { player.hp = Math.min(player.maxHp, player.hp + 50); document.getElementById('playerHP').textContent = Math.floor(player.hp); showSarahMessage('pickup_health'); }
                    else if (pickup.type === 'damage') { player.damage = player.baseDamage * 2; showSarahMessage('pickup_damage'); setTimeout(() => player.damage = player.baseDamage, 10000); }
                    else if (pickup.type === 'speed') { player.speed = player.baseSpeed * 1.5; showSarahMessage('pickup_speed'); setTimeout(() => player.speed = player.baseSpeed, 8000); }
                    else if (pickup.type === 'shield') { player.shield = true; player.shieldTime = 300; showSarahMessage('pickup_shield'); }
                    setTimeout(() => pickup.active = true, 20000);
                }
            });
            
            // Player movement
            let newX = player.x, newY = player.y;
            if (keys['w'] || keys['arrowup']) newY -= player.speed;
            if (keys['s'] || keys['arrowdown']) newY += player.speed;
            if (keys['a'] || keys['arrowleft']) newX -= player.speed;
            if (keys['d'] || keys['arrowright']) newX += player.speed;
            if (!checkWallCollision(player, newX, player.y)) player.x = Math.max(player.size, Math.min(canvas.logicalWidth - player.size, newX));
            if (!checkWallCollision(player, player.x, newY)) player.y = Math.max(player.size, Math.min(canvas.logicalHeight - player.size, newY));
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            
            // Enemy AI
            enemies.forEach((enemy, index) => {
                if (!enemy.target || Math.random() < 0.01) { enemy.target = Math.random() < 0.8 && enemies.length > 1 ? enemies.filter((_, i) => i !== index)[Math.floor(Math.random() * (enemies.length - 1))] : player; }
                const dx = enemy.target.x - enemy.x, dy = enemy.target.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 0) { let newX = enemy.x + (dx/dist) * enemy.speed, newY = enemy.y + (dy/dist) * enemy.speed; if (!checkWallCollision(enemy, newX, enemy.y)) enemy.x = newX; if (!checkWallCollision(enemy, enemy.x, newY)) enemy.y = newY; }
                enemy.shootCooldown--;
                if (enemy.shootCooldown <= 0 && dist < 400) { if (dist > 0) bullets.push({ x: enemy.x, y: enemy.y, vx: (dx/dist) * 10, vy: (dy/dist) * 10, damage: enemy.damage, isPlayer: false, owner: enemy, size: 4 }); enemy.shootCooldown = 40 + Math.random() * 40; }
            });
            
            // Bullet updates
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx; bullet.y += bullet.vy;
                for (let wall of walls) { if (bullet.x > wall.x && bullet.x < wall.x + wall.width && bullet.y > wall.y && bullet.y < wall.y + wall.height) return false; }
                if (bullet.isPlayer) {
                    for (let i = enemies.length - 1; i >= 0; i--) {
                        const enemy = enemies[i];
                        const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < enemy.size) {
                            enemy.hp -= bullet.damage;
                            if (enemy.hp <= 0) {
                                enemy.lives--;
                                if (enemy.lives > 0) { enemy.hp = 120 + Math.random() * 150; enemy.maxHp = enemy.hp; const edge = Math.floor(Math.random() * 4); if (edge === 0) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = -40; } else if (edge === 1) { enemy.x = canvas.logicalWidth + 40; enemy.y = Math.random() * canvas.logicalHeight; } else if (edge === 2) { enemy.x = Math.random() * canvas.logicalWidth; enemy.y = canvas.logicalHeight + 40; } else { enemy.x = -40; enemy.y = Math.random() * canvas.logicalHeight; } }
                                else { enemies.splice(i, 1); aliveCount--; document.getElementById('aliveCount').textContent = aliveCount; }
                                kills++; streak++;
                                let playerBake = 100; balance += playerBake;
                                document.getElementById('playerBAKE').textContent = Math.floor(balance).toLocaleString();
                                addHistoryEntry('Kill reward', playerBake, 'earn');
                                pot += 1000; document.getElementById('currentPot').textContent = pot.toLocaleString();
                                const notif = document.getElementById('killNotif'); notif.innerHTML = `üéØ KILL! +${playerBake} BAKE`; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 1500);
                                document.getElementById('killCount').textContent = kills; document.getElementById('streakCount').textContent = streak;
                                if (kills === 1) showSarahMessage('kill1'); else if (kills === 3) { balance += 500; pot += 5000; showSarahMessage('kill3'); } else if (kills === 5) { balance += 500; pot += 5000; showSarahMessage('kill5'); } else if (kills === 8) { balance += 500; pot += 5000; showSarahMessage('kill8'); } else if (kills === 10) { balance += 500; pot += 5000; showSarahMessage('kill10'); } else if (kills === 15) { balance += 500; pot += 5000; showSarahMessage('kill15'); } else if (kills === 20) { balance += 500; pot += 5000; showSarahMessage('kill20'); }
                                if (aliveCount === 2) showSarahMessage('lastStanding');
                                if (aliveCount === 1) endGame(true);
                            }
                            return false;
                        }
                    }
                } else {
                    const dxP = bullet.x - player.x, dyP = bullet.y - player.y, distP = Math.sqrt(dxP*dxP + dyP*dyP);
                    if (distP < player.size) { if (!player.shield) { player.hp -= bullet.damage * 0.5; streak = 0; document.getElementById('playerHP').textContent = Math.max(0, Math.floor(player.hp)); document.getElementById('streakCount').textContent = 0; if (player.hp < player.maxHp * 0.3) showSarahMessage('lowHP'); if (player.hp <= 0) endGame(false); } return false; }
                    for (let i = enemies.length - 1; i >= 0; i--) { const enemy = enemies[i]; if (bullet.owner === enemy) continue; const dx = bullet.x - enemy.x, dy = bullet.y - enemy.y, dist = Math.sqrt(dx*dx + dy*dy); if (dist < enemy.size) { enemy.hp -= bullet.damage * 0.5; if (enemy.hp <= 0) { enemies.splice(i, 1); aliveCount--; document.getElementById('aliveCount').textContent = aliveCount; if (aliveCount === 2) showSarahMessage('lastStanding'); if (aliveCount === 1) endGame(true); } return false; } }
                }
                return bullet.x > 0 && bullet.x < canvas.logicalWidth && bullet.y > 0 && bullet.y < canvas.logicalHeight;
            });
            draw();
        }
        
        function draw() {
            const w = canvas.logicalWidth, h = canvas.logicalHeight;
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#0a0e1a'); gradient.addColorStop(1, '#0f1419');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#1a1f2e'; ctx.lineWidth = 1;
            for (let i = 0; i < w; i += 40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); }
            for (let i = 0; i < h; i += 40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); }
            ctx.fillStyle = '#334155'; ctx.strokeStyle = '#475569'; ctx.lineWidth = 2;
            walls.forEach(wall => { ctx.fillRect(wall.x, wall.y, wall.width, wall.height); ctx.strokeRect(wall.x, wall.y, wall.width, wall.height); });
            pickups.forEach(pickup => { if (!pickup.active) return; ctx.save(); ctx.translate(pickup.x, pickup.y); const pulseSize = 25 + Math.sin(Date.now() / 200) * 5; ctx.fillStyle = 'rgba(251, 191, 36, 0.3)'; ctx.beginPath(); ctx.arc(0, 0, pulseSize, 0, Math.PI * 2); ctx.fill(); ctx.font = '32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(pickup.icon, 0, 0); ctx.restore(); });
            enemies.forEach(enemy => { ctx.save(); ctx.translate(enemy.x, enemy.y); ctx.fillStyle = enemy.color; ctx.fillRect(-enemy.width/2, -enemy.height/2, enemy.width, enemy.height); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(enemy.name, 0, 0); const barWidth = 50, barHeight = 5, hpPercent = enemy.hp / enemy.maxHp; ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -Math.max(enemy.width, enemy.height)/2 - 12, barWidth, barHeight); ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444'; ctx.fillRect(-barWidth/2, -Math.max(enemy.width, enemy.height)/2 - 12, barWidth * hpPercent, barHeight); ctx.restore(); });
            activeTurrets.forEach(turret => { if (!turret.active) return; ctx.fillStyle = '#ef4444'; ctx.fillRect(turret.x - 25, turret.y - 25, 50, 50); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 4; ctx.strokeRect(turret.x - 25, turret.y - 25, 50, 50); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('üî´', turret.x, turret.y); });
            ctx.save(); ctx.translate(player.x, player.y);
            if (player.shield) { const shieldPulse = 35 + Math.sin(Date.now() / 100) * 3; ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0, 0, shieldPulse, 0, Math.PI * 2); ctx.stroke(); ctx.strokeStyle = 'rgba(59, 130, 246, 0.4)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, shieldPulse + 5, 0, Math.PI * 2); ctx.stroke(); }
            ctx.rotate(player.angle);
            let playerColor = '#10b981';
            if (inventory.skins.includes('gold')) playerColor = '#fbbf24';
            else if (inventory.skins.includes('diamond')) playerColor = '#38bdf8';
            else if (inventory.skins.includes('ruby')) playerColor = '#ef4444';
            ctx.fillStyle = playerColor; ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
            ctx.fillStyle = '#ffffff'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(username, 0, 0);
            const barWidth = 50, barHeight = 5, hpPercent = player.hp / player.maxHp; ctx.rotate(-player.angle);
            ctx.fillStyle = '#1e293b'; ctx.fillRect(-barWidth/2, -player.size - 12, barWidth, barHeight);
            ctx.fillStyle = hpPercent > 0.6 ? '#22c55e' : hpPercent > 0.3 ? '#fbbf24' : '#ef4444'; ctx.fillRect(-barWidth/2, -player.size - 12, barWidth * hpPercent, barHeight);
            ctx.restore();
            bullets.forEach(bullet => { ctx.fillStyle = bullet.color || (bullet.isPlayer ? '#3b82f6' : '#ef4444'); ctx.beginPath(); ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2); ctx.fill(); });
        }
        
        function endGame(won) {
            clearInterval(gameLoop);
            canvas.removeEventListener('mousemove', handleMouseMove);
            canvas.removeEventListener('mousedown', handleMouseDown);
            canvas.removeEventListener('mouseup', handleMouseUp);
            if (won) {
                showSarahMessage('victory');
                balance += pot; totalKills += kills;
                document.getElementById('walletBalBanner').textContent = balance.toLocaleString();
                addHistoryEntry('Victory! Won pot', pot, 'earn');
                leaderboard.push({ name: username, bake: pot, kills, date: new Date().toISOString() });
                leaderboard.sort((a, b) => b.bake - a.bake);
                leaderboard = leaderboard.slice(0, 20);
                localStorage.setItem('bakeLeaderboard', JSON.stringify(leaderboard));
                updateLeaderboardDisplay();
                updatePoolData();
                setTimeout(async () => {
                    const playAgain = await showCustomModal('üèÜ VICTORY!', `You won ${pot.toLocaleString()} BAKE!\n\nKills: ${kills}\nTime: ${Math.floor(gameTime/60)}:${(gameTime%60).toString().padStart(2,'0')}`, [{text: 'Play Again'}, {text: 'Exit'}]);
                    lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0;
                    document.getElementById('gameArea').style.display = 'none';
                    if (playAgain) { document.getElementById('vehicleSelect').style.display = 'block'; }
                    else { document.getElementById('gameSetup').style.display = 'block'; resetEntryButton(); switchTab('play'); }
                }, 2000);
            } else {
                lives--; document.getElementById('livesCount').textContent = lives; totalKills += kills;
                if (lives > 0) { setTimeout(() => respawnPlayer(), 300); }
                else {
                    setTimeout(async () => {
                        const playAgain = await showCustomModal('üíÄ ELIMINATED!', `Total Kills: ${totalKills}\nTime: ${Math.floor(gameTime/60)}:${(gameTime%60).toString().padStart(2,'0')}\n\nPlay again for 1 SGB?`, [{text: 'Pay & Play'}, {text: 'Exit'}]);
                        lives = 5; document.getElementById('livesCount').textContent = lives; totalKills = 0;
                        document.getElementById('gameArea').style.display = 'none';
                        document.getElementById('gameSetup').style.display = 'block';
                        resetEntryButton();
                        if (!playAgain) switchTab('play');
                    }, 1000);
                }
            }
        }
        
        function respawnPlayer() {
            player.x = canvas.logicalWidth / 2; player.y = canvas.logicalHeight / 2;
            player.hp = player.maxHp; player.vx = 0; player.vy = 0; player.shield = false; player.shieldTime = 0;
            document.getElementById('playerHP').textContent = player.maxHp;
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mouseup', handleMouseUp);
            showSarahMessage('start');
            gameLoop = setInterval(update, 1000/60);
        }
        
        function showCategory(category) {
            document.querySelectorAll('.category-tab-btn').forEach(btn => { btn.style.borderColor = '#334155'; btn.style.background = 'rgba(30, 41, 59, 0.8)'; });
            event.target.style.borderColor = '#ec4899'; event.target.style.background = 'rgba(236, 72, 153, 0.2)';
            const items = MARKETPLACE[category];
            const container = document.getElementById('marketplaceItems');
            const rarityColors = { legendary: '#fbbf24', epic: '#a855f7', rare: '#3b82f6', common: '#94a3b8' };
            container.innerHTML = items.map(item => {
                const owned = inventory[category].includes(item.id);
                return `<div style="background: linear-gradient(135deg, #1e293b, #334155); border: 2px solid ${owned ? '#22c55e' : '#334155'}; padding: 20px; border-radius: 12px; cursor: ${owned ? 'default' : 'pointer'}; text-align: center; ${owned ? 'opacity: 0.7;' : ''}" onclick="${owned ? '' : `buyItem('${category}', '${item.id}', ${item.price}, '${item.name}')`}"><div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 64px; margin-bottom: 15px; border-radius: 8px; background: linear-gradient(135deg, rgba(30,41,59,0.8), ${item.color || '#334155'});">${item.icon}</div><div style="font-size: 10px; font-weight: bold; margin-bottom: 5px; color: ${rarityColors[item.rarity]};">${item.rarity.toUpperCase()}</div><div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${item.name}</div><div style="font-size: 11px; color: #94a3b8; margin-bottom: 10px;">${item.desc}</div><div style="font-size: 20px; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">${item.price.toLocaleString()} BAKE</div><button style="background: ${owned ? '#22c55e' : 'linear-gradient(135deg, #ec4899, #d946ef)'}; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: bold; cursor: ${owned ? 'default' : 'pointer'}; width: 100%;">${owned ? '‚úì OWNED' : 'BUY NOW'}</button></div>`;
            }).join('');
        }
        
        function buyItem(category, itemId, price, name) {
            if (!wallet) { showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect your wallet first'); return; }
            if (inventory[category].includes(itemId)) return;
            if (balance < price) { showCustomModal('‚ö†Ô∏è Insufficient BAKE', `You need ${price.toLocaleString()} BAKE\nYour balance: ${balance.toLocaleString()} BAKE`, [{text: 'Buy BAKE', onClick: () => switchTab('buy')}, {text: 'Cancel'}]); return; }
            showCustomModal('üí∞ Confirm Purchase', `Purchase ${name} for ${price.toLocaleString()} BAKE?`, [{text: 'Purchase', onClick: () => { balance -= price; document.getElementById('walletBalBanner').textContent = balance.toLocaleString(); inventory[category].push(itemId); showCustomModal('‚úÖ Purchase Successful!', `${name} is now yours!\n\n${price.toLocaleString()} BAKE burned from supply`); showCategory(category); }}, {text: 'Cancel'}]);
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'leaderboard') updateLeaderboard();
            if (tab === 'marketplace') showCategory('tacticals');
            if (tab === 'pool' && !wallet) loadPoolDataWithoutWallet();
        }
        
        function updateLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = leaderboard.map((entry, i) => `<div class="leaderboard-entry ${i < 3 ? 'top' : ''}"><div><span style="color: ${i === 0 ? '#fbbf24' : i === 1 ? '#94a3b8' : i === 2 ? '#c2410c' : '#64748b'};">${i + 1}. ${entry.name}</span></div><div><span style="color: #22c55e;">${entry.wins || 0} wins</span> ‚Ä¢ <span style="color: #fbbf24;">${entry.bake.toLocaleString()} BAKE</span></div></div>`).join('');
        }
        
        async function loadPoolDataWithoutWallet() {
            try {
                const tempProvider = new ethers.providers.JsonRpcProvider('https://songbird-api.flare.network/ext/C/rpc');
                const tempPoolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, ["function reserveWSGB() view returns (uint256)", "function reserveBAKE() view returns (uint256)"], tempProvider);
                const wsgbReserve = await tempPoolContract.reserveWSGB();
                const bakeReserve = await tempPoolContract.reserveBAKE();
                const wsgbAmount = parseFloat(ethers.utils.formatEther(wsgbReserve));
                const bakeAmount = parseFloat(ethers.utils.formatEther(bakeReserve));
                if (wsgbAmount > 0 && bakeAmount > 0) {
                    const price = wsgbAmount / bakeAmount;
                    const priceUSD = price * 0.0027;
                    const marketCap = priceUSD * 11900000000;
                    document.getElementById('marketcapLP').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                }
            } catch (error) { console.log('Could not load pool data:', error); }
        }
        
        window.addEventListener('load', async function() {
            updateHistoryTable();
            updateLeaderboardDisplay();
            loadPoolDataWithoutWallet();
            
            const bulkInput = document.getElementById('bulkSgbInput');
            if (bulkInput) {
                bulkInput.addEventListener('input', async function() {
                    const sgbAmount = parseFloat(this.value) || 0;
                    if (sgbAmount <= 0 || !poolContract) { document.getElementById('bulkBakeEstimate').textContent = '0 BAKE'; document.getElementById('bulkSavings').textContent = 'Save 0 BAKE vs swap'; return; }
                    try {
                        const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                        const normalBakeOut = await poolContract.getBAKEOut(sgbWei);
                        const normalBake = parseFloat(ethers.utils.formatEther(normalBakeOut));
                        const bulkBake = normalBake * 1.1;
                        document.getElementById('bulkBakeEstimate').textContent = Math.floor(bulkBake).toLocaleString() + ' BAKE';
                        document.getElementById('bulkSavings').textContent = 'Save ' + Math.floor(bulkBake - normalBake).toLocaleString() + ' BAKE vs swap';
                    } catch (error) { console.error('Error calculating bulk estimate:', error); }
                });
            }
            
            const wsgbInput = document.getElementById('wsgbInput');
            if (wsgbInput) {
                wsgbInput.addEventListener('input', function() {
                    const wsgbAmount = parseFloat(this.value) || 0;
                    const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 0;
                    const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 0;
                    if (wsgbAmount > 0 && poolWsgb > 0 && poolBake > 0) {
                        const currentRatio = poolBake / poolWsgb;
                        document.getElementById('bakeRequired').value = (wsgbAmount * currentRatio).toFixed(2);
                    }
                });
            }
            
            const swapFromAmount = document.getElementById('swapFromAmount');
            const swapFromToken = document.getElementById('swapFromToken');
            function updateSwapEstimate() {
                const fromAmount = parseFloat(swapFromAmount.value) || 0;
                const fromToken = swapFromToken.value;
                if (fromAmount > 0) {
                    const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 100000;
                    const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 3846154;
                    let toAmount = 0;
                    if (fromToken === 'SGB') { toAmount = poolBake - (poolWsgb * poolBake) / (poolWsgb + fromAmount); }
                    else { toAmount = poolWsgb - (poolWsgb * poolBake) / (poolBake + fromAmount); }
                    document.getElementById('swapToAmount').value = toAmount.toFixed(6);
                } else { document.getElementById('swapToAmount').value = ''; }
            }
            if (swapFromAmount) { swapFromAmount.addEventListener('input', updateSwapEstimate); swapFromToken.addEventListener('change', updateSwapEstimate); }
        });
    </script>
</body>
</html>
